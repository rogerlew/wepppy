{
	auto_https off
}

# add backend rule: http-request set-header X-Forwarded-Proto https if { ssl_fc }

http://:8080 {
    encode gzip

    handle_path /health* {
        respond "OK"
    }

    @plain_http not header X-Forwarded-Proto https
    redir @plain_http https://{host}{uri} permanent

    handle_path /weppcloud-microservices/status* {
        reverse_proxy status:9002
    }

    handle_path /weppcloud-microservices/preflight* {
        reverse_proxy preflight:9001
    }

    handle_path /webservices/metquery* {
        reverse_proxy metquery:8004
    }

    handle_path /webservices/wmesque2* {
        reverse_proxy wmesque2:8030 {
            transport http {
                read_timeout 3m
            }
        }
    }

    handle_path /webservices/wmesque* {
        reverse_proxy wmesque:8003 {
            transport http {
                read_timeout 3m
            }
        }
    }

    handle_path /query-engine* {
        reverse_proxy query-engine:8041 {
            transport http {
                read_timeout 3m
            }
        }
    }

    handle_path /weppcloudr* {
        reverse_proxy weppcloudr:8050 {
            header_up X-Forwarded-Prefix /weppcloudr
            header_up X-Forwarded-Proto {scheme}
            header_up Host {host}
        }
    }

    handle_path /weppcloud/static/* {
        root * /srv/weppcloud/static
        file_server
    }

    handle_path /browse* {
        reverse_proxy browse:9009 {
            transport http {
                read_timeout 3m
            }
        }
    }

    handle /dtale* {
        reverse_proxy dtale:9010 {
            transport http {
                read_timeout 5m
            }
        }
    }

    handle /weppcloud/dtale* {
        uri strip_prefix /weppcloud
        reverse_proxy dtale:9010 {
            header_up X-Forwarded-Prefix /weppcloud/dtale
            header_up X-Forwarded-Proto {scheme}
            header_up Host {host}
            transport http {
                read_timeout 5m
            }
        }
    }

    @elevationquery path_regexp elevationquery ^/weppcloud/runs/[^/]+/[^/]+/elevationquery/?$
    handle @elevationquery {
        reverse_proxy elevationquery:8002 {
            transport http {
                read_timeout 3m
            }
        }
    }

    @browse_proxy path_regexp browse_proxy ^/weppcloud/runs/[^/]+/[^/]+/(?:browse(?:/.*)?|dtale(?:/.*)?|download(?:/.*)?|aria2c\.spec|gdalinfo/.*)$
    handle @browse_proxy {
        reverse_proxy browse:9009 {
            transport http {
                read_timeout 3m
            }
        }
    }

    handle /rq-dashboard* {
        reverse_proxy rq-dashboard:9181 {
            header_up X-Forwarded-Prefix /rq-dashboard
            header_up X-Forwarded-Proto {scheme}
            header_up Host {host}
        }
    }

    @root path /
    redir @root /weppcloud

    handle_path /weppcloud* {
        reverse_proxy weppcloud:8000 {
            header_up X-Forwarded-Prefix /weppcloud
            header_up X-Forwarded-Proto {scheme}
            header_up Host {host}
        }
    }
}

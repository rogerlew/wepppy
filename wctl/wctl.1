.\" Manual for wctl helper script
.TH WCTL 1 "2024-10-16" "wepppy" "User Commands"
.SH NAME
wctl \- control helper for the WEPPcloud Docker Compose stacks
.SH SYNOPSIS
.B wctl
[docker compose arguments...]
.br
.B wctl build-static-assets
[options]
.br
.B wctl flask-db-upgrade
[alembic arguments...]
.br
.B sudo\ wctl restore-docker-data-permissions
.br
.B wctl man
[man arguments...]
.br
.B wctl update-stub-requirements
[options]
.SH DESCRIPTION
.PP
The
.B wctl
command is a thin wrapper around
.BR docker\ compose (1)
that pins the compose file and environment file used by the WEPPcloud development and production stacks.
.PP
When invoked with standard arguments,
.B wctl
passes them through to
.BR docker\ compose ,
automatically loading environment variables from
.IR docker/.env .
This ensures all services share the same configuration without requiring repeated
.B --env-file
and
.B -f
flags.
.PP
Several helper commands are available and are listed below.
.SH COMMANDS
.TP
.B wctl build-static-assets
Runs the frontend build script at
.IR wepppy/weppcloud/static-src/build-static-assets.sh .
The script automatically adds
.B --prod
when the wctl installation targets the production compose file.
.TP
.B wctl flask-db-upgrade
Runs
.I flask\ --app\ wepppy.weppcloud.app\ db\ upgrade
inside the running
.I weppcloud
service container. Any additional arguments are passed through to Flask-Migrate, allowing subcommands such as
.B --tag
or
.B --sql
to be used.
.TP
.B sudo\ wctl restore-docker-data-permissions
Fixes ownership and permissions inside the
.IR .docker-data /
tree: Postgres data and backups are set to UID/GID 999, Redis data to UID/GID 999, and the WEPPcloud runtime directories to the UID/GID configured in
.IR docker/.env
(default 33:993). Use this after an accidental
.B chown
on the bind mounts.
.TP
.B wctl man
Displays this manual page. The command prefers an installed manual entry
.RB ( man\ wctl )
but falls back to the in-repo copy if necessary. Any additional arguments are forwarded to
.BR man (1).
.TP
.B wctl update-stub-requirements
Runs the helper script in
.IR tools/update_stub_requirements.py
to analyze mypy diagnostics and refresh
.IR docker/requirements-stubs-uv.txt .
Any options provided after the command (for example
.BR --no-verify )
are passed directly to the script.
.TP
.B wctl run-pytest
Runs
.B pytest
inside the
.I weppcloud
container with the correct environment (defaults to
.BR "pytest tests" ).
Additional arguments are forwarded to pytest.
.TP
.B wctl run-stubtest
Executes
.B stubtest
inside the container from
.IR /tmp ,
setting
.B PYTHONPATH=/workdir/wepppy
and
.B MYPY_CACHE_DIR=/tmp/mypy_cache
so cache files are writable. Pass one or more module names (defaults to
.BR wepppy.nodb.core ).
.TP
.B wctl run-npm
Runs
.B npm
on the host with
.BR "--prefix wepppy/weppcloud/static-src" .
Common invocations include
.BR "wctl run-npm install"
and
.BR "wctl run-npm test" .
This helper ensures frontend tooling executes from the correct project directory without extra typing.
.TP
.B wctl run-stubgen
Regenerates the local stub tree via
.BR "python tools/sync_stubs.py" .
.SH ENVIRONMENT
.TP
.B WEPPPY_ENV_FILE
Path to the sanitized environment file generated by
.BR wctl .
Normally this is managed automatically and points to a temporary file.
.TP
.B UID , GID
Numeric IDs stored in
.IR docker/.env .
They control the runtime user and group for the Docker containers and are reused by
.B restore-docker-data-permissions
when fixing ownership.
.SH FILES
.TP
.I docker/.env
Primary configuration file read by
.BR wctl .
Values are sanitized (dollar signs doubled) before being passed to Docker Compose.
.TP
.I docker/docker-compose.dev.yml
.TP
.I docker/docker-compose.prod.yml
Compose files selected during installation.
.TP
.I wepppy/weppcloud/static-src/build-static-assets.sh
Frontend asset build script used by
.BR build-static-assets .
.TP
.I .docker-data/
Host directories bind-mounted into the containers for persistent data.
.SH EXAMPLES
.TP
.B wctl up --build
Start or rebuild the WEPPcloud development stack.
.TP
.B sudo\ wctl restore-docker-data-permissions
Repair permissions for all persistent data directories.
.TP
.B wctl flask-db-upgrade
Apply pending Alembic migrations inside the running application container.
.TP
.B wctl man --no-pager
Read this manual without invoking the
.B man
pager.
.SH SEE ALSO
.BR docker\ compose (1),
.BR man (1)

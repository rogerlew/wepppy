.\" Manual for wctl helper script
.TH WCTL 1 "2025-10-27" "wepppy" "User Commands"
.SH NAME
wctl \- control helper for the WEPPcloud Docker Compose stacks
.SH SYNOPSIS
.B wctl
[docker compose arguments...]
.br
.B wctl doc-lint
[lint arguments...]
.br
.B wctl doc-catalog
[catalog arguments...]
.br
.B wctl doc-toc
[toc arguments...]
.br
.B wctl doc-mv
[move arguments...]
.br
.B wctl doc-refs
[refs arguments...]
.br
.B wctl doc-bench
[bench arguments...]
.br
.B wctl build-static-assets
[options]
.br
.B wctl flask-db-upgrade
[alembic arguments...]
.br
.B sudo\ wctl restore-docker-data-permissions
.br
.B wctl man
[man arguments...]
.br
.B wctl update-stub-requirements
[options]
.br
.B wctl run-test-profile
profile [options]
.br
.B wctl run-fork-profile
profile [options]
.br
.B wctl run-archive-profile
profile [options]
.SH DESCRIPTION
.PP
The
.B wctl
command is a thin wrapper around
.BR docker\ compose (1)
that pins the compose file and environment file used by the WEPPcloud development and production stacks.
.PP
When invoked with standard arguments,
.B wctl
passes them through to
.BR docker\ compose ,
automatically loading environment variables from
.IR docker/.env .
This ensures all services share the same configuration without requiring repeated
.B --env-file
and
.B -f
flags.
.PP
Several helper commands are available and are listed below.
.PP
An accompanying Typer-based CLI,
.B wctl2 ,
is available for side-by-side testing. Install it with
.B "./wctl/install.sh dev --new-cli"
to exercise the Python implementation while keeping this legacy wrapper in place. Both CLIs share parity for doc helpers, playback commands, and docker compose passthrough (including the canonical
.I backed-globule
smoke profile).
.SH COMMANDS
.TP
.B wctl doc-lint
Runs
.BR "markdown-doc lint" .
When called without additional arguments the wrapper executes
.BR "markdown-doc lint --staged --format json"
and prints a short notice to stderr before streaming the JSON result. Provide any arguments to override the defaults (for example
.BR "--path docs --format sarif" ).
.TP
.B wctl doc-catalog
Executes
.BR "markdown-doc catalog" .
All flags are forwarded. Use options like
.BR "--path docs"
to scope catalog generation when directories outside the documentation tree are inaccessible.
.TP
.B wctl doc-toc
Synchronises table-of-contents blocks by translating positional Markdown paths into repeated
.B --path
flags before delegating to
.BR "markdown-doc toc" .
Requires at least one target path to avoid unexpected repository-wide updates; native flags such as
.B --update
and
.B --diff
are passed through.
.TP
.B wctl doc-mv
Performs a guarded move workflow via
.BR "markdown-doc mv" .
The wrapper always runs a dry-run first, then prompts on
.I /dev/tty
before applying the live move. Use
.B --dry-run-only
to skip the apply step or
.B --force
to bypass the confirmation prompt while still executing the preview.
.TP
.B wctl doc-refs
Calls
.BR "markdown-doc refs"
to list inbound references for a path, glob, or anchor. Combine with
.B --path
to restrict the search to accessible subdirectories.
.TP
.B wctl doc-bench
Runs the
.BR "markdown-doc-bench"
helper. Flags such as
.BR --path ,
.BR --warmup ,
and
.BR --iterations
are forwarded so documentation performance benchmarks can run from the same CLI.
.TP
.B wctl build-static-assets
Runs the frontend build script at
.IR wepppy/weppcloud/static-src/build-static-assets.sh .
The script automatically adds
.B --prod
when the wctl installation targets the production compose file.
.TP
.B wctl flask-db-upgrade
Runs
.I flask\ --app\ wepppy.weppcloud.app\ db\ upgrade
inside the running
.I weppcloud
service container. Any additional arguments are passed through to Flask-Migrate, allowing subcommands such as
.B --tag
or
.B --sql
to be used.
.TP
.B sudo\ wctl restore-docker-data-permissions
Fixes ownership and permissions inside the
.IR .docker-data /
tree: Postgres data and backups are set to UID/GID 999, Redis data to UID/GID 999, and the WEPPcloud runtime directories to the UID/GID configured in
.IR docker/.env
(default 1000:993). Use this after an accidental
.B chown
on the bind mounts.
.TP
.B wctl man
Displays this manual page. The command prefers an installed manual entry
.RB ( man\ wctl )
but falls back to the in-repo copy if necessary. Any additional arguments are forwarded to
.BR man (1).
.TP
.B wctl update-stub-requirements
Runs the helper script in
.IR tools/update_stub_requirements.py
to analyze mypy diagnostics and refresh
.IR docker/requirements-stubs-uv.txt .
Any options provided after the command (for example
.BR --no-verify )
are passed directly to the script.
.TP
.B wctl run-pytest
Runs
.B pytest
inside the
.I weppcloud
container with the correct environment (defaults to
.BR "pytest tests" ).
Additional arguments are forwarded to pytest.
.TP
.B wctl run-stubtest
Executes
.B stubtest
inside the container from
.IR /tmp ,
setting
.B PYTHONPATH=/workdir/wepppy
and
.B MYPY_CACHE_DIR=/tmp/mypy_cache
so cache files are writable. Pass one or more module names (defaults to
.BR wepppy.nodb.core ).
.TP
.B wctl run-npm
Runs
.B npm
on the host with
.BR "--prefix wepppy/weppcloud/static-src" .
Common invocations include
.BR "wctl run-npm install"
and
.BR "wctl run-npm test" .
This helper ensures frontend tooling executes from the correct project directory without extra typing.
.TP
.B wctl run-stubgen
Regenerates the local stub tree via
.BR "python tools/sync_stubs.py" .
.TP
.B wctl run-test-profile
Calls the profile playback FastAPI service to replay a promoted profile located under
.IR /workdir/wepppy-test-engine-data/profiles .
Supports
.BR --dry-run ,
.BR --base-url ,
.BR --service-url ,
.BR --cookie ,
.BR --cookie-file ,
and related options; the command streams the service response so local runs and CI workflows behave identically.
.TP
.B wctl run-fork-profile
Exercises the sandbox fork workflow by copying the recorded profile into the playback run directory and issuing the standard fork API request. Options include
.BR --undisturbify ,
.BR --target-runid ,
.BR --base-url ,
.BR --service-url ,
.BR --cookie ,
.BR --cookie-file ,
and
.BR --timeout .
.TP
.B wctl run-archive-profile
Submits an archive job against the sandbox copy of a profile run, mirroring the production archive endpoint. Accepts
.BR --archive-comment ,
.BR --base-url ,
.BR --service-url ,
.BR --cookie ,
.BR --cookie-file ,
and
.BR --timeout
flags; the resulting archive metadata is printed as JSON.
.TP
.B wctl check-test-stubs
Runs
.BR "python tools/check_stubs.py"
inside the
.I weppcloud
container to verify that sys.modules stubs defined in the test suite match the public API exports of the modules they replace.
.TP
.B wctl check-test-isolation
Invokes
.BR "python tools/check_test_isolation.py"
inside the
.I weppcloud
container. Use this command to fuzz test order, re-run each file in isolation, and flag leaked global state before it trips other suites. All script flags are supported, including
.BR --quick ,
.BR --strict ,
.BR --iterations ,
and
.BR --json .
.SH ENVIRONMENT
.TP
.B WEPPPY_ENV_FILE
Path to the sanitized environment file generated by
.BR wctl .
Normally this is managed automatically and points to a temporary file.
.TP
.B UID , GID
Numeric IDs stored in
.IR docker/.env .
They control the runtime user and group for the Docker containers and are reused by
.B restore-docker-data-permissions
when fixing ownership.
.SH FILES
.TP
.I docker/.env
Primary configuration file read by
.BR wctl .
Values are sanitized (dollar signs doubled) before being passed to Docker Compose.
.TP
.I docker/docker-compose.dev.yml
.TP
.I docker/docker-compose.prod.yml
Compose files selected during installation.
.TP
.I wepppy/weppcloud/static-src/build-static-assets.sh
Frontend asset build script used by
.BR build-static-assets .
.TP
.I .docker-data/
Host directories bind-mounted into the containers for persistent data.
.SH EXAMPLES
.TP
.B wctl up --build
Start or rebuild the WEPPcloud development stack.
.TP
.B sudo\ wctl restore-docker-data-permissions
Repair permissions for all persistent data directories.
.TP
.B wctl flask-db-upgrade
Apply pending Alembic migrations inside the running application container.
.TP
.B wctl man --no-pager
Read this manual without invoking the
.B man
pager.
.SH SEE ALSO
.BR docker\ compose (1),
.BR man (1)

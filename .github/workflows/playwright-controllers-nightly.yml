name: Playwright Controllers Nightly

on:
  schedule:
    # 02:15 AM Pacific Time â‰ˆ 10:15 UTC
    - cron: "15 10 * * *"
  workflow_dispatch:

jobs:
  playwright-controllers:
    runs-on:
      - self-hosted
      - Linux
      - X64
      - homelab
    timeout-minutes: 40
    env:
      # Use test-results/ to avoid conflicts with Playwright's internal report management
      # See: docs/ui-docs/theme-metrics.spec.md section 8 for details on output directory conflicts
      PLAYWRIGHT_REPORT_PATH: test-results/playwright-controller-report

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          clean: false

      - name: Ensure docker/.env exists
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f docker/.env ]; then
            printf "%s\n" \
              "UID=1000" \
              "GID=993" \
              "POSTGRES_PASSWORD=localdev" \
              "SECRET_KEY=localdev" \
              "SECURITY_PASSWORD_SALT=localdev" \
              > docker/.env
          fi

      - name: Install wctl shim
        env:
          WCTL_SYMLINK_PATH: "${{ github.workspace }}/.wctl/bin/wctl"
        run: |
          set -euo pipefail
          mkdir -p "${GITHUB_WORKSPACE}/.wctl/bin"
          chmod +x wctl/install.sh
          ./wctl/install.sh dev
          echo "${GITHUB_WORKSPACE}/.wctl/bin" >> "$GITHUB_PATH"

      - name: Install npm dependencies
        run: |
          set -euo pipefail
          wctl run-npm install

      - name: Run Playwright controller suite
        run: |
          set -euo pipefail
          wctl run-playwright \
            --suite controllers \
            --workers 1 \
            --report-path "$PLAYWRIGHT_REPORT_PATH"

      - name: Upload Playwright controller report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-controllers-report
          path: wepppy/weppcloud/static-src/${{ env.PLAYWRIGHT_REPORT_PATH }}
          if-no-files-found: warn

      - name: Remove redis data directory
        run: |
          set -euo pipefail
          if [ -d "${GITHUB_WORKSPACE}/.docker-data/redis" ]; then
            echo "Removing ${GITHUB_WORKSPACE}/.docker-data/redis"
            sudo rm -rf "${GITHUB_WORKSPACE}/.docker-data/redis"
          else
            echo "Redis data directory not present; nothing to remove."
          fi

name: Profile Fork - Rattlesnake (Undisturbify)

on:
  schedule:
    # 05:15 Pacific == 12:15 UTC during daylight saving; adjust if the target window changes.
    - cron: "15 12 * * *"
  workflow_dispatch:

jobs:
  rattlesnake-profile:
    runs-on:
      - self-hosted
      - Linux
      - X64
      - homelab
    timeout-minutes: 120
    env:
      ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      WCTL_BIN: ${{ format('{0}/wctl/wctl.sh', github.workspace) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          clean: false

      - name: Verify workspace wctl tooling
        run: |
          set -euo pipefail
          if [ ! -x "${WCTL_BIN}" ]; then
            echo "Workspace wctl script missing or not executable: ${WCTL_BIN}" >&2
            exit 127
          fi
          "${WCTL_BIN}" --help >/dev/null

      - name: Health check WEPPcloud service
        run: |
          set -euo pipefail
          deadline=$((SECONDS + 300))
          while true; do
            if curl -fsS https://wc.bearhive.duckdns.org/health >/dev/null; then
              echo "WEPPcloud service is healthy."
              break
            fi
            if [ "${SECONDS}" -ge "${deadline}" ]; then
              echo "Timed out waiting for WEPPcloud service to become healthy." >&2
              exit 1
            fi
            sleep 5
          done

      - name: Fork Rattlesnake profile (Undisturbify)
        run: |
          set -euo pipefail
          mkdir -p telemetry
          "${WCTL_BIN}" run-fork-profile rattlesnake-topaz-vanilla-wepp-watar --undisturbify \
            2>&1 | tee telemetry/rattlesnake-profile-fork.log

      - name: Upload profile playback log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rattlesnake-profile-fork-log
          path: telemetry/rattlesnake-profile-fork.log
          if-no-files-found: warn

      - name: Remove redis data directory
        if: always()
        run: |
          set -euo pipefail
          if [ -d "${GITHUB_WORKSPACE}/.docker-data/redis" ]; then
            echo "Removing ${GITHUB_WORKSPACE}/.docker-data/redis"
            sudo rm -rf "${GITHUB_WORKSPACE}/.docker-data/redis"
          else
            echo "Redis data directory not present; nothing to remove."
          fi

name: CI Samurai Nightly

on:
  schedule:
    - cron: '0 11 * * *'  # 3am PST (11:00 UTC)
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch, tag, or commit to deploy on the nuc hosts (defaults to main on schedule, current ref otherwise)'
        required: false

jobs:
  dryrun:
    runs-on: self-hosted
    timeout-minutes: 120
    env:
      NUC1: nuc1.local
      NUC2: nuc2.local
      NUC3: nuc3.local
      REPO: /workdir/wepppy
      WC1: /wc1
      LOOPS: '3'
      CAO_BASE_URL: http://nuc2.local:9889
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve target revision
        run: |
          set -euo pipefail
          REF_INPUT="${{ github.event.inputs.ref }}"
          if [ -n "${REF_INPUT}" ]; then
            TARGET_REF="${REF_INPUT}"
          elif [ "${GITHUB_EVENT_NAME}" = "schedule" ]; then
            TARGET_REF="main"
          else
            TARGET_REF="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"
          fi
          if git rev-parse --verify "$TARGET_REF^{commit}" >/dev/null 2>&1; then
            TARGET_SHA=$(git rev-parse "$TARGET_REF^{commit}")
          else
            TARGET_SHA=$(git ls-remote origin "$TARGET_REF" | awk '{print $1}')
            if [ -z "$TARGET_SHA" ]; then
              echo "Unable to resolve $TARGET_REF from origin" >&2
              exit 1
            fi
          fi
          SAFE_LABEL=$(echo "$TARGET_REF" | tr '/:@' '___')
          echo "Resolved target ref $TARGET_REF -> $TARGET_SHA (label=$SAFE_LABEL)"
          echo "TARGET_REF=$TARGET_REF" >> "$GITHUB_ENV"
          echo "TARGET_SHA=$TARGET_SHA" >> "$GITHUB_ENV"
          echo "TARGET_LABEL=$SAFE_LABEL" >> "$GITHUB_ENV"

      - name: Sync nuc repositories to target revision
        run: |
          set -euo pipefail
          for host in "${NUC1}" "${NUC2}" "${NUC3}"; do
            echo "==> Syncing ${host} to ${TARGET_SHA}"
            ssh "$host" "
              set -euo pipefail
              cd ${REPO}
              git fetch origin --tags
              git fetch origin
              git switch -C ci-samurai-${TARGET_LABEL} ${TARGET_SHA}
              git submodule sync --recursive
              git submodule update --init --recursive
            "
          done

      - name: Restart weppcloud stack and verify health
        run: |
          set -euo pipefail
          for host in "${NUC1}" "${NUC2}" "${NUC3}"; do
            echo "==> Restarting weppcloud on ${host}"
            ssh "$host" "
              set -euo pipefail
              cd ${REPO}
              wctl restart weppcloud
            "
            echo "==> Waiting for health on ${host}"
            ssh "$host" "
              set -euo pipefail
              deadline=\$((SECONDS + 180))
              while true; do
                if curl -fsS http://localhost:8080/weppcloud/health >/dev/null 2>&1; then
                  echo \"Health check passed on ${host}\"
                  break
                fi
                if [ \$SECONDS -ge \$deadline ]; then
                  echo \"Health check failed to respond on ${host}\" >&2
                  exit 1
                fi
                sleep 5
              done
            "
          done

      - name: Run CI Samurai dry run (triage/validate/flake)
        run: |
          make ci-dryrun \
            NUC1="${NUC1}" NUC2="${NUC2}" NUC3="${NUC3}" \
            REPO="${REPO}" WC1="${WC1}" LOOPS="${LOOPS}" SCOPE="${SCOPE}"

      - name: Package latest logs from nuc1
        id: package
        run: |
          set -euo pipefail
          LATEST_DIR=$(ssh "${NUC1}" "ls -td ${WC1}/ci-samurai/logs/* 2>/dev/null | head -1 || true")
          if [ -z "${LATEST_DIR}" ]; then
            echo "No logs found under ${WC1}/ci-samurai/logs on ${NUC1}" >&2
            exit 0
          fi
          echo "latest_dir=${LATEST_DIR}" >> $GITHUB_OUTPUT
          echo "Packaging from ${LATEST_DIR}"
          DEST=ci-samurai-logs
          rm -rf "$DEST"
          mkdir -p "$DEST"
          # Copy the directory tree locally, then archive on the runner
          scp -r "${NUC1}:${LATEST_DIR}" "$DEST/"
          NAME=$(basename "${LATEST_DIR}")
          tar -czf ci-samurai-logs.tgz -C "$DEST" "$NAME"

      - name: Upload logs artifact
        if: ${{ steps.package.outputs.latest_dir != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-samurai-logs
          path: ci-samurai-logs.tgz

      - name: Parse failures from triage log
        if: ${{ steps.package.outputs.latest_dir != '' }}
        run: |
          set -euo pipefail
          if command -v python >/dev/null 2>&1; then PY=python; else PY=python3; fi
          rm -rf logs_extract
          mkdir -p logs_extract
          tar -xzf ci-samurai-logs.tgz -C logs_extract
          TRIAGE=$(find logs_extract -type f -name triage.txt | head -1 || true)
          if [ -z "$TRIAGE" ]; then
            echo "No triage.txt found in artifact; skipping parse" >&2
            exit 0
          fi
          echo "Parsing failures from $TRIAGE"
          "$PY" services/cao/ci-samurai/parse_pytest_log.py "$TRIAGE" > failures.jsonl || true
          FAILURE_COUNT=$(wc -l < failures.jsonl || echo 0)
          echo "Parsed $FAILURE_COUNT failures"
          if [ "$FAILURE_COUNT" = "0" ]; then
            echo "âœ… No test failures detected - all tests passed!"
            echo "--- triage tail (200) ---" && tail -n 200 "$TRIAGE" || true
          else
            echo "--- failures.jsonl (head) ---" && head -n 20 failures.jsonl || true
          fi

      - name: Diagnose logs (quick summary)
        if: ${{ steps.package.outputs.latest_dir != '' }}
        run: |
          set -euo pipefail
          if command -v python >/dev/null 2>&1; then PY=python; else PY=python3; fi
          "$PY" services/cao/ci-samurai/diagnose_artifact.py ci-samurai-logs.tgz | tee diagnose_summary.txt || true

      - name: Upload extracted logs
        if: ${{ steps.package.outputs.latest_dir != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-samurai-logs-extracted
          path: logs_extract
          if-no-files-found: warn

      - name: Upload diagnose summary
        if: ${{ steps.package.outputs.latest_dir != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-samurai-diagnose
          path: diagnose_summary.txt
          if-no-files-found: warn

      - name: Upload failures list
        if: ${{ steps.package.outputs.latest_dir != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-samurai-failures
          path: failures.jsonl

      - name: Check CAO health (nuc2)
        run: |
          set -euo pipefail
          curl -fsS "${CAO_BASE_URL}/health" || {
            echo "CAO server not reachable at ${CAO_BASE_URL}/health" >&2
            exit 1
          }
          echo "CAO health OK"

      - name: Run fixer loop (per-error agents)
        if: ${{ steps.package.outputs.latest_dir != '' }}
        env:
          NUC2: ${{ env.NUC2 }}
          REPO: ${{ env.REPO }}
          CAO_BASE_URL: ${{ env.CAO_BASE_URL }}
        run: |
          set -euo pipefail
          if command -v python >/dev/null 2>&1; then PY=python; else PY=python3; fi
          if [ ! -s failures.jsonl ]; then
            echo "âœ… No failures.jsonl to process - skipping fixer loop (all tests passed)"
            exit 0
          fi
          FAILURE_COUNT=$(wc -l < failures.jsonl || echo 0)
          echo "ðŸ”§ Processing $FAILURE_COUNT test failures with CAO fixer agents..."
          "$PY" services/cao/ci-samurai/run_fixer_loop.py \
            --failures failures.jsonl \
            --repo-root . \
            --nuc2 "${NUC2}" \
            --repo "${REPO}" \
            --cao-base "${CAO_BASE_URL}" \
            --max-failures 100 \
            --poll-seconds 300

      - name: List agent logs
        if: ${{ steps.package.outputs.latest_dir != '' }}
        run: |
          set -euo pipefail
          if [ -d agent_logs ]; then
            echo "Agent logs present:" && find agent_logs -maxdepth 1 -type f -printf "%f\n" | sed 's/^/ - /'
          else
            echo "No agent_logs directory produced"
          fi

      - name: Upload agent logs
        if: ${{ steps.package.outputs.latest_dir != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-samurai-agent-logs
          path: agent_logs
          if-no-files-found: warn

      - name: GH CLI smoke on nuc2
        run: |
          set -euo pipefail
          ssh "${NUC2}" "gh --version || true"
          echo "Checking GH auth status on ${NUC2}"
          ssh "${NUC2}" "gh auth status || true"
          echo "Checking GH repo access on ${NUC2}"
          ssh "${NUC2}" "cd ${REPO} && gh repo view || true"

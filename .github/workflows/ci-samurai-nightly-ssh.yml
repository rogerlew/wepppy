name: CI Samurai Nightly

on:
  schedule:
    - cron: '0 11 * * *'  # 3am PST (11:00 UTC)
  workflow_dispatch: {}

jobs:
  dryrun:
    runs-on: self-hosted
    timeout-minutes: 120
    env:
      NUC1: nuc1.local
      NUC2: nuc2.local
      NUC3: nuc3.local
      REPO: /workdir/wepppy
      WC1: /wc1
      LOOPS: '3'
      SCOPE: '--nodb-only'
      CAO_BASE_URL: http://forest:9889
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run CI Samurai dry run (triage/validate/flake)
        run: |
          make ci-dryrun \
            NUC1="${NUC1}" NUC2="${NUC2}" NUC3="${NUC3}" \
            REPO="${REPO}" WC1="${WC1}" LOOPS="${LOOPS}" SCOPE="${SCOPE}"

      - name: Package latest logs from nuc1
        id: package
        run: |
          set -euo pipefail
          LATEST_DIR=$(ssh "${NUC1}" "ls -td ${WC1}/ci-samurai/logs/* 2>/dev/null | head -1 || true")
          if [ -z "${LATEST_DIR}" ]; then
            echo "No logs found under ${WC1}/ci-samurai/logs on ${NUC1}" >&2
            exit 0
          fi
          echo "latest_dir=${LATEST_DIR}" >> $GITHUB_OUTPUT
          echo "Packaging from ${LATEST_DIR}"
          DEST=ci-samurai-logs
          rm -rf "$DEST"
          mkdir -p "$DEST"
          # Copy the directory tree locally, then archive on the runner
          scp -r "${NUC1}:${LATEST_DIR}" "$DEST/"
          NAME=$(basename "${LATEST_DIR}")
          tar -czf ci-samurai-logs.tgz -C "$DEST" "$NAME"

      - name: Upload logs artifact
        if: ${{ steps.package.outputs.latest_dir != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-samurai-logs
          path: ci-samurai-logs.tgz

      - name: Parse failures from triage log
        if: ${{ steps.package.outputs.latest_dir != '' }}
        run: |
          set -euo pipefail
          if command -v python >/dev/null 2>&1; then PY=python; else PY=python3; fi
          rm -rf logs_extract
          mkdir -p logs_extract
          tar -xzf ci-samurai-logs.tgz -C logs_extract
          TRIAGE=$(find logs_extract -type f \( -name triage_nodb.txt -o -name triage_wepp.txt \) | head -1 || true)
          if [ -z "$TRIAGE" ]; then
            echo "No triage_nodb.txt or triage_wepp.txt found in artifact; skipping parse" >&2
            exit 0
          fi
          echo "Parsing failures from $TRIAGE"
          "$PY" services/cao/ci-samurai/parse_pytest_log.py "$TRIAGE" > failures.jsonl || true
          echo "Parsed $(wc -l < failures.jsonl || echo 0) failures"
          echo "--- failures.jsonl (head) ---" && head -n 20 failures.jsonl || true

      - name: Diagnose logs (quick summary)
        if: ${{ steps.package.outputs.latest_dir != '' }}
        run: |
          set -euo pipefail
          if command -v python >/dev/null 2>&1; then PY=python; else PY=python3; fi
          "$PY" services/cao/ci-samurai/diagnose_artifact.py ci-samurai-logs.tgz || true

      - name: Upload failures list
        if: ${{ steps.package.outputs.latest_dir != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-samurai-failures
          path: failures.jsonl

      - name: Check CAO health (forest)
        run: |
          set -euo pipefail
          curl -fsS "${CAO_BASE_URL}/health" || {
            echo "CAO server not reachable at ${CAO_BASE_URL}/health" >&2
            exit 1
          }
          echo "CAO health OK"

      - name: Run fixer loop (per-error agents)
        if: ${{ steps.package.outputs.latest_dir != '' }}
        env:
          NUC2: ${{ env.NUC2 }}
          REPO: ${{ env.REPO }}
          CAO_BASE_URL: ${{ env.CAO_BASE_URL }}
        run: |
          set -euo pipefail
          if command -v python >/dev/null 2>&1; then PY=python; else PY=python3; fi
          if [ ! -s failures.jsonl ]; then
            echo "No failures.jsonl; nothing to fix"
            exit 0
          fi
          "$PY" services/cao/ci-samurai/run_fixer_loop.py \
            --failures failures.jsonl \
            --repo-root . \
            --nuc2 "${NUC2}" \
            --repo "${REPO}" \
            --cao-base "${CAO_BASE_URL}" \
            --max-failures 100 \
            --poll-seconds 300

      - name: List agent logs
        if: ${{ steps.package.outputs.latest_dir != '' }}
        run: |
          set -euo pipefail
          if [ -d agent_logs ]; then
            echo "Agent logs present:" && find agent_logs -maxdepth 1 -type f -printf "%f\n" | sed 's/^/ - /'
          else
            echo "No agent_logs directory produced"
          fi

      - name: Upload agent logs
        if: ${{ steps.package.outputs.latest_dir != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ci-samurai-agent-logs
          path: agent_logs
          if-no-files-found: warn

      - name: GH CLI smoke on nuc2
        run: |
          set -euo pipefail
          ssh "${NUC2}" "gh --version || true"
          echo "Checking GH auth status on ${NUC2}"
          ssh "${NUC2}" "gh auth status || true"
          echo "Checking GH repo access on ${NUC2}"
          ssh "${NUC2}" "cd ${REPO} && gh repo view || true"

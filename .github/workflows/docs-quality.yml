name: Docs Quality

on:
  pull_request:
    paths:
      - '**/*.md'
      - 'wctl/**'
      - '.markdown-doc-ignore'
      - '.github/workflows/docs-quality.yml'
  push:
    branches:
      - master
    paths:
      - '**/*.md'
      - 'wctl/**'
      - '.markdown-doc-ignore'
      - '.github/workflows/docs-quality.yml'

jobs:
  docs-quality:
    runs-on:
      - self-hosted
      - Linux
      - X64
      - homelab
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy .env from host
        run: |
          # Self-hosted runner has access to /workdir/wepppy/docker/.env
          cp /workdir/wepppy/docker/.env docker/.env
        shell: bash

      - name: Verify markdown-doc tooling
        run: |
          set -euo pipefail
          command -v markdown-doc >/dev/null || {
            echo "markdown-doc binary not found. Install it on the self-hosted runner (see docs/work-packages/20251025_markdown_doc_toolkit/rfc_markdown_doc_adoption.md)." >&2
            exit 127
          }
          command -v markdown-doc-bench >/dev/null || {
            echo "markdown-doc-bench binary not found. Install it on the self-hosted runner." >&2
            exit 127
          }
          markdown-doc --version
          markdown-doc-bench --help >/dev/null

      - name: Run markdown-doc lint (SARIF + JSON)
        run: |
          set -euo pipefail
          # Run lint and capture exit code
          status=0
          wctl doc-lint --format sarif > docs-lint.sarif || status=$?
          
          # Also generate JSON for artifact (don't fail on this)
          wctl doc-lint --format json > docs-lint.json || true
          
          # Verify SARIF was created (empty file means command failed)
          if [ ! -s docs-lint.sarif ]; then
            echo "Error: SARIF output is empty. Lint command may have failed." >&2
            cat << EOF > docs-lint.sarif
          {
            "version": "2.1.0",
            "\$schema": "https://json.schemastore.org/sarif-2.1.0.json",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "markdown-doc",
                    "rules": []
                  }
                },
                "results": []
              }
            ]
          }
          EOF
          fi
          
          exit ${status}

      - name: Run markdown-doc Rust checks
        run: |
          set -euo pipefail

          discover_workspace() {
            if [ -n "${MARKDOWN_DOC_WORKSPACE:-}" ] && [ -f "${MARKDOWN_DOC_WORKSPACE}/Cargo.toml" ]; then
              echo "${MARKDOWN_DOC_WORKSPACE}"
              return
            fi
            for candidate in markdown-extract /usr/local/src/markdown-extract /workdir/markdown-extract /opt/markdown-extract; do
              if [ -f "${GITHUB_WORKSPACE}/${candidate}/Cargo.toml" ]; then
                echo "${GITHUB_WORKSPACE}/${candidate}"
                return
              elif [ -f "${candidate}/Cargo.toml" ]; then
                echo "${candidate}"
                return
              fi
            done
          }

          WORKSPACE="$(discover_workspace || true)"
          if [ -z "${WORKSPACE}" ]; then
            echo "markdown-doc workspace not found (set MARKDOWN_DOC_WORKSPACE or ensure Cargo project is available). Skipping Rust checks." >&2
            exit 0
          fi

          echo "Using markdown-doc workspace: ${WORKSPACE}"
          cd "${WORKSPACE}"

          cargo fmt --all --check
          cargo clippy --all-targets --all-features -- -D warnings
          cargo test --all --locked

      - name: Run markdown-doc benchmarks
        run: |
          set -euo pipefail
          wctl doc-bench --path docs --warmup 0 --iterations 1

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: docs-lint.sarif

      - name: Upload lint JSON artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docs-lint-json
          path: docs-lint.json
          

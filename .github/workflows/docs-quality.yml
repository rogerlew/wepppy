name: Docs Quality

on:
  pull_request:
    paths:
      - '**/*.md'
      - 'wctl/**'
      - '.markdown-doc-ignore'
      - '.github/workflows/docs-quality.yml'
  push:
    branches:
      - master
    paths:
      - '**/*.md'
      - 'wctl/**'
      - '.markdown-doc-ignore'
      - '.github/workflows/docs-quality.yml'

jobs:
  docs-quality:
    runs-on:
      - self-hosted
      - Linux
      - X64
      - homelab
    permissions:
      contents: read
      security-events: write
    env:
      MARKDOWN_DOC_WORKSPACE: ${{ secrets.MARKDOWN_DOC_WORKSPACE }}
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          clean: false # root-owned docker artifacts block git clean on self-hosted runner

      - name: Verify markdown-doc tooling
        run: |
          set -euo pipefail
          command -v markdown-doc >/dev/null || {
            echo "markdown-doc binary not found. Install it on the self-hosted runner (see docs/work-packages/20251025_markdown_doc_toolkit/rfc_markdown_doc_adoption.md)." >&2
            exit 127
          }
          command -v markdown-doc-bench >/dev/null || {
            echo "markdown-doc-bench binary not found. Install it on the self-hosted runner." >&2
            exit 127
          }
          markdown-doc --version
          markdown-doc-bench --help >/dev/null

      - name: Run markdown-doc lint (SARIF + JSON)
        run: |
          set -euo pipefail

          TARGETS=(
            --path docs
            --path docs/work-packages
            --path AGENTS.md
            --path README.md
            --path PROJECT_TRACKER.md
            --path CONTRIBUTING_AGENTS.md
            --path TYPE_HINTS_SUMMARY.md
          )

          status=0
          "/usr/local/bin/wctl doc-lint "${TARGETS[@]}" --format sarif > docs-lint.sarif || status=$?

          # Also generate JSON for artifact (don't fail on this)
          "/usr/local/bin/wctl doc-lint "${TARGETS[@]}" --format json > docs-lint.json || true

          # Ensure SARIF exists (fallback placeholder when command fails before writing)
          if [ ! -s docs-lint.sarif ]; then
            echo "Warning: SARIF output is empty. Writing placeholder for upload." >&2
            python -c 'import json, pathlib; pathlib.Path("docs-lint.sarif").write_text(json.dumps({"version":"2.1.0","$schema":"https://json.schemastore.org/sarif-2.1.0.json","runs":[{"tool":{"driver":{"name":"markdown-doc","rules":[]}},"results":[]}]} , indent=2)+"\n", encoding="utf-8")'
          fi

          # Ensure JSON artifact exists (fallback placeholder)
          if [ ! -s docs-lint.json ]; then
            echo "Warning: JSON lint output is empty. Writing placeholder summary." >&2
            python -c 'import json, pathlib; pathlib.Path("docs-lint.json").write_text(json.dumps({"summary":{"files_scanned":0,"errors":0,"warnings":0},"findings":[]} , indent=2)+"\n", encoding="utf-8")'
          fi

          echo "LINT_STATUS=${status}" >> "${GITHUB_ENV}"
          exit 0

      - name: Run markdown-doc Rust checks
        run: |
          set -euo pipefail

          discover_workspace() {
            if [ -n "${MARKDOWN_DOC_WORKSPACE:-}" ] && [ -f "${MARKDOWN_DOC_WORKSPACE}/Cargo.toml" ]; then
              echo "${MARKDOWN_DOC_WORKSPACE}"
              return
            fi
            for candidate in markdown-extract /usr/local/src/markdown-extract /workdir/markdown-extract /opt/markdown-extract; do
              if [ -f "${GITHUB_WORKSPACE}/${candidate}/Cargo.toml" ]; then
                echo "${GITHUB_WORKSPACE}/${candidate}"
                return
              elif [ -f "${candidate}/Cargo.toml" ]; then
                echo "${candidate}"
                return
              fi
            done
          }

          WORKSPACE="$(discover_workspace || true)"
          if [ -z "${WORKSPACE}" ]; then
            echo "markdown-doc workspace not found (set MARKDOWN_DOC_WORKSPACE or ensure Cargo project is available). Skipping Rust checks." >&2
            exit 0
          fi

          echo "Using markdown-doc workspace: ${WORKSPACE}"
          cd "${WORKSPACE}"

          cargo fmt --all --check
          cargo clippy --all-targets --all-features -- -D warnings

          # Skip PyO3 bindings crates during CI because the self-hosted runner lacks libpython dev headers.
          # The workspace still gets full coverage locally (see docs/work-packages/20251025_markdown_doc_toolkit/).
          EXCLUDES=(
            markdown_extract_py
            markdown_edit_py
            markdown_doc_py
          )

          TEST_ARGS=(--workspace --locked)
          for crate in "${EXCLUDES[@]}"; do
            TEST_ARGS+=("--exclude" "${crate}")
          done

          cargo test "${TEST_ARGS[@]}"

      - name: Run markdown-doc benchmarks
        run: |
          set -euo pipefail
          "/usr/local/bin/wctl doc-bench --path docs --warmup 0 --iterations 1"

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: docs-lint.sarif

      - name: Upload lint JSON artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docs-lint-json
          path: docs-lint.json

      - name: Fail on lint errors
        if: env.LINT_STATUS != '0'
        run: |
          echo "markdown-doc lint reported errors (exit code ${LINT_STATUS})." >&2
          exit 1
          
      - name: Remove redis data directory
        run: |
          set -euo pipefail
          if [ -d "${GITHUB_WORKSPACE}/.docker-data/redis" ]; then
            echo "Removing ${GITHUB_WORKSPACE}/.docker-data/redis"
            sudo rm -rf "${GITHUB_WORKSPACE}/.docker-data/redis"
          else
            echo "Redis data directory not present; nothing to remove."
          fi

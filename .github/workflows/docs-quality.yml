name: Docs Quality

on:
  pull_request:
    paths:
      - '**/*.md'
      - 'wctl/**'
      - '.markdown-doc-ignore'
      - '.github/workflows/docs-quality.yml'
  push:
    branches:
      - master
    paths:
      - '**/*.md'
      - 'wctl/**'
      - '.markdown-doc-ignore'
      - '.github/workflows/docs-quality.yml'

jobs:
  docs-quality:
    runs-on:
      - self-hosted
      - Linux
      - X64
      - homelab
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify markdown-doc tooling
        run: |
          set -euo pipefail
          command -v markdown-doc >/dev/null || {
            echo "markdown-doc binary not found. Install it on the self-hosted runner (see docs/work-packages/20251025_markdown_doc_toolkit/rfc_markdown_doc_adoption.md)." >&2
            exit 127
          }
          command -v markdown-doc-bench >/dev/null || {
            echo "markdown-doc-bench binary not found. Install it on the self-hosted runner." >&2
            exit 127
          }
          markdown-doc --version
          markdown-doc-bench --help >/dev/null

      - name: Run markdown-doc lint (SARIF + JSON)
        run: |
          set -euo pipefail

          PATHS=(--path docs)
          while IFS= read -r file; do
            file="${file#./}"
            PATHS+=(--path "${file}")
          done < <(find . -maxdepth 1 -type f -name '*.md' -print)

          status=0
          wctl doc-lint "${PATHS[@]}" --format sarif > docs-lint.sarif || status=$?

          # Also generate JSON for artifact (don't fail on this)
          wctl doc-lint "${PATHS[@]}" --format json > docs-lint.json || true

          # Ensure SARIF exists (fallback placeholder when command fails before writing)
          if [ ! -s docs-lint.sarif ]; then
            echo "Warning: SARIF output is empty. Writing placeholder for upload." >&2
            python -c 'import json, pathlib; pathlib.Path("docs-lint.sarif").write_text(json.dumps({"version":"2.1.0","$schema":"https://json.schemastore.org/sarif-2.1.0.json","runs":[{"tool":{"driver":{"name":"markdown-doc","rules":[]}},"results":[]}]} , indent=2)+"\n", encoding="utf-8")'
          fi

          # Ensure JSON artifact exists (fallback placeholder)
          if [ ! -s docs-lint.json ]; then
            echo "Warning: JSON lint output is empty. Writing placeholder summary." >&2
            python -c 'import json, pathlib; pathlib.Path("docs-lint.json").write_text(json.dumps({"summary":{"files_scanned":0,"errors":0,"warnings":0},"findings":[]} , indent=2)+"\n", encoding="utf-8")'
          fi

          echo "LINT_STATUS=${status}" >> "${GITHUB_ENV}"
          exit 0

      - name: Normalize SARIF for CodeQL v3
        run: |
          set -euo pipefail
          if [ ! -f docs-lint.sarif ]; then
            echo "docs-lint.sarif missing; nothing to normalize." >&2
            exit 0
          fi
          python - <<'PY'
import json
from pathlib import Path

path = Path("docs-lint.sarif")
try:
    data = json.loads(path.read_text(encoding="utf-8"))
except json.JSONDecodeError as exc:
    raise SystemExit(f"Failed to parse SARIF: {exc}")

runs = data.get("runs", [])
for run in runs:
    driver = run.get("tool", {}).get("driver", {})
    for rule in driver.get("rules", []) or []:
        if "full_description" in rule:
            rule["fullDescription"] = rule.pop("full_description")
        if "short_description" in rule:
            rule["shortDescription"] = rule.pop("short_description")
    for result in run.get("results", []) or []:
        if "rule_id" in result:
            result["ruleId"] = result.pop("rule_id")
        if "rule_index" in result:
            result["ruleIndex"] = result.pop("rule_index")
        if "locations" in result:
            for location in result["locations"]:
                if "physical_location" in location:
                    phys = location.pop("physical_location")
                    if "artifact_location" in phys:
                        art = phys.pop("artifact_location")
                        if "uri_base_id" in art:
                            art["uriBaseId"] = art.pop("uri_base_id")
                        phys["artifactLocation"] = art
                    if "region" in phys and isinstance(phys["region"], dict):
                        region = phys["region"]
                        if "start_line" in region:
                            region["startLine"] = region.pop("start_line")
                        if "end_line" in region:
                            region["endLine"] = region.pop("end_line")
                    location["physicalLocation"] = phys

path.write_text(json.dumps(data, indent=2) + "\n", encoding="utf-8")
PY

      - name: Run markdown-doc Rust checks
        run: |
          set -euo pipefail

          discover_workspace() {
            if [ -n "${MARKDOWN_DOC_WORKSPACE:-}" ] && [ -f "${MARKDOWN_DOC_WORKSPACE}/Cargo.toml" ]; then
              echo "${MARKDOWN_DOC_WORKSPACE}"
              return
            fi
            for candidate in markdown-extract /usr/local/src/markdown-extract /workdir/markdown-extract /opt/markdown-extract; do
              if [ -f "${GITHUB_WORKSPACE}/${candidate}/Cargo.toml" ]; then
                echo "${GITHUB_WORKSPACE}/${candidate}"
                return
              elif [ -f "${candidate}/Cargo.toml" ]; then
                echo "${candidate}"
                return
              fi
            done
          }

          WORKSPACE="$(discover_workspace || true)"
          if [ -z "${WORKSPACE}" ]; then
            echo "markdown-doc workspace not found (set MARKDOWN_DOC_WORKSPACE or ensure Cargo project is available). Skipping Rust checks." >&2
            exit 0
          fi

          echo "Using markdown-doc workspace: ${WORKSPACE}"
          cd "${WORKSPACE}"

          cargo fmt --all --check
          cargo clippy --all-targets --all-features -- -D warnings
          cargo test --all --locked

      - name: Run markdown-doc benchmarks
        run: |
          set -euo pipefail
          wctl doc-bench --path docs --warmup 0 --iterations 1

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: docs-lint.sarif

      - name: Upload lint JSON artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docs-lint-json
          path: docs-lint.json

      - name: Fail on lint errors
        if: env.LINT_STATUS != '0'
        run: |
          echo "markdown-doc lint reported errors (exit code ${LINT_STATUS})." >&2
          exit 1
          

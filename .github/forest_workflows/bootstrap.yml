env:
  RUNNER_DOCKER_ENV: /workdir/wepppy/docker/.env

setup_steps:
  - name: Checkout repository
    uses: actions/checkout@v4
    with:
      clean: false

  - name: Ensure docker/.env exists
    shell: bash
    run: |
      set -euo pipefail
      if [ -n "${RUNNER_DOCKER_ENV:-}" ] && [ -f "${RUNNER_DOCKER_ENV}" ]; then
        cp "${RUNNER_DOCKER_ENV}" docker/.env
        exit 0
      fi
      if [ ! -f docker/.env ]; then
        printf "%s\n" \
          "UID=1000" \
          "GID=993" \
          "POSTGRES_PASSWORD=localdev" \
          "SECRET_KEY=localdev" \
          "SECURITY_PASSWORD_SALT=localdev" \
          > docker/.env
      fi

  - name: Install wctl shim
    env:
      WCTL_SYMLINK_PATH: "${{ github.workspace }}/.wctl/bin/wctl"
    run: |
      set -euo pipefail
      mkdir -p "${GITHUB_WORKSPACE}/.wctl/bin"
      chmod +x wctl/install.sh
      ./wctl/install.sh dev
      echo "${GITHUB_WORKSPACE}/.wctl/bin" >> "$GITHUB_PATH"

cleanup_steps:
  - name: Remove redis data directory
    run: |
      set -euo pipefail
      if [ -d "${GITHUB_WORKSPACE}/.docker-data/redis" ]; then
        echo "Removing ${GITHUB_WORKSPACE}/.docker-data/redis"
        sudo rm -rf "${GITHUB_WORKSPACE}/.docker-data/redis"
      else
        echo "Redis data directory not present; nothing to remove."
      fi

<!doctype html>
<html lang="en" class="wc-page">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Query Console – {{ run_name }}</title>
    <link rel="stylesheet" href="/weppcloud/static/vendor/purecss/pure-min.css">
    <link rel="stylesheet" href="/weppcloud/static/vendor/purecss/grids-responsive-min.css">
    <link rel="stylesheet" href="/weppcloud/static/css/ui-foundation.css">
  </head>
  <body class="wc-page">
    {% from "shared/console_macros.htm" import console_page, console_header, button_row %}
    {% import "controls/_pure_macros.html" as ui %}
    <header class="wc-header">
      <div class="wc-header__inner wc-container">
        <a class="wc-brand" href="/weppcloud"><span class="wc-brand__primary">wepp</span><span class="wc-brand__secondary">cloud</span></a>
      </div>
    </header>
    <main class="wc-page__body">
      <div class="wc-container wc-stack">
        {% call console_page() %}
          {% call console_header(
            run_link=run_link,
            run_label=run_name,
            title="Query Console"
          ) %}
            <p class="wc-text-muted">
              Config: <code>{{ config_name }}</code><br>
              POST endpoint: <code>/query/runs/{{ run_slug }}/query</code>
            </p>
          {% endcall %}

          <section class="wc-stack">
            {% call ui.control_shell(
                 form_id="queryForm",
                 title="Query payload (JSON)",
                 collapsible=False,
                 form_class="wc-stack",
                 form_attrs={'novalidate': True},
                 status_panel_override='',
                 summary_panel_override='',
                 stacktrace_panel_override=''
               ) %}
              <p>
                Paste or edit the query payload below, then click <strong>POST</strong> to execute it.
                The response body and HTTP status will appear underneath. This is handy for testing payloads
                before wiring them into scripts or dashboards.
              </p>
              {% if not catalog_ready %}
                <div class="wc-note">
                  Catalog metadata was not found. Visit
                  <a href="{{ activate_url }}">/query/runs/{{ run_slug }}/activate</a>
                  to activate the run, then reload this page.
                </div>
              {% endif %}

              {% if catalog_entries %}
                <details>
                  <summary>Sample datasets (first {{ catalog_entries|length }})</summary>
                  <ul class="wc-dataset-list">
                    {% for entry in catalog_entries %}
                      <li>{{ entry.path }}</li>
                    {% endfor %}
                  </ul>
                </details>
              {% endif %}

              <fieldset class="wc-stack">
                <div class="wc-field">
                  <label class="wc-field__label" for="presetSelect">Example payloads</label>
                  <select id="presetSelect" class="wc-field__control">
                    <option value="">Choose an example…</option>
                    {% for category, presets in query_presets.items() %}
                      <optgroup label="{{ category }}">
                        {% for preset in presets %}
                          <option value="{{ preset.id }}">{{ preset.name }}</option>
                        {% endfor %}
                      </optgroup>
                    {% endfor %}
                  </select>
                  <p id="presetDescription" class="wc-field__help wc-text-muted"></p>
                </div>
                <div class="wc-field">
                  <label class="wc-field__label" for="payload">Query payload</label>
                  <textarea id="payload"
                            name="payload"
                            class="wc-field__control wc-code-input"
                            spellcheck="false"
                            rows="16"></textarea>
                </div>
                {% call button_row() %}
                  <button type="submit" class="pure-button" id="submitBtn">POST Query</button>
                  <button type="button" class="pure-button pure-button-secondary" id="formatBtn">Format JSON</button>
                  <button type="button" class="pure-button pure-button-secondary" id="resetBtn">Reset</button>
                {% endcall %}
              </fieldset>
            {% endcall %}
          </section>

          <section class="wc-stack">
            {% call ui.control_shell(
                 form_id="query_response_shell",
                 title="Response",
                 collapsible=False,
                 status_panel_override=ui.status_panel(
                   id="status_panel",
                   title="Status",
                   variant="compact",
                   log_id="status",
                   height="3.25rem",
                   initial="Waiting for request…"
                 ),
                 summary_panel_override='',
                 stacktrace_panel_override=ui.stacktrace_panel(
                   id="stacktraceContainer",
                   summary="Stack trace",
                   body_id="stacktrace",
                   description="Displays backend exceptions when a query fails.",
                   empty_state="No stack trace captured."
                 )
               ) %}
              <pre id="response" class="wc-code-block" aria-live="polite" aria-label="Response body"></pre>
            {% endcall %}
          </section>
        {% endcall %}
      </div>
    </main>
  <script>
    const form = document.getElementById('queryForm');
    const payloadInput = document.getElementById('payload');
    const statusLine = document.getElementById('status');
    const responseBlock = document.getElementById('response');
    const stacktraceContainer = document.getElementById('stacktraceContainer');
    const stacktraceBlock = document.getElementById('stacktrace');
    const presetSelect = document.getElementById('presetSelect');
    const presetDescription = document.getElementById('presetDescription');
    const initialPayload = {{ default_payload|tojson }};
    const presets = {{ query_presets|tojson }};
    const postUrl = {{ post_url|tojson }};

    const initialPayloadValue = JSON.stringify(initialPayload, null, 2);
    payloadInput.value = initialPayloadValue;

    function setStatus(message, state = 'attention') {
      statusLine.dataset.state = state;
      statusLine.textContent = message;
    }

    function applyPreset(presetId) {
      if (!presetId) {
        presetDescription.textContent = '';
        return;
      }
      for (const category of Object.values(presets)) {
        const preset = category.find((item) => item.id === presetId);
        if (preset) {
          payloadInput.value = JSON.stringify(preset.payload, null, 2);
          presetDescription.textContent = preset.description || '';
          return;
        }
      }
    }

    presetSelect.addEventListener('change', (event) => {
      applyPreset(event.target.value);
    });

    document.getElementById('formatBtn').addEventListener('click', () => {
      try {
        const parsed = JSON.parse(payloadInput.value);
        payloadInput.value = JSON.stringify(parsed, null, 2);
      } catch (err) {
        window.alert('Payload is not valid JSON.');
      }
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      payloadInput.value = initialPayloadValue;
      setStatus('Waiting for request…', 'attention');
      responseBlock.textContent = '';
      stacktraceContainer.hidden = true;
      stacktraceBlock.textContent = '';
      presetSelect.value = '';
      presetDescription.textContent = '';
    });

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      let payload;
      try {
        payload = JSON.stringify(JSON.parse(payloadInput.value));
      } catch (err) {
        window.alert('Payload is not valid JSON.');
        return;
      }

      setStatus('Posting query…', 'attention');
      responseBlock.textContent = '';
      stacktraceContainer.hidden = true;

      fetch(postUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: payload
      })
        .then(async (response) => {
          const text = await response.text();
          let formatted = text;
          try {
            formatted = JSON.stringify(JSON.parse(text), null, 2);
          } catch (err) {
            // Leave as text
          }
          responseBlock.textContent = formatted;
          if (response.ok) {
            setStatus(`Success (HTTP ${response.status})`, 'positive');
          } else {
            setStatus(`Error (HTTP ${response.status})`, 'critical');
          }

          if (!response.ok) {
            try {
              const json = JSON.parse(text);
              if (json && json.exc_info) {
                stacktraceBlock.textContent = json.exc_info;
                stacktraceContainer.hidden = false;
              }
            } catch (err) {
              // no-op
            }
          } else {
            stacktraceContainer.hidden = true;
            stacktraceBlock.textContent = '';
          }
        })
        .catch((err) => {
          setStatus(`Request failed: ${err.message}`, 'critical');
        });
    });
  </script>
  </body>
</html>

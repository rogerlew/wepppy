{% from "controls/_pure_macros.html" import header_text_field %}
{% set header_mod_options = [
  ('rap_ts', 'RAP Time Series'),
  ('ash', 'Ash Transport'),
  ('treatments', 'Treatments'),
  ('observed', 'Observed Data'),
  ('debris_flow', 'Debris Flow'),
  ('dss_export', 'DSS Export'),
  ('omni', 'Omni'),
  ('path_ce', 'Path CE')
] %}
{% set current_mods = current_ron_mods if current_ron_mods is defined else (current_ron.mods or []) %}
<header class="wc-header wc-run-header wc-run-header--hideaway">
  <div class="wc-container wc-container--fluid">
    <div class="wc-run-header__inner">
      <div class="wc-run-header__title-row">
        <a class="wc-brand" href="{{ url_for('weppcloud_site.index') }}">WEPPcloud</a>
        <a class="wc-run-header__descriptor" href="{{ url_for_run('run_0.runs0', runid=current_ron.runid, config=current_ron.config_stem) }}">
          {{ current_ron.runid }} {{ current_ron.config_stem }}
        </a>
      </div>
      <div class="wc-run-header__content">
        <div class="wc-run-header__fields">
          {{ header_text_field(
            "input_name",
            "Project name",
            value=current_ron.name,
            placeholder="Name",
            attrs={
              "data-project-field": "name"
            },
            extra_class="disable-readonly"
          ) }}
          {{ header_text_field(
            "input_scenario",
            "Scenario",
            value=current_ron.scenario,
            placeholder="Scenario",
            attrs={
              "data-project-field": "scenario"
            },
            extra_class="disable-readonly"
          ) }}
        </div>
        <div class="wc-run-header__actions">
          <a class="pure-button pure-button-secondary"
             href="{{ url_for_run('readme.readme_editor', runid=current_ron.runid, config=current_ron.config_stem) }}"
             target="_blank"
             rel="noopener">
            README
          </a>
          {% if not pup_relpath %}
          <a class="pure-button pure-button-secondary"
             href="{{ url_for_run('fork.rq_fork_console', runid=current_ron.runid, config=current_ron.config_stem) }}"
             target="_blank"
             rel="noopener">
            FORK
          </a>
          <a class="pure-button pure-button-secondary"
             href="{{ url_for_run('archive.rq_archive_dashboard', runid=current_ron.runid, config=current_ron.config_stem) }}"
             target="_blank"
             rel="noopener">
            ARCHIVE
          </a>
          {% endif %}
        </div>
        <div class="wc-run-header__right">
          <div class="wc-run-header__theme">
            {% include 'header/_theme_switcher.htm' %}
          </div>
          <details class="wc-run-header__menu wc-run-header__mods">
            <summary class="wc-run-header__menu-button pure-button pure-button-secondary">
              Mods
            </summary>
            <div class="wc-run-header__menu-content">
              {% for mod_name, mod_label in header_mod_options %}
              <label class="wc-run-header__toggle">
                <input type="checkbox"
                       data-project-mod="{{ mod_name }}"
                       {% if mod_name in current_mods %}checked{% endif %}>
                <span>{{ mod_label }}</span>
              </label>
              {% endfor %}
            </div>
          </details>
        </div>
        <details class="wc-run-header__menu">
          <summary class="wc-run-header__menu-button pure-button pure-button-secondary">
            More
          </summary>
          <div class="wc-run-header__menu-content">
            <button type="button"
                    class="pure-button"
                    data-toggle="modal"
                    data-modal-open="puModal">
              PowerUser
            </button>
            <button type="button"
                    class="pure-button"
                    data-modal-open="unitizerModal">
              Change Units
            </button>
            <button type="button"
                    class="pure-button"
                    data-modal-open="teamModal">
              Manage Team
            </button>
            <label class="wc-run-header__toggle">
              <input id="checkbox_readonly"
                     type="checkbox"
                     data-project-toggle="readonly"
                     {% if current_ron.readonly %}checked{% endif %}>
              <span>Readonly</span>
            </label>
            <label class="wc-run-header__toggle">
              <input id="checkbox_public"
                     type="checkbox"
                     data-project-toggle="public"
                     {% if current_ron.public %}checked{% endif %}>
              <span>Public</span>
            </label>
            {% if user.has_role('Admin') %}
            <a class="pure-button pure-button-secondary"
               href="{{ url_for('admin.view_access_log', runid=current_ron.runid, config=current_ron.config_stem) }}"
               target="_blank"
               rel="noopener">
              Access log
            </a>
            {% endif %}
          </div>
        </details>
      </div>
    </div>
  </div>
</header>
<script>
  "use strict";
  var pup_relpath = {{ current_ron.pup_relpath | tojson }};
  (function () {
    if (!pup_relpath) {
      return;
    }

    function shouldBypass(url) {
      return (
        !url ||
        /^https?:\/\//i.test(url) ||
        url.startsWith("//") ||
        url.indexOf("pup=") !== -1
      );
    }

    function appendPup(url) {
      if (shouldBypass(url)) {
        return url;
      }
      var separator = url.indexOf("?") !== -1 ? "&" : "?";
      return url + separator + "pup=" + encodeURIComponent(pup_relpath);
    }

    if (typeof window.fetch === "function") {
      var originalFetch = window.fetch;
      window.fetch = function patchedFetch(input, init) {
        if (typeof input === "string") {
          return originalFetch.call(this, appendPup(input), init);
        }
        if (typeof Request === "function" && input instanceof Request) {
          var adjusted = appendPup(input.url);
          if (adjusted === input.url) {
            return originalFetch.call(this, input, init);
          }
          return originalFetch.call(this, new Request(adjusted, input), init);
        }
        return originalFetch.call(this, input, init);
      };
    }

    if (typeof XMLHttpRequest !== "undefined") {
      var originalOpen = XMLHttpRequest.prototype.open;
      XMLHttpRequest.prototype.open = function patchedOpen(method, url) {
        var rest = Array.prototype.slice.call(arguments, 2);
        return originalOpen.apply(this, [method, appendPup(url)].concat(rest));
      };
    }

    ensureUnitizerModalHandlers();
  })();

  var __unitizerModalRetryCount = 0;

  function ensureUnitizerModalHandlers() {
    var modal = document.getElementById('unitizerModal');
    var openButtons = document.querySelectorAll('[data-modal-open="unitizerModal"]');

    if (!modal) {
      if (__unitizerModalRetryCount < 20) {
        __unitizerModalRetryCount += 1;
        setTimeout(ensureUnitizerModalHandlers, 50);
      }
      return;
    }

    if (modal.__unitizerHandlersBound) {
      return;
    }

    modal.__unitizerHandlersBound = true;

    if (openButtons.length === 0) {
      return;
    }

    var manager = window.ModalManager;

    function fallbackOpen(targetModal) {
      if (!targetModal.hasAttribute('hidden')) {
        return;
      }
      targetModal.removeAttribute('hidden');
      targetModal.setAttribute('data-modal-open', 'true');
      targetModal.style.display = 'flex';
      document.body.classList.add('wc-modal-open');
      if (!targetModal.classList.contains('is-visible')) {
        targetModal.classList.add('is-visible');
      }
    }

    function fallbackClose(targetModal) {
      if (targetModal.hasAttribute('hidden')) {
        return;
      }
      targetModal.classList.remove('is-visible');
      targetModal.removeAttribute('data-modal-open');
      targetModal.setAttribute('hidden', 'hidden');
      targetModal.style.display = '';
      document.body.classList.remove('wc-modal-open');
    }

    openButtons.forEach(function (button) {
      button.addEventListener('click', function (event) {
        event.preventDefault();
        if (manager && typeof manager.open === 'function') {
          manager.open(modal);
        } else {
          fallbackOpen(modal);
        }
      });
    });

    var dismissButtons = modal.querySelectorAll('[data-modal-dismiss]');
    dismissButtons.forEach(function (button) {
      button.addEventListener('click', function (event) {
        event.preventDefault();
        if (manager && typeof manager.close === 'function') {
          manager.close(modal);
        } else {
          fallbackClose(modal);
        }
      });
    });

    modal.addEventListener('mousedown', function (event) {
      if (event.target !== modal) {
        return;
      }
      if (manager && typeof manager.close === 'function') {
        manager.close(modal);
      } else {
        fallbackClose(modal);
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ensureUnitizerModalHandlers);
  } else {
    ensureUnitizerModalHandlers();
  }

  (function initRunHeaderHideaway() {
    var header = document.querySelector('.wc-run-header--hideaway');
    if (!header) {
      return;
    }

    var lastScroll = window.pageYOffset || document.documentElement.scrollTop || 0;
    var HIDE_DELTA = 6;
    var SHOW_DELTA = 4;
    var SCROLL_THRESHOLD = header.offsetHeight || 72;
    var ticking = false;
    var toc = null;
    function resolveToc() {
      if (toc && toc.isConnected) {
        return toc;
      }
      toc = document.getElementById('toc') || null;
      return toc;
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', resolveToc, { once: true });
    } else {
      resolveToc();
    }
    var resizeScheduled = false;

    function updateHeaderOffset() {
      if (!header) {
        return;
      }
      var height = header.getBoundingClientRect().height || 0;
      document.documentElement.style.setProperty('--wc-run-header-offset', height + 'px');
      SCROLL_THRESHOLD = height || 72;
    }

    updateHeaderOffset();

    window.addEventListener('resize', function () {
      if (resizeScheduled) {
        return;
      }
      resizeScheduled = true;
      var runner = function () {
        resizeScheduled = false;
        updateHeaderOffset();
      };
      if (typeof window.requestAnimationFrame === 'function') {
        window.requestAnimationFrame(runner);
      } else {
        setTimeout(runner, 100);
      }
    });

    function applyState(current) {
      if (current <= 0) {
        header.classList.remove('is-hidden');
        header.classList.remove('is-elevated');
        var tocElTop = resolveToc();
        if (tocElTop) {
          tocElTop.classList.remove('is-header-hidden');
        }
        lastScroll = 0;
        return;
      }

      header.classList.add('is-elevated');

      if (current > lastScroll && current - lastScroll > HIDE_DELTA && current > SCROLL_THRESHOLD) {
        header.classList.add('is-hidden');
        var tocHide = resolveToc();
        if (tocHide) {
          tocHide.classList.add('is-header-hidden');
        }
      } else if (lastScroll - current > SHOW_DELTA) {
        header.classList.remove('is-hidden');
        var tocShow = resolveToc();
        if (tocShow) {
          tocShow.classList.remove('is-header-hidden');
        }
      }

      lastScroll = current;
    }

    function onScroll() {
      var current = window.pageYOffset || document.documentElement.scrollTop || 0;
      applyState(current);
      ticking = false;
    }

    window.addEventListener('scroll', function () {
      if (ticking) {
        return;
      }
      ticking = true;
      if (typeof window.requestAnimationFrame === 'function') {
        window.requestAnimationFrame(onScroll);
      } else {
        setTimeout(onScroll, 50);
      }
    }, { passive: true });
  })();
</script>

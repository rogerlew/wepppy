{# Doc: controllers_js/README.md — Treatments Controller Reference (2025 helper migration) #}
{% import "controls/_pure_macros.html" as ui %}
{% from "shared/console_macros.htm" import button_row %}

{% set current_mode = treatments.mode.value if treatments.mode is not none else -1 %}

{% set description %}
  <p class="wc-text-muted">
    Treatments are optional. When applied, they modify the current landuse and burn severity conditions before
    WEPP runs. Choose between assigning treatments to specific hillslopes or uploading a raster map that encodes
    treatment classes.
  </p>
{% endset %}

{% set treatment_mode_options = [
  {
    "id": "treatments_mode1",
    "label": "Specify Hillslopes",
    "value": "1",
    "selected": current_mode == 1,
    "attrs": {
      "class": "disable-readonly",
      "data-treatments-role": "mode",
      "data-treatments-mode": "1"
    }
  },
  {
    "id": "treatments_mode4",
    "label": "Upload Treatment Map",
    "value": "4",
    "selected": current_mode == 4,
    "attrs": {
      "class": "disable-readonly",
      "data-treatments-role": "mode",
      "data-treatments-mode": "4"
    }
  }
] %}

{% set treatment_select_options = [] %}
{% for opt in treatmentoptions %}
  {% set treatment_select_options = treatment_select_options + [(opt['Key'], opt['Key'] ~ ' — ' ~ opt['Description'])] %}
{% endfor %}

{% call ui.control_shell(
     form_id="treatments_form",
     title="Treatments",
     description=description,
     collapsible=True,
     open=False,
     form_attrs={"data-treatments-form": true},
      status_panel_options={"id": "treatments_status_panel", "height": "4rem"},
     summary_panel_override=ui.legacy_summary_panel(),
     stacktrace_panel_override=ui.stacktrace_panel(
       id="treatments_stacktrace_panel",
       summary="Details",
       collapsed=True,
       body_id="stacktrace",
       empty_state="No stack trace recorded."
     )
   ) %}

  {{ ui.radio_group(
       "treatments_mode",
       label="Application mode",
       layout="horizontal",
       options=treatment_mode_options,
       help="Switch modes to assign treatments directly or upload a treated landcover map."
     ) }}

  {% set mode1_style = '' if current_mode == 1 else 'display: none;' %}
  <div id="treatments_mode1_controls"
       class="wc-stack hide-readonly"
       data-treatments-panel="selection"
       {% if mode1_style %}style="{{ mode1_style }}"{% endif %}>
    {{ ui.select_field(
         "treatments_single_selection",
         label="Select treatment",
         options=treatment_select_options,
         selected=treatment_select_options[0][0] if treatment_select_options else None,
         attrs={"class": "disable-readonly", "data-treatments-role": "selection"},
         help="Apply the selected treatment to the highlighted hillslopes."
       ) }}
  </div>

  {% set mode4_style = '' if current_mode == 4 else 'display: none;' %}
  <div id="treatments_mode4_controls"
       class="wc-stack hide-readonly"
       data-treatments-panel="upload"
       {% if mode4_style %}style="{{ mode4_style }}"{% endif %}>
    {{ ui.file_upload(
         "input_upload_landuse",
         label="Treatment map (.tif or .img)",
         accept=".tif,.img",
         help="Raster should encode treatment class keys; it will be aligned to the watershed automatically.",
         attrs={"class": "disable-readonly", "data-treatments-role": "upload"}
       ) }}

    <div class="wc-stack">
      {% call ui.collapsible_card(
           title="Valid treatment classes",
           expanded=False,
           card_id="treatments_valid_classes"
         ) %}
        <div class="wc-summary-pane">
          <dl class="wc-summary-pane__list">
            {% for disturbed_class, class_value in treatments.treatments_lookup.items() %}
            <div class="wc-summary-pane__item">
              <dt class="wc-summary-pane__term">{{ disturbed_class }}</dt>
              <dd class="wc-summary-pane__definition">{{ class_value }}</dd>
            </div>
            {% endfor %}
          </dl>
        </div>
        <p class="wc-field__help">
          Use these values when preparing your raster. Non-treatment values are ignored during processing.
        </p>
      {% endcall %}
    </div>
  </div>

  {% call button_row() %}
    <button
      id="btn_build_treatments"
      type="button"
      class="pure-button pure-button-primary disable-readonly"
      data-treatments-action="build">
      <img
        id="build_treatments_lock"
        src="{{ url_for('static', filename='open-iconic/png/lock-locked-2x.png') }}"
        alt=""
        style="display:none;">
      <span>Build Treatments</span>
    </button>
  {% endcall %}

  {{ ui.job_hint(
       "hint_build_treatments",
       extra_class="wc-field__help",
       attrs={"data-treatments-role": "hint"}
     ) }}

{% endcall %}

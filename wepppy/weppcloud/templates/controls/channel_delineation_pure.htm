{% import "controls/_pure_macros.html" as ui %}
{% from "shared/console_macros.htm" import button_row %}

{% call ui.control_shell(
     form_id="build_channels_form",
     title="Channel Delineation",
     collapsible=True
   ) %}

  <input type="hidden" id="map_center" name="map_center">
  <input type="hidden" id="map_zoom" name="map_zoom">
  <input type="hidden" id="map_bounds" name="map_bounds">
  <input type="hidden" id="map_distance" name="map_distance">

  <div class="wc-stack">
    {{ ui.radio_group(
         "set_extent_mode",
         label="Extent mode",
         layout="horizontal",
         options=[
           {
             "id": "set_extent_mode_map",
             "label": "Use map extent",
             "value": "0",
             "selected": watershed.set_extent_mode == 0,
             "attrs": {"class": "disable-readonly", "data-channel-role": "extent-mode"}
           },
           {
             "id": "set_extent_mode_manual",
             "label": "Specify extent",
             "value": "1",
             "selected": watershed.set_extent_mode == 1,
             "attrs": {"class": "disable-readonly", "data-channel-role": "extent-mode"}
           },
           {
             "id": "set_extent_mode_map_object",
             "label": "Set Map Object",
             "value": "2",
             "selected": watershed.set_extent_mode == 2,
             "attrs": {"class": "disable-readonly", "data-channel-role": "extent-mode"}
           }
         ]
       ) }}

    <div id="map_bounds_text_group" style="display: none;">
      {{ ui.text_field(
           "map_bounds_text",
           "Manual extent (south, west, north, east)",
           value=watershed.map_bounds_text,
           placeholder="-122.52, 44.16, -122.41, 44.23",
           attrs={"aria-label": "south, west, north, east"},
           extra_control_class="disable-readonly"
      ) }}
    </div>

    <div id="map_object_group" style="display: none;">
      <p class="wc-field__help">
        Paste the <code>_map</code> JSON from the source run's <code>ron.nodb</code> to reuse the exact grid (extent, center, zoom, UTM, dimensions) used for delineation.
      </p>
      {{ ui.textarea_field(
           "map_object",
           "Map object JSON",
           value=map_object_json | default(''),
           rows=10,
           placeholder='{"py/object": "wepppy.nodb.ron.Map", "extent": [...], "center": [...], "zoom": 11, "cellsize": 30}',
           attrs={"aria-label": "Serialized Map object JSON", "style": "font-family: var(--wc-font-mono, monospace);"},
           extra_control_class="disable-readonly",
           max_width="100%"
      ) }}
    </div>
  </div>

  <div class="wc-stack">
    {% if watershed.delineation_backend_is_topaz or watershed.delineation_backend_is_wbt %}
      {{ ui.unitized_numeric_group(
           metric={
             'unit_class': 'units-m',
             'fields': [
               {
                 'id': 'input_mcl',
                 'label': 'Minimum channel length',
                 'unit_label': 'm',
                 'value': watershed.mcl | round | int,
                 'help': 'Recommended to use default value.',
                 'extra_control_class': 'disable-readonly',
                 'attrs': {
                 'data-convert-target': '#input_mcl_en',
                 'data-convert-func': 'm_to_ft',
                 'data-convert-decimals': '2'
               },
               'precision': '0.01'
             }
           ]
         },
           imperial={
             'unit_class': 'units-ft',
             'fields': [
               {
                 'id': 'input_mcl_en',
                 'label': 'Minimum channel length',
                 'unit_label': 'ft',
                 'value': (watershed.mcl * 3.28084) | round | int,
                 'help': 'Recommended to use default value.',
                 'extra_control_class': 'disable-readonly',
                 'attrs': {
                 'data-convert-target': '#input_mcl',
                 'data-convert-func': 'ft_to_m',
                 'data-convert-decimals': '2'
               },
                 'precision': '0.01'
               }
             ]
           }
      ) }}
      {{ ui.unitized_numeric_group(
           metric={
             'unit_class': 'units-ha',
             'fields': [
               {
                 'id': 'input_csa',
                 'label': 'Critical source area',
                 'unit_label': 'ha',
                 'value': watershed.csa | round | int,
                 'help': 'The minimum drainage area below which a permanent channel forms.',
                 'extra_control_class': 'disable-readonly',
                 'attrs': {
                 'data-convert-target': '#input_csa_en',
                 'data-convert-func': 'ha_to_ac',
                 'data-convert-decimals': '2'
               },
                 'precision': '0.01'
               }
             ]
           },
           imperial={
             'unit_class': 'units-acre',
             'fields': [
               {
                 'id': 'input_csa_en',
                 'label': 'Critical source area',
                 'unit_label': 'acre',
                 'value': (watershed.csa * 2.47105) | round | int,
                 'help': 'The minimum drainage area below which a permanent channel forms.',
                 'extra_control_class': 'disable-readonly',
                 'attrs': {
                 'data-convert-target': '#input_csa',
                 'data-convert-func': 'ac_to_ha',
                 'data-convert-decimals': '2'
               },
                 'precision': '0.01'
               }
             ]
           }
      ) }}
    {% else %}
      <input type="hidden" id="input_mcl" value="-1" name="mcl">
      <input type="hidden" id="input_mcl_en" value="-1" name="mcl_en">
      {{ ui.unitized_numeric_group(
           metric={
             'unit_class': 'units-ha',
             'fields': [
               {
                 'id': 'input_csa',
                'label': 'Critical source area',
                'unit_label': 'ha',
                'value': watershed.pkcsa,
               'help': 'The minimum drainage area below which a permanent channel forms.',
                 'extra_control_class': 'disable-readonly',
                 'precision': '0.01'
               }
             ]
           },
           imperial={
             'unit_class': 'units-acre',
             'fields': [
               {
                 'id': 'input_csa_en',
                'label': 'Critical source area',
                'unit_label': 'acre',
                'value': watershed.pkcsa,
               'help': 'The minimum drainage area below which a permanent channel forms.',
                 'extra_control_class': 'disable-readonly',
                 'precision': '0.01'
               }
             ]
           }
      ) }}
    {% endif %}
  </div>

  {% if watershed.delineation_backend_is_wbt %}
  <div class="wc-stack">
    {{ ui.select_field(
         "input_wbt_fill_or_breach",
         "Depression smoothing algorithm",
         [
           ("fill", "Fill"),
           ("breach", "Breach"),
           ("breach_least_cost", "Breach (Least Cost)")
         ],
         selected=watershed.wbt_fill_or_breach,
         help="Specify whether the DEM should be filled or breached before channel extraction.",
         attrs={"data-channel-role": "wbt-fill"},
         extra_control_class="disable-readonly"
    ) }}

    <div id="wbt_blc_dist_container">
      {{ ui.numeric_field(
           'wbt_blc_dist',
           'Breach least cost distance',
           value=watershed.wbt_blc_dist,
           unit_label='m',
           help='Recommended to use default value.',
           extra_control_class='disable-readonly',
           precision='0.01'
      ) }}
    </div>
  </div>
  {% endif %}

  <div class="wc-stack hide-readonly">
    {% call button_row() %}
      <button
        id="btn_build_channels_en"
        class="pure-button pure-button-primary"
        type="button"
        data-channel-action="build">
        <img
        id="build_channels_en_lock"
        src="{{ url_for('static', filename='open-iconic/png/lock-locked-2x.png') }}"
        alt=""
        style="display:none; margin-right: var(--wc-space-xs);">
        Build Channels
      </button>
    {% endcall %}
    {{ ui.job_hint("hint_build_channels_en") }}
  </div>

{% endcall %}

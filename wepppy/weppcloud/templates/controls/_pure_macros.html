{# NOTE:
   - control_shell, status_panel, and stacktrace_panel all rely on Jinja's
     `caller` to inject child content. When invoking these macros, prefer the
     `{% call ... %}{% endcall %}` pattern and avoid nesting them inside other
     macros that also consume `caller` (doing so will raise a double-caller
     TypeError at render time).
#}

{# Status/Summary/Stacktrace overrides exist but should be rareâ€”only use when the
   standard panels cannot express the special case. Excess overrides make the
   macros pointless and harder to maintain. #}
{% macro control_shell(
      form_id,
      title,
      toolbar=None,
      description=None,
      meta=None,
      collapsible=True,
      open=True,
      form_class=None,
      form_attrs=None,
      status_panel_override=None,
      status_panel_options=None,
      summary_panel_override=None,
      summary_panel_options=None,
      stacktrace_panel_override=None,
      stacktrace_panel_options=None
    ) -%}
{% if collapsible %}
<details class="wc-control wc-control--collapsible"{% if open %} open{% endif %}>
  <summary class="wc-control__summary">
    <div class="wc-control__summary-text">
      <h2 class="wc-control__title">{{ title }}</h2>
      {% if meta %}
      <div class="wc-control__meta">
        {{ meta|safe }}
      </div>
      {% endif %}
    </div>
    <span class="wc-control__summary-icon" aria-hidden="true"></span>
  </summary>
{% else %}
<div class="wc-control wc-control--static">
  <div class="wc-control__summary wc-control__summary--static">
    <div class="wc-control__summary-text">
      <h2 class="wc-control__title">{{ title }}</h2>
      {% if meta %}
      <div class="wc-control__meta">
        {{ meta|safe }}
      </div>
      {% endif %}
    </div>
  </div>
{% endif %}
  <form id="{{ form_id }}"
        class="wc-control__form pure-form{% if form_class %} {{ form_class }}{% endif %}"
        action="javascript:void(0);"
        enctype="multipart/form-data"
        {% if form_attrs %}
          {% for attr_key, attr_val in form_attrs.items() %}
            {% if attr_val is true or attr_val is none or attr_val == '' %}
              {{ attr_key }}
            {% else %}
              {{ attr_key }}="{{ attr_val }}"
            {% endif %}
          {% endfor %}
        {% endif %}>
    {% if description or toolbar %}
    <header class="wc-control__header">
      {% if description %}
      <div class="wc-control__description">
        {{ description|safe }}
      </div>
      {% endif %}
      {% if toolbar %}
      <div class="wc-control__toolbar">
        {{ toolbar|safe }}
      </div>
      {% endif %}
    </header>
    {% endif %}
    {% set panel_blocks = [] %}
    {% set status_opts = status_panel_options or {} %}
    {% if status_panel_override is not none %}
      {% set panel_blocks = panel_blocks + [status_panel_override|safe] %}
    {% else %}
      {% set status_panel_id = status_opts.get('id', form_id ~ '_status_panel') %}
      {% set status_panel_job_id = status_opts.get('job_id', 'rq_job') %}
      {% set status_panel_braille_id = status_opts.get('braille_id', 'braille') %}
      {% set status_panel_log_id = status_opts.get('log_id', 'status') %}
      {% set status_panel_height = status_opts.get('height') %}
      {% set status_panel_variant = status_opts.get('variant', 'compact') %}
      {% set status_panel_title = status_opts.get('title', 'Status') %}
      {% set status_panel_meta = status_opts.get('meta') %}
      {% set status_panel_description = status_opts.get('description') %}
      {% set status_panel_actions = status_opts.get('actions') %}
      {% set status_panel_footer = status_opts.get('footer') %}
      {% set status_panel_initial = status_opts.get('initial') %}
      {% set panel_blocks = panel_blocks + [legacy_status_panel(
        panel_id=status_panel_id,
        job_id=status_panel_job_id,
        braille_id=status_panel_braille_id,
        status_id=status_panel_log_id,
        title=status_panel_title,
        variant=status_panel_variant,
        height=status_panel_height,
        initial=status_panel_initial,
        meta=status_panel_meta,
        description=status_panel_description,
        actions=status_panel_actions,
        footer=status_panel_footer
      )] %}
    {% endif %}
    {% set summary_opts = summary_panel_options or {} %}
    {% if summary_panel_override is not none %}
      {% set panel_blocks = panel_blocks + [summary_panel_override|safe] %}
    {% else %}
      {% set panel_blocks = panel_blocks + [legacy_summary_panel(
        panel_id=summary_opts.get('panel_id'),
        summary_id=summary_opts.get('summary_id', 'info'),
        title=summary_opts.get('title', 'Summary'),
        body_html=summary_opts.get('body_html')
      )] %}
    {% endif %}
    {% set stacktrace_opts = stacktrace_panel_options or {} %}
    {% if stacktrace_panel_override is not none %}
      {% set panel_blocks = panel_blocks + [stacktrace_panel_override|safe] %}
    {% else %}
      {% set panel_blocks = panel_blocks + [legacy_stacktrace_panel(
        panel_id=stacktrace_opts.get('panel_id'),
        title=stacktrace_opts.get('title', 'Details'),
        description=stacktrace_opts.get('description'),
        body_id=stacktrace_opts.get('body_id', 'stacktrace'),
        collapsed=stacktrace_opts.get('collapsed', True),
        empty_state=stacktrace_opts.get('empty_state', 'No stack trace recorded.')
      )] %}
    {% endif %}
    {% set joined_panels = ''.join(panel_blocks) %}
    {% set has_panels = joined_panels|trim|length > 0 %}
    <div class="wc-control__grid">
      <section class="wc-control__inputs">
        {{ caller() }}
      </section>
      {% if has_panels %}
      <section class="wc-control__panels">
        {{ joined_panels | safe }}
      </section>
      {% endif %}
    </div>
  </form>
{% if collapsible %}
</details>
{% else %}
</div>
{% endif %}
{%- endmacro %}

{%- macro status_panel(
      id=None,
      title="Status",
      variant="compact",
      meta=None,
      description=None,
      actions=None,
      footer=None,
      log_id=None,
      aria_live="polite",
      initial=None,
      height=None
    ) -%}
{% set panel_id = id %}
{% set resolved_log_id = log_id if log_id is not none else (id ~ "_log" if id else None) %}
{% set style_tokens = [] %}
{% if height %}
  {% set style_tokens = style_tokens + ['--wc-status-height: ' ~ height ~ ';', '--wc-status-min-height: ' ~ height ~ ';'] %}
{% endif %}
<section class="wc-status-panel"
         data-status-panel
         data-variant="{{ variant }}"
         {% if panel_id %}id="{{ panel_id }}"{% endif %}
         {% if resolved_log_id %}data-status-target="{{ resolved_log_id }}"{% endif %}
         {% if style_tokens %}style="{{ ' '.join(style_tokens) }}"{% endif %}>
  {% if title or actions %}
  <header class="wc-status-panel__header">
    {% if title %}
    <h3 class="wc-status-panel__title">{{ title }}</h3>
    {% endif %}
    {% if actions %}
    <div class="wc-status-panel__actions">
      {{ actions|safe }}
    </div>
    {% endif %}
  </header>
  {% endif %}
  {% if description %}
  <p class="wc-status-panel__description">{{ description|safe }}</p>
  {% endif %}
  {% if meta %}
  <div class="wc-status-panel__meta">
    {{ meta|safe }}
  </div>
  {% endif %}
  {% if caller is defined %}
  <div class="wc-status-panel__slot">
    {{ caller() }}
  </div>
  {% endif %}
  <div class="wc-status-panel__log"
       {% if resolved_log_id %}id="{{ resolved_log_id }}"{% endif %}
       data-status-log
       role="log"
       aria-live="{{ aria_live }}"
       aria-atomic="false">
    {% if initial %}
      {{ initial }}
    {% endif %}
  </div>
  {% if footer %}
  <footer class="wc-status-panel__footer">
    {{ footer|safe }}
  </footer>
  {% endif %}
</section>
{%- endmacro %}

{%- macro stacktrace_panel(
      id=None,
      summary="Stack trace",
      collapsed=True,
      description=None,
      actions=None,
      body_id=None,
      empty_state=None
    ) -%}
<details class="wc-stacktrace"
         data-stacktrace-panel
         {% if id %}id="{{ id }}"{% endif %}
         {% if not collapsed %} open{% endif %}>
  <summary class="wc-stacktrace__summary">
    <span class="wc-stacktrace__summary-text">{{ summary }}</span>
    {% if actions %}
    <span class="wc-stacktrace__actions">
      {{ actions|safe }}
    </span>
    {% endif %}
  </summary>
  {% if description %}
  <p class="wc-stacktrace__description">
    {{ description|safe }}
  </p>
  {% endif %}
  <pre class="wc-stacktrace__body"
       data-stacktrace-body
       tabindex="0"
       {% if body_id %}id="{{ body_id }}"{% endif %}>{{ (empty_state or '') | trim }}</pre>
</details>
{%- endmacro %}

{%- macro job_hint(
      hint_id,
      tag="p",
      extra_class=None,
      attrs=None,
      aria_live="polite"
    ) -%}
{% set class_tokens = ['wc-job-hint', 'wc-text-muted'] %}
{% if extra_class %}
  {% for token in extra_class.split() %}
    {% if token %}
      {% set class_tokens = class_tokens + [token] %}
    {% endif %}
  {% endfor %}
{% endif %}
{% set attrs = attrs.copy() if attrs else {} %}
<{{ tag }}
  id="{{ hint_id }}"
  class="{{ ' '.join(class_tokens) }}"
  aria-live="{{ aria_live }}"
  data-job-hint
  {% for attr_key, attr_val in attrs.items() %}
    {% if attr_val is true or attr_val is none or attr_val == '' %}
      {{ attr_key }}
    {% else %}
      {{ attr_key }}="{{ attr_val }}"
    {% endif %}
  {% endfor %}></{{ tag }}>
{%- endmacro %}

{% macro legacy_status_panel(
      panel_id=None,
      job_id="rq_job",
      braille_id="braille",
      status_id="status",
      title="Status",
      variant="compact",
      height=None,
      initial=None,
      meta=None,
      description=None,
      actions=None,
      footer=None
    ) -%}
{% call status_panel(
     id=panel_id,
     title=title,
     variant=variant,
     log_id=status_id,
     initial=initial,
     meta=meta,
     description=description,
     actions=actions,
     footer=footer,
     height=height
   ) %}
  <div id="{{ job_id }}" class="wc-status-panel__meta" aria-live="polite"></div>
  <span id="{{ braille_id }}" class="wc-status-panel__meta" aria-hidden="true"></span>
{% endcall %}
{%- endmacro %}

{% macro legacy_summary_panel(panel_id=None, summary_id="info", title="Summary", body_html=None) -%}
<section class="wc-control__panel"{% if panel_id %} id="{{ panel_id }}"{% endif %}>
  <h3 class="wc-control__panel-title">{{ title }}</h3>
  {% if body_html %}
    {{ body_html | safe }}
  {% else %}
  <div id="{{ summary_id }}" class="wc-control__panel-summary"></div>
  {% endif %}
</section>
{%- endmacro %}

{% macro legacy_stacktrace_panel(
      panel_id=None,
      title="Details",
      description=None,
      body_id="stacktrace",
      collapsed=True,
      empty_state="No stack trace recorded."
    ) -%}
{{ stacktrace_panel(
     id=panel_id,
     summary=title,
     description=description,
     collapsed=collapsed,
     body_id=body_id,
     empty_state=empty_state
   ) }}
{%- endmacro %}

{% macro fieldset(legend=None, description=None) -%}
<fieldset class="wc-fieldset">
  {% if legend %}
  <legend class="wc-fieldset__legend">{{ legend }}</legend>
  {% endif %}
  {% if description %}
  <p class="wc-fieldset__description">{{ description }}</p>
  {% endif %}
  {{ caller() }}
</fieldset>
{%- endmacro %}

{% macro collapsible_card(title, description=None, expanded=False, card_id=None, attrs=None) -%}
{% set attrs = attrs.copy() if attrs else {} %}
<details class="wc-collapse"
         {% if card_id %}id="{{ card_id }}"{% endif %}
         {% for attr_key, attr_val in attrs.items() %}
           {{ attr_key }}="{{ attr_val }}"
         {% endfor %}
         {% if expanded %} open{% endif %}>
  <summary class="wc-collapse__summary">
    <span class="wc-collapse__title">{{ title }}</span>
    <span class="wc-collapse__icon" aria-hidden="true"></span>
  </summary>
  {% if description %}
  <p class="wc-collapse__description">{{ description }}</p>
  {% endif %}
  <div class="wc-collapse__content">
    {{ caller() }}
  </div>
</details>
{%- endmacro %}

{% macro card(title, description=None, meta=None, footer=None, classes=None, body_class='wc-stack', attrs=None) -%}
{% set class_tokens = ['wc-card'] %}
{% if classes %}
  {% for token in classes.split() %}
    {% if token %}
      {% set class_tokens = class_tokens + [token] %}
    {% endif %}
  {% endfor %}
{% endif %}
{% set attrs = attrs.copy() if attrs else {} %}
<section class="{{ ' '.join(class_tokens) }}"
         {% for attr_key, attr_val in attrs.items() %}
           {% if attr_val is true or attr_val is none or attr_val == '' %}
             {{ attr_key }}
           {% else %}
             {{ attr_key }}="{{ attr_val }}"
           {% endif %}
         {% endfor %}>
  <header class="wc-card__header">
    <h3 class="wc-card__title">{{ title }}</h3>
    {% if meta %}
    <div class="wc-card__meta">{{ meta|safe }}</div>
    {% endif %}
  </header>
  {% if description %}
  <p class="wc-card__description">{{ description|safe }}</p>
  {% endif %}
  <div class="wc-card__body{% if body_class %} {{ body_class }}{% endif %}">
    {{ caller() }}
  </div>
  {% if footer %}
  <footer class="wc-card__footer">
    {{ footer|safe }}
  </footer>
  {% endif %}
</section>
{%- endmacro %}

{% macro tabset(tabs) -%}
{% set tabs = tabs or [] %}
{% if tabs %}
  {% set active_candidates = tabs | selectattr('active') | list %}
  {% if active_candidates %}
    {% set active_tab = active_candidates[0].id %}
  {% else %}
    {% set active_tab = tabs[0].id %}
  {% endif %}
  <div class="wc-tabs" data-tabset>
    <div class="wc-tabs__nav" role="tablist">
      {% for tab in tabs %}
        {% set is_active = (tab.id == active_tab) %}
        {% set panel_id = tab.id %}
        {% set tab_id = tab.id ~ "_tab" %}
        <button
          id="{{ tab_id }}"
          class="wc-tabs__tab{% if is_active %} is-active{% endif %}"
          type="button"
          role="tab"
          data-tab-target="{{ panel_id }}"
          aria-controls="{{ panel_id }}"
          aria-selected="{{ 'true' if is_active else 'false' }}"
          tabindex="{{ '0' if is_active else '-1' }}">
          {% if tab.icon %}
          <span class="wc-tabs__icon" aria-hidden="true">{{ tab.icon|safe }}</span>
          {% endif %}
          {% if tab.label %}
          <span class="wc-tabs__label">{{ tab.label }}</span>
          {% endif %}
        </button>
      {% endfor %}
    </div>
    <div class="wc-tabs__panels">
      {% for tab in tabs %}
        {% set is_active = (tab.id == active_tab) %}
        <section
          id="{{ tab.id }}"
          class="wc-tabs__panel{% if is_active %} is-active{% endif %}"
          role="tabpanel"
          aria-labelledby="{{ tab.id ~ '_tab' }}"
          {% if not is_active %}hidden{% endif %}>
          {{ tab.content|default('', true)|safe }}
        </section>
      {% endfor %}
    </div>
  </div>
{% endif %}
{%- endmacro %}

{% macro text_field(field_id, label, value='', help=None, type='text', placeholder=None, attrs=None, error=None, extra_control_class=None) -%}
{% set attrs = attrs.copy() if attrs else {} %}
{% set help_id = field_id ~ "_help" %}
{% set error_id = field_id ~ "_error" %}
{% set describedby = [] %}
{% if attrs.get('aria-describedby') %}
  {% set describedby = describedby + [attrs.pop('aria-describedby')] %}
{% endif %}
{% if help %}
  {% set describedby = describedby + [help_id] %}
{% endif %}
{% if error %}
  {% set describedby = describedby + [error_id] %}
{% endif %}
{% set field_classes = ['wc-field'] %}
{% if error %}
  {% set field_classes = field_classes + ['wc-field--error'] %}
{% endif %}
{% set control_classes = ['wc-field__control'] %}
{% if extra_control_class %}
  {% set control_classes = control_classes + [extra_control_class] %}
{% endif %}
<div class="{{ ' '.join(field_classes) }}" style="max-width: 650px;">
  <label class="wc-field__label" for="{{ field_id }}">{{ label }}</label>
  <input class="{{ ' '.join(control_classes) }}"
         id="{{ field_id }}"
         name="{{ field_id }}"
         type="{{ type }}"
         value="{{ value }}"
         {% if placeholder %}placeholder="{{ placeholder }}"{% endif %}
         {% if error %}aria-invalid="true"{% endif %}
         {% if describedby %}aria-describedby="{{ ' '.join(describedby) }}"{% endif %}
         {% for attr_key, attr_val in attrs.items() %}
           {{ attr_key }}="{{ attr_val }}"
         {% endfor %}>
  {% if help %}
  <p id="{{ help_id }}" class="wc-field__help">{{ help }}</p>
  {% endif %}
  {% if error %}
  <p id="{{ error_id }}" class="wc-field__message wc-field__message--error" role="alert">{{ error }}</p>
  {% endif %}
</div>
{%- endmacro %}

{% macro select_field(field_id, label, options, selected=None, help=None, attrs=None, error=None, extra_control_class=None) -%}
{% set attrs = attrs.copy() if attrs else {} %}
{% set help_id = field_id ~ "_help" %}
{% set error_id = field_id ~ "_error" %}
{% set describedby = [] %}
{% if attrs.get('aria-describedby') %}
  {% set describedby = describedby + [attrs.pop('aria-describedby')] %}
{% endif %}
{% if help %}
  {% set describedby = describedby + [help_id] %}
{% endif %}
{% if error %}
  {% set describedby = describedby + [error_id] %}
{% endif %}
{% set field_classes = ['wc-field'] %}
{% if error %}
  {% set field_classes = field_classes + ['wc-field--error'] %}
{% endif %}
{% set control_classes = ['wc-field__control'] %}
{% if extra_control_class %}
  {% set control_classes = control_classes + [extra_control_class] %}
{% endif %}
<div class="{{ ' '.join(field_classes) }}" style="max-width: 650px;">
  <label class="wc-field__label" for="{{ field_id }}">{{ label }}</label>
  <select class="{{ ' '.join(control_classes) }}"
          id="{{ field_id }}"
          name="{{ field_id }}"
          {% if error %}aria-invalid="true"{% endif %}
          {% if describedby %}aria-describedby="{{ ' '.join(describedby) }}"{% endif %}
          {% for attr_key, attr_val in attrs.items() %}
            {{ attr_key }}="{{ attr_val }}"
          {% endfor %}>
    {% for value, text in options %}
    <option value="{{ value }}"{% if value == selected %} selected{% endif %}>{{ text }}</option>
    {% endfor %}
  </select>
  {% if help %}
  <p id="{{ help_id }}" class="wc-field__help">{{ help }}</p>
  {% endif %}
  {% if error %}
  <p id="{{ error_id }}" class="wc-field__message wc-field__message--error" role="alert">{{ error }}</p>
  {% endif %}
</div>
{%- endmacro %}

{% macro header_text_field(field_id, label, value='', help=None, placeholder=None, attrs=None, extra_class=None) -%}
{% set attrs = attrs or {} %}
<label class="wc-run-header__field">
  <span>{{ label }}</span>
  <input class="wc-run-header__input{% if extra_class %} {{ extra_class }}{% endif %}"
         id="{{ field_id }}"
         name="{{ field_id }}"
         type="text"
         value="{{ value }}"
         {% if placeholder %}placeholder="{{ placeholder }}"{% endif %}
         {% for attr_key, attr_val in attrs.items() %}
           {{ attr_key }}="{{ attr_val }}"
         {% endfor %}>
  {% if help %}
  <small class="wc-field__help">{{ help }}</small>
  {% endif %}
</label>
{%- endmacro %}

{% macro numeric_field(field_id, label, value='', unit_label=None, help=None, precision=None, min=None, max=None, required=False, nullable=False, attrs=None, error=None, unit_category=None, unit_name=None, extra_control_class=None, field_extra_class=None, max_width='650px') -%}
{% set attrs = attrs.copy() if attrs else {} %}
{% set help_id = field_id ~ "_help" %}
{% set error_id = field_id ~ "_error" %}
{% set describedby = [] %}
{% if attrs.get('aria-describedby') %}
  {% set describedby = describedby + [attrs.pop('aria-describedby')] %}
{% endif %}
{% if help %}
  {% set describedby = describedby + [help_id] %}
{% endif %}
{% if error %}
  {% set describedby = describedby + [error_id] %}
{% endif %}
{% set field_classes = ['wc-field'] %}
{% if error %}
  {% set field_classes = field_classes + ['wc-field--error'] %}
{% endif %}
{% if field_extra_class %}
  {% for cls in field_extra_class.split() %}
    {% if cls %}
      {% set field_classes = field_classes + [cls] %}
    {% endif %}
  {% endfor %}
{% endif %}
{% set control_classes = ['wc-field__control', 'wc-field__control--number'] %}
{% if extra_control_class %}
  {% for cls in extra_control_class.split() %}
    {% if cls %}
      {% set control_classes = control_classes + [cls] %}
    {% endif %}
  {% endfor %}
{% endif %}
{% if attrs.pop('class', None) %}
  {# external class overrides are discouraged; use extra_control_class instead #}
{% endif %}
<div class="{{ ' '.join(field_classes) }}"
     style="max-width: {{ max_width }};"
     {% if unit_category %}data-unitizer-category="{{ unit_category }}"{% endif %}>
  <label class="wc-field__label" for="{{ field_id }}">{{ label }}</label>
  <div class="wc-field__input-row">
    <input class="{{ ' '.join(control_classes) }}"
           id="{{ field_id }}"
           name="{{ field_id }}"
           type="number"
            value="{{ value }}"
           {% if precision is not none %}step="{{ precision }}"{% endif %}
           {% if precision is not none %}data-precision="{{ precision }}"{% endif %}
           {% if min is not none %}min="{{ min }}"{% endif %}
           {% if max is not none %}max="{{ max }}"{% endif %}
           {% if required %}required{% endif %}
           {% if nullable %}data-nullable="true"{% endif %}
           {% if error %}aria-invalid="true"{% endif %}
           {% if describedby %}aria-describedby="{{ ' '.join(describedby) }}"{% endif %}
           {% if unit_category %}data-unitizer-category="{{ unit_category }}"{% endif %}
           {% if unit_name %}data-unitizer-unit="{{ unit_name }}"{% endif %}
           {% for attr_key, attr_val in attrs.items() %}
             {{ attr_key }}="{{ attr_val }}"
           {% endfor %}>
    {% if unit_label %}
    <span class="wc-field__unit"
          data-unitizer-label
          {% if unit_category %}data-unitizer-category="{{ unit_category }}"{% endif %}
          {% if unit_name %}data-unitizer-unit="{{ unit_name }}"{% endif %}>
      {{ unit_label }}
    </span>
    {% endif %}
  </div>
  {% if help %}
  <p id="{{ help_id }}" class="wc-field__help">{{ help }}</p>
  {% endif %}
{% if error %}
  <p id="{{ error_id }}" class="wc-field__message wc-field__message--error" role="alert">{{ error }}</p>
{% endif %}
</div>
{%- endmacro %}

{% macro unitized_numeric_group(metric, imperial, wrapper_extra_class=None) -%}
{% set metric_fields = metric.get('fields', []) if metric else [] %}
{% set imperial_fields = imperial.get('fields', []) if imperial else [] %}
{% if metric_fields or imperial_fields %}
<div class="unitizer-wrapper{% if wrapper_extra_class %} {{ wrapper_extra_class }}{% endif %}">
  {% if metric_fields %}
  <div class="unitizer {{ metric.get('unit_class', 'units-m') }}">
    <div class="wc-stack">
      {% for field in metric_fields %}
        {% set attrs = field.get('attrs') or {} %}
        {{ numeric_field(
             field.get('id'),
             field.get('label'),
             value=field.get('value', ''),
             unit_label=field.get('unit_label'),
             help=field.get('help'),
             precision=field.get('precision'),
             min=field.get('min'),
             max=field.get('max'),
             required=field.get('required', False),
             nullable=field.get('nullable', False),
             attrs=attrs,
             error=field.get('error'),
             unit_category=field.get('unit_category'),
             unit_name=field.get('unit_name'),
             extra_control_class=field.get('extra_control_class'),
             field_extra_class=field.get('field_extra_class'),
             max_width=field.get('max_width', '650px')
        ) }}
      {% endfor %}
    </div>
  </div>
  {% endif %}
  {% if imperial_fields %}
  <div class="unitizer {{ imperial.get('unit_class', 'units-ft') }}">
    <div class="wc-stack">
      {% for field in imperial_fields %}
        {% set attrs = field.get('attrs') or {} %}
        {{ numeric_field(
             field.get('id'),
             field.get('label'),
             value=field.get('value', ''),
             unit_label=field.get('unit_label'),
             help=field.get('help'),
             precision=field.get('precision'),
             min=field.get('min'),
             max=field.get('max'),
             required=field.get('required', False),
             nullable=field.get('nullable', False),
             attrs=attrs,
             error=field.get('error'),
             unit_category=field.get('unit_category'),
             unit_name=field.get('unit_name'),
             extra_control_class=field.get('extra_control_class'),
             field_extra_class=field.get('field_extra_class'),
             max_width=field.get('max_width', '650px')
        ) }}
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>
{% endif %}
{%- endmacro %}

{% macro file_upload(field_id, label, accept=None, help=None, current_filename=None, attrs=None, error=None, extra_control_class=None) -%}
{% set attrs = attrs.copy() if attrs else {} %}
{% set help_id = field_id ~ "_help" %}
{% set error_id = field_id ~ "_error" %}
{% set describedby = [] %}
{% if attrs.get('aria-describedby') %}
  {% set describedby = describedby + [attrs.pop('aria-describedby')] %}
{% endif %}
{% if help %}
  {% set describedby = describedby + [help_id] %}
{% endif %}
{% if error %}
  {% set describedby = describedby + [error_id] %}
{% endif %}
{% set field_classes = ['wc-field'] %}
{% if error %}
  {% set field_classes = field_classes + ['wc-field--error'] %}
{% endif %}
{% set control_classes = ['wc-field__control'] %}
{% if extra_control_class %}
  {% set control_classes = control_classes + [extra_control_class] %}
{% endif %}
<div class="{{ ' '.join(field_classes) }}" style="max-width: 650px;">
  <label class="wc-field__label" for="{{ field_id }}">{{ label }}</label>
  <input class="{{ ' '.join(control_classes) }}"
         id="{{ field_id }}"
         name="{{ field_id }}"
         type="file"
         {% if accept %}accept="{{ accept }}"{% endif %}
         {% if error %}aria-invalid="true"{% endif %}
         {% if describedby %}aria-describedby="{{ ' '.join(describedby) }}"{% endif %}
         {% for attr_key, attr_val in attrs.items() %}
           {{ attr_key }}="{{ attr_val }}"
         {% endfor %}>
  {% if current_filename %}
  <p class="wc-field__meta">Current file: <code>{{ current_filename }}</code></p>
  {% endif %}
  {% if help %}
  <p id="{{ help_id }}" class="wc-field__help">{{ help }}</p>
  {% endif %}
  {% if error %}
  <p id="{{ error_id }}" class="wc-field__message wc-field__message--error" role="alert">{{ error }}</p>
  {% endif %}
</div>
{%- endmacro %}

{% macro radio_group(name, label=None, layout='vertical', options=None, help=None, mode_help=None, attrs=None, error=None, grid_columns=None) -%}
{% set options = options or [] %}
{% set attrs = attrs.copy() if attrs else {} %}
{% set help_id = name ~ "_help" %}
{% set error_id = name ~ "_error" %}
{% set label_id = name ~ "_label" %}
{% set describedby = [] %}
{% if attrs.get('aria-describedby') %}
  {% set describedby = describedby + [attrs.pop('aria-describedby')] %}
{% endif %}
{% if help %}
  {% set describedby = describedby + [help_id] %}
{% endif %}
{% if error %}
  {% set describedby = describedby + [error_id] %}
{% endif %}
{% set field_classes = ['wc-field'] %}
{% if error %}
  {% set field_classes = field_classes + ['wc-field--error'] %}
{% endif %}
{% set layout = (layout or 'vertical') | lower %}
{% set group_classes = ['wc-choice-group', 'wc-choice-group--' ~ layout] %}
{% set group_style = attrs.pop('style', '') if attrs.get('style') else '' %}
{% if layout == 'grid' %}
  {% set columns = grid_columns if grid_columns is not none else 3 %}
  {% set grid_style = 'grid-template-columns: repeat(' ~ columns ~ ', minmax(0, 1fr));' %}
  {% if group_style %}
    {% set group_style = group_style.rstrip(';') ~ '; ' ~ grid_style %}
  {% else %}
    {% set group_style = grid_style %}
  {% endif %}
{% endif %}
{% if attrs.get('style') %}
  {% set _ = attrs.pop('style') %}
{% endif %}
<div class="{{ ' '.join(field_classes) }}" style="max-width: 650px;">
  {% if label %}
  <span class="wc-field__label" id="{{ label_id }}">{{ label }}</span>
  {% endif %}
  <div class="{{ ' '.join(group_classes) }}"
       role="radiogroup"
       {% if label %}aria-labelledby="{{ label_id }}"{% endif %}
       {% if error %}aria-invalid="true"{% endif %}
       {% if describedby %}aria-describedby="{{ ' '.join(describedby) }}"{% endif %}
       {% if group_style %}style="{{ group_style }}"{% endif %}
       {% for attr_key, attr_val in attrs.items() %}
         {{ attr_key }}="{{ attr_val }}"
       {% endfor %}>
    {% for option in options %}
    {% set option_attrs = option.get('attrs', {}).copy() if option.get('attrs') else {} %}
    {% set option_id = option.get('id', name ~ '_' ~ loop.index) %}
    <label class="wc-choice{% if option.disabled %} is-disabled{% endif %}">
      <input type="radio"
             id="{{ option_id }}"
             name="{{ name }}"
             value="{{ option.value }}"
             {% if option.selected %}checked{% endif %}
             {% if option.disabled %}disabled aria-disabled="true"{% endif %}
             data-choice-value="{{ option.value }}"
             {% for attr_key, attr_val in option_attrs.items() %}
               {{ attr_key }}="{{ attr_val }}"
             {% endfor %}>
      <span class="wc-choice__body">
        <span class="wc-choice__label">{{ option.label }}</span>
        {% if option.description %}
        <span class="wc-choice__description">{{ option.description|safe }}</span>
        {% endif %}
      </span>
    </label>
    {% endfor %}
  </div>
  {% if help %}
  <p id="{{ help_id }}" class="wc-field__help">{{ help }}</p>
  {% endif %}
  {% if error %}
  <p id="{{ error_id }}" class="wc-field__message wc-field__message--error" role="alert">{{ error }}</p>
  {% endif %}
  {% if mode_help %}
  <div class="wc-choice-help" data-choice-help-root="{{ name }}" aria-live="polite">
    {% for value, content in mode_help.items() %}
    <div class="wc-choice-help__panel" data-choice-help-target="{{ value }}">
      {{ content|safe }}
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>
{%- endmacro %}

{% macro checkbox_field(field_id, label, checked=False, help=None, attrs=None, error=None) -%}
{% set attrs = attrs.copy() if attrs else {} %}
{% set help_id = field_id ~ "_help" %}
{% set error_id = field_id ~ "_error" %}
{% set describedby = [] %}
{% if attrs.get('aria-describedby') %}
  {% set describedby = describedby + [attrs.pop('aria-describedby')] %}
{% endif %}
{% if help %}
  {% set describedby = describedby + [help_id] %}
{% endif %}
{% if error %}
  {% set describedby = describedby + [error_id] %}
{% endif %}
{% set field_classes = ['wc-field', 'wc-field--checkbox'] %}
{% if error %}
  {% set field_classes = field_classes + ['wc-field--error'] %}
{% endif %}
<div class="{{ ' '.join(field_classes) }}" style="max-width: 650px;">
  <label class="wc-choice wc-choice--checkbox">
    <input type="checkbox"
           id="{{ field_id }}"
           name="{{ field_id }}"
           {% if checked %}checked{% endif %}
           {% if error %}aria-invalid="true"{% endif %}
           {% if describedby %}aria-describedby="{{ ' '.join(describedby) }}"{% endif %}
           {% for attr_key, attr_val in attrs.items() %}
             {{ attr_key }}="{{ attr_val }}"
           {% endfor %}>
    <span class="wc-choice__body">
      <span class="wc-choice__label">{{ label }}</span>
    </span>
  </label>
  {% if help %}
  <p id="{{ help_id }}" class="wc-field__help">{{ help }}</p>
  {% endif %}
  {% if error %}
  <p id="{{ error_id }}" class="wc-field__message wc-field__message--error" role="alert">{{ error }}</p>
  {% endif %}
</div>
{%- endmacro %}

{% macro textarea_field(field_id, label, value='', rows=4, help=None, placeholder=None, attrs=None, error=None, extra_control_class=None) -%}
{% set attrs = attrs.copy() if attrs else {} %}
{% set help_id = field_id ~ "_help" %}
{% set error_id = field_id ~ "_error" %}
{% set describedby = [] %}
{% if attrs.get('aria-describedby') %}
  {% set describedby = describedby + [attrs.pop('aria-describedby')] %}
{% endif %}
{% if help %}
  {% set describedby = describedby + [help_id] %}
{% endif %}
{% if error %}
  {% set describedby = describedby + [error_id] %}
{% endif %}
{% set field_classes = ['wc-field'] %}
{% if error %}
  {% set field_classes = field_classes + ['wc-field--error'] %}
{% endif %}
{% set control_classes = ['wc-field__control'] %}
{% if extra_control_class %}
  {% set control_classes = control_classes + [extra_control_class] %}
{% endif %}
<div class="{{ ' '.join(field_classes) }}">
  <label class="wc-field__label" for="{{ field_id }}">{{ label }}</label>
  <textarea class="{{ ' '.join(control_classes) }}"
            id="{{ field_id }}"
            name="{{ field_id }}"
            rows="{{ rows }}"
            {% if placeholder %}placeholder="{{ placeholder }}"{% endif %}
            {% if error %}aria-invalid="true"{% endif %}
            {% if describedby %}aria-describedby="{{ ' '.join(describedby) }}"{% endif %}
            {% for attr_key, attr_val in attrs.items() %}
              {{ attr_key }}="{{ attr_val }}"
            {% endfor %}>{{ value }}</textarea>
  {% if help %}
  <p id="{{ help_id }}" class="wc-field__help">{{ help }}</p>
  {% endif %}
  {% if error %}
  <p id="{{ error_id }}" class="wc-field__message wc-field__message--error" role="alert">{{ error }}</p>
  {% endif %}
</div>
{%- endmacro %}

{% macro text_display(label=None, content='', variant=None, actions=None) -%}
{% set actions = actions or [] %}
<div class="wc-field wc-field--display" style="max-width: 650px;">
  {% if label %}
  <span class="wc-field__label">{{ label }}</span>
  {% endif %}
  <div class="wc-text-display{% if variant %} wc-text-display--{{ variant }}{% endif %}">
    {{ content|safe }}
  </div>
  {% if actions %}
  <div class="wc-text-display__actions">
    {% for action in actions %}
    {{ action|safe }}
    {% endfor %}
  </div>
  {% endif %}
</div>
{%- endmacro %}

{% macro table_block(columns, rows, caption=None, empty_message="No records available.") -%}
<div class="wc-table-wrapper">
  <table class="wc-table">
    {% if caption %}
    <caption>{{ caption }}</caption>
    {% endif %}
    <thead>
      <tr>
        {% for column in columns %}
        <th scope="col">{{ column.label }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% if rows %}
        {% for row in rows %}
        <tr>
          {% for column in columns %}
          <td>
            {% if row is mapping %}
              {% set cell = row.get(column.key) %}
            {% else %}
              {% set cell = attribute(row, column.key) %}
            {% endif %}
            {{ cell|default("&mdash;", true)|safe }}
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="{{ columns|length }}">
            <em>{{ empty_message }}</em>
          </td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>
{%- endmacro %}

{% macro dynamic_slot(slot_id, help=None, attrs=None) -%}
{% set attrs = attrs or {} %}
{% set help_id = slot_id ~ "_help" %}
<div class="wc-field wc-field--dynamic">
  <div id="{{ slot_id }}"
       class="wc-dynamic-slot"
       {% if help %}aria-describedby="{{ help_id }}"{% endif %}
       {% for attr_key, attr_val in attrs.items() %}
         {{ attr_key }}="{{ attr_val }}"
       {% endfor %}></div>
  {% if help %}
  <p id="{{ help_id }}" class="wc-field__help">{{ help }}</p>
  {% endif %}
</div>
{%- endmacro %}

{%- macro color_scale(
      range_id,
      canvas_id,
      min_id,
      max_id,
      label=None,
      range_attrs=None,
      canvas_attrs=None,
      units_id=None,
      help=None
    ) -%}
{% set range_attrs = range_attrs or {} %}
{% set canvas_attrs = canvas_attrs or {} %}
<div class="wc-color-scale">
  {% if label %}
  <label class="wc-color-scale__label" for="{{ range_id }}">{{ label }}</label>
  {% endif %}
  <input
    type="range"
    id="{{ range_id }}"
    class="wc-color-scale__range"
    {% for attr_key, attr_val in range_attrs.items() %}
      {{ attr_key }}="{{ attr_val }}"
    {% endfor %}>
  {% if units_id %}
  <span id="{{ units_id }}" class="wc-color-scale__units"></span>
  {% endif %}
  <div class="wc-color-scale__bar">
    <canvas
      id="{{ canvas_id }}"
      class="wc-color-scale__canvas"
      {% for attr_key, attr_val in canvas_attrs.items() %}
        {{ attr_key }}="{{ attr_val }}"
      {% endfor %}></canvas>
  </div>
  <div class="wc-color-scale__labels">
    <span id="{{ min_id }}" class="wc-color-scale__value"></span>
    <span id="{{ max_id }}" class="wc-color-scale__value" data-align="end"></span>
  </div>
  {% if help %}
  <p class="wc-color-scale__help">{{ help }}</p>
  {% endif %}
</div>
{%- endmacro %}

{# Doc: controllers_js/README.md â€” DSS Export Controller Reference (2025 helper migration) #}
{% import "controls/_pure_macros.html" as ui %}
{% from "shared/console_macros.htm" import button_row %}

{% set current_mode = wepp.dss_export_mode if wepp.dss_export_mode in [1, 2] else 1 %}

{% set description %}
  <p class="wc-text-muted">
    Generate partitioned DSS exports for HEC tools. Choose to export specific channels or
    filter by channel order before enqueueing the RQ task.
  </p>
{% endset %}

{% set mode_options = [
  {
    "id": "dss_export_mode1",
    "label": "Export select channels",
    "value": "1",
    "selected": current_mode == 1,
    "attrs": {"class": "disable-readonly", "data-dss-export-mode": "1", "data-action": "dss-export-mode"}
  },
  {
    "id": "dss_export_mode2",
    "label": "Export based on channel order",
    "value": "2",
    "selected": current_mode == 2,
    "attrs": {"class": "disable-readonly", "data-dss-export-mode": "2", "data-action": "dss-export-mode"}
  }
] %}

{% call ui.control_shell(
     form_id="dss_export_form",
     title="Partitioned DSS Export for HEC",
     collapsible=True,
     description=description,
     status_panel_options={"id": "dss_export_status_panel"},
     stacktrace_panel_options={"panel_id": "dss_export_stacktrace_panel", "body_id": "stacktrace"}
   ) %}

  <section class="wc-dss-export">
    <div class="wc-stack-sm">
      {{ ui.text_field(
           "dss_start_date",
           "Start date (optional)",
           value=wepp.dss_start_date or "",
           placeholder="MM/DD/YYYY",
           extra_control_class="disable-readonly",
           help="Use simulation year numbering for stochastic climates."
         ) }}
      {{ ui.text_field(
           "dss_end_date",
           "End date (optional)",
           value=wepp.dss_end_date or "",
           placeholder="MM/DD/YYYY",
           extra_control_class="disable-readonly",
           help="Defaults to the last available simulation day."
         ) }}
    </div>

    {{ ui.radio_group(
         "dss_export_mode",
         label="Export mode",
         layout="vertical",
         options=mode_options
       ) }}

    {% set mode1_style = '' if current_mode == 1 else 'display: none;' %}
    <div
      id="dss_export_mode1_controls"
      class="wc-dss-export__mode wc-stack hide-readonly"
      {% if mode1_style %}style="{{ mode1_style }}"{% endif %}>
      {{ ui.text_field(
           "dss_export_channel_ids",
           "Channel Topaz IDs to export",
           value=(wepp.dss_export_channel_ids | join(', ')),
           placeholder="e.g. 24, 54, 224",
           extra_control_class="disable-readonly",
           help="Provide a comma-separated list of channel Topaz IDs."
         ) }}
    </div>

    {% set mode2_style = '' if current_mode == 2 else 'display: none;' %}
    <div
      id="dss_export_mode2_controls"
      class="wc-dss-export__mode wc-stack hide-readonly"
      {% if mode2_style %}style="{{ mode2_style }}"{% endif %}>
      <span class="wc-field__label">Exclude channel orders</span>
      <div class="wc-dss-export__orders">
        {% for order in range(1, 6) %}
          {{ ui.checkbox_field(
               "dss_export_exclude_order_" ~ order,
               order|string,
               checked=(order in wepp.dss_excluded_channel_orders),
               attrs={"class": "disable-readonly"}
             ) }}
        {% endfor %}
      </div>
    </div>

    {% call button_row() %}
      <button
        id="btn_export_dss"
        type="button"
        class="pure-button pure-button-primary disable-readonly"
        data-action="dss-export-run">
        <img
          id="btn_export_dss_lock"
          src="{{ url_for('static', filename='open-iconic/png/lock-locked-2x.png') }}"
          alt=""
          style="display:none;">
        <span>Export DSS</span>
      </button>
    {% endcall %}
    {{ ui.job_hint("hint_export_dss", extra_class="wc-field__help") }}
  </section>

{% endcall %}

{% import "controls/_pure_macros.html" as ui %}
{% from "shared/console_macros.htm" import button_row %}

{% set current_mode = soils.mode.value if soils.mode is not none else 0 %}
{% set mode_options = [
  {
    "id": "soil_mode0",
    "label": "Determine per hillslope",
    "value": "0",
    "selected": current_mode == 0,
    "attrs": {"class": "disable-readonly"}
  },
  {
    "id": "soil_mode1",
    "label": "Single soil for watershed (Mukey)",
    "value": "1",
    "selected": current_mode == 1,
    "attrs": {"class": "disable-readonly"}
  },
  {
    "id": "soil_mode2",
    "label": "Single soil for watershed (Database)",
    "value": "2",
    "selected": current_mode == 2,
    "attrs": {"class": "disable-readonly"}
  }
] %}

{% set db_options = namespace(values=[]) %}
{% for opt in soildboptions %}
  {% set db_options.values = db_options.values + [(opt, opt)] %}
{% endfor %}

{% set sol_ver_default = '7778.0' %}
{% if disturbed and disturbed.sol_ver is not none %}
  {% set sol_ver_default = disturbed.sol_ver | string %}
{% endif %}

{% set status_panel_override %}
  {% call ui.status_panel(
       id="soil_status_panel",
       title="Status",
       variant="compact",
       log_id="status",
       height="4rem"
     ) %}
    <div id="rq_job" class="wc-status-panel__meta" aria-live="polite"></div>
    <span id="braille" class="wc-status-panel__meta" aria-hidden="true"></span>
  {% endcall %}
{% endset %}

{% call ui.control_shell(
     form_id="soil_form",
     title="Soil Options",
     collapsible=False,
     status_panel_override=status_panel_override,
     summary_panel_override=ui.legacy_summary_panel(),
     stacktrace_panel_override=ui.stacktrace_panel(
       id="soil_stacktrace_panel",
       summary="Details",
       collapsed=True,
       body_id="stacktrace",
       empty_state="No stack trace recorded."
     )
   ) %}

  {{ ui.radio_group(
       "soil_mode",
       label="Soil mode",
       layout="vertical",
       options=mode_options
     ) }}

  {% if 'rred' in ron.mods %}
    <input type="radio" id="soil_mode3" name="soil_mode" value="3" class="disable-readonly" hidden>
    <input type="radio" id="soil_mode4" name="soil_mode" value="4" class="disable-readonly" hidden>
  {% endif %}

  {% set mode0_style = '' if current_mode == 0 else 'display: none;' %}
  <div id="soil_mode0_controls" class="wc-stack hide-readonly"{% if mode0_style %} style="{{ mode0_style }}"{% endif %}>
    <input id="initial_sat" name="initial_sat" type="hidden" value="{{ soils.initial_sat }}">
  </div>

  {% set mode1_style = '' if current_mode == 1 else 'display: none;' %}
  <div id="soil_mode1_controls" class="wc-stack hide-readonly"{% if mode1_style %} style="{{ mode1_style }}"{% endif %}>
    {{ ui.text_field(
         "soil_single_selection",
         "Mukey for single soil",
         value=soils.single_selection,
         help="Enter the Mukey that should be applied to every hillslope.",
         attrs={"autocomplete": "off"},
         extra_control_class="disable-readonly"
       ) }}
  </div>

  {% set mode2_style = '' if current_mode == 2 else 'display: none;' %}
  <div id="soil_mode2_controls" class="wc-stack hide-readonly"{% if mode2_style %} style="{{ mode2_style }}"{% endif %}>
    {{ ui.select_field(
         "soil_single_dbselection",
         "Select soil",
         db_options.values,
         selected=soils.single_dbselection,
         extra_control_class="disable-readonly"
       ) }}
  </div>

  <div id="soil_mode3_controls" class="wc-stack hide-readonly" style="display: none;"></div>
  <div id="soil_mode4_controls" class="wc-stack hide-readonly" style="display: none;"></div>

  {% if 'lt' in ron.mods or 'baer' in ron.mods or 'disturbed' in ron.mods %}
    <p class="wc-text-muted">Hillslopes with burn severity landuses will have soils altered to model burn severity.</p>
  {% endif %}

  {% call ui.collapsible_card(title="Advanced options") %}
    <div class="wc-stack">
      <h4 class="wc-heading wc-heading--sm">Use internal hydraulic conductivity adjustments (ksflag)</h4>
      <p class="wc-text-muted">Should be off for 7778 datasets. Does not affect 9001 and 9002 soils. Experimental option primarily for agriculture runs.</p>
      {{ ui.checkbox_field(
           "checkbox_run_flowpaths",
           "Enable ksflag",
           checked=soils.ksflag,
           attrs={"class": "disable-readonly"}
         ) }}
    </div>

    {% if disturbed %}
    <div class="wc-stack">
      <h4 class="wc-heading wc-heading--sm">Specify disturbed soil version (sol_ver)</h4>
      <p class="wc-text-muted">9002.0 soils fix WEPP surface runoff and sediment yield predictions for areas with high burn severity.</p>
      {{ ui.select_field(
           "sol_ver",
           "sol_ver",
           [
             ("7778.0", "7778.0"),
             ("9002.0", "9002.0"),
             ("9003.0", "9003.0"),
             ("9005.0", "9005.0")
           ],
           selected=sol_ver_default,
           extra_control_class="disable-readonly"
         ) }}
    </div>
    {% endif %}
  {% endcall %}

  {% call button_row() %}
    <button
      type="button"
      class="pure-button pure-button-primary disable-readonly"
      id="btn_build_soil">
      Build Soils
    </button>
  {% endcall %}
  <p id="hint_build_soil" class="wc-text-muted" aria-live="polite"></p>

{% endcall %}

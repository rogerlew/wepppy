{% from "shared/console_macros.htm" import button_row %}
{% import "controls/_pure_macros.html" as ui %}
{% import "shared/cap_macros.htm" as cap_macros %}

{# Front-end config guidance: see wepppy/weppcloud/AGENTS.md ("Front-end bundles") #}
{% set wrap = fork_console_wrap if fork_console_wrap is defined else True %}
{% if wrap %}
<section class="wc-stack"
         data-controller="fork-console">
{% endif %}
  <div data-fork-console-config
       data-runid="{{ runid }}"
       data-config="{{ config }}"
       data-undisturbify="{{ 'true' if undisturbify is sameas true else 'false' }}"
       data-cap-required="{{ 'true' if not current_user.is_authenticated else 'false' }}"
       data-cap-section="fork"
       hidden></div>
  {% call ui.control_shell(
       form_id="fork_form",
       title="Fork Project",
       collapsible=False,
       form_class="pure-form-aligned",
       form_attrs={'novalidate': True},
       status_panel_options={
         "id": "fork_status_panel",
         "title": "Console",
         "variant": "console",
         "log_id": "fork_status_log",
         "meta": '<div id="the_console" class="wc-status" data-state="attention">Waiting for submission...</div>'
       },
       summary_panel_override='',
       stacktrace_panel_override=ui.stacktrace_panel(
         id="fork_stacktrace_panel",
         summary="Stack trace",
         description="Exceptions from fork jobs appear here.",
         empty_state="No stack trace captured."
       )
     ) %}
    <fieldset>
      {{ ui.text_field(
           'runid_input',
           'Source run ID',
           value=runid,
           attrs={'readonly': 'readonly'}
         ) }}
      {{ ui.checkbox_field(
           'undisturbify_checkbox',
           'Undisturbify output (optional)',
           checked=undisturbify is sameas true
         ) }}
      {% if not current_user.is_authenticated %}
      {{ cap_macros.cap_prompt("fork", "cap-fork", cap_base_url, cap_site_key, status_text="Complete verification to enable forking.") }}
      <input type="hidden" name="cap_token" value="" data-cap-token>
      {% endif %}
      {% call button_row() %}
        <button type="submit"
                class="pure-button{% if not current_user.is_authenticated %} is-disabled{% endif %}"
                id="submit_button"
                {% if not current_user.is_authenticated %}disabled aria-disabled="true"{% endif %}>
          Fork project
        </button>
        <button type="button" class="pure-button pure-button-secondary" id="cancel_button" hidden>Cancel job</button>
      {% endcall %}
      {{ ui.job_hint("hint_run_fork") }}
    </fieldset>
  {% endcall %}
{% if wrap %}
</section>
{% endif %}

{# Doc: controllers_js/README.md — Ash Controller Modernization (2024 helper-first baseline) #}
{% import "controls/_pure_macros.html" as ui %}
{% from "shared/console_macros.htm" import button_row %}

{% set description %}
  <p class="wc-text-muted">
    Run the Wildfire Ash Transport And Risk (WATAR) workflow to simulate hillslope ash depletion,
    transport, and watershed summaries. Run WEPP first so hydrologic inputs are available.
  </p>
  <p class="wc-text-muted">
    Ash depths below the roughness limit (white: {{ "%.1f"|format(ash.anu_white_ash_model_pars.roughness_limit) }}&nbsp;mm;
    black: {{ "%.1f"|format(ash.anu_black_ash_model_pars.roughness_limit) }}&nbsp;mm) are treated as non-transportable.
  </p>
{% endset %}

{% call ui.control_shell(
     form_id="ash_form",
     title="Wildfire Ash Transport And Risk (WATAR)",
     collapsible=True,
     description=description
   ) %}

  {% set depth_mode = ash.ash_depth_mode %}
  {% set depth_mode_options = [
    {
      "id": "ash_depth_mode_depth",
      "label": "Specify Depth",
      "value": "1",
      "selected": depth_mode == 1,
      "attrs": {"class": "disable-readonly", "data-ash-depth-mode": "1"}
    },
    {
      "id": "ash_depth_mode_load",
      "label": "Specify Load",
      "value": "0",
      "selected": depth_mode == 0,
      "attrs": {"class": "disable-readonly", "data-ash-depth-mode": "0"}
    },
    {
      "id": "ash_depth_mode_maps",
      "label": "Upload Maps",
      "value": "2",
      "selected": depth_mode == 2,
      "attrs": {"class": "disable-readonly", "data-ash-depth-mode": "2"}
    }
  ] %}

  {{ ui.text_field(
       "fire_date",
       "Fire day for ash model (month/day)",
       value=ash.fire_date,
       extra_control_class="disable-readonly",
       attrs={
         "autocomplete": "off",
         "inputmode": "text",
         "spellcheck": "false"
       }
     ) }}

  {{ ui.radio_group(
       "ash_depth_mode",
       label="Ash depth mode",
       layout="horizontal",
       options=depth_mode_options
     ) }}

  <div id="ash_depth_mode1_controls"
       class="wc-stack"
       {% if depth_mode != 1 %}style="display: none;"{% endif %}>
    {{ ui.numeric_field(
         "ini_black_depth",
         "Initial ash depth – moderate/low severity",
         value="%.3f"|format(ash.ini_black_ash_depth_mm),
         unit_label="mm",
         precision="0.1",
         attrs={"data-disable-readonly": "true"},
         unit_category="xs-distance",
         unit_name="mm",
         extra_control_class="disable-readonly"
       ) }}
    {{ ui.numeric_field(
         "ini_white_depth",
         "Initial ash depth – high severity",
         value="%.3f"|format(ash.ini_white_ash_depth_mm),
         unit_label="mm",
         precision="0.1",
         attrs={"data-disable-readonly": "true"},
         unit_category="xs-distance",
         unit_name="mm",
         extra_control_class="disable-readonly"
       ) }}
  </div>

  <div id="ash_depth_mode0_controls"
       class="wc-stack"
       {% if depth_mode != 0 %}style="display: none;"{% endif %}>
    {{ ui.numeric_field(
         "ini_black_load",
         "Initial ash load – high severity",
         value="%.3f"|format(ash.ini_black_ash_load),
         unit_label="kg/m^2",
         precision="0.1",
         attrs={"data-disable-readonly": "true"},
         unit_category="sm-surface-density",
         unit_name="kg/m^2",
         extra_control_class="disable-readonly"
       ) }}
    {{ ui.numeric_field(
         "ini_white_load",
         "Initial ash load – moderate/low severity",
         value="%.3f"|format(ash.ini_white_ash_load),
         unit_label="kg/m^2",
         precision="0.1",
         attrs={"data-disable-readonly": "true"},
         unit_category="sm-surface-density",
         unit_name="kg/m^2",
         extra_control_class="disable-readonly"
       ) }}
  </div>

  <div id="ash_depth_mode2_controls"
       class="wc-stack"
       {% if depth_mode != 2 %}style="display: none;"{% endif %}>
    {{ ui.file_upload(
         "input_upload_ash_load",
         "Load map (tonne/ha)",
         accept=".tif,.tiff,.img",
         help="Uploads remain under 100 MB and retain source projection.",
         extra_control_class="disable-readonly",
         attrs={
           "data-disable-readonly": "true",
           "data-ash-upload": "load"
         }
       ) }}

    {{ ui.file_upload(
         "input_upload_ash_type_map",
         "Ash type map (optional)",
         accept=".tif,.tiff,.img",
         help="0 = none, 1 = black ash, 2 = white ash.",
         extra_control_class="disable-readonly",
         attrs={
           "data-disable-readonly": "true",
           "data-ash-upload": "type"
         }
       ) }}
  </div>

  {{ ui.numeric_field(
       "field_black_bulkdensity",
       "Field-measured ash bulk density – low/moderate severity",
       value="%.4f"|format(ash.field_black_ash_bulkdensity),
       unit_label="g/cm^3",
       precision="0.001",
       attrs={"data-disable-readonly": "true"},
       unit_category="bulk-density",
       unit_name="g/cm^3",
       extra_control_class="disable-readonly"
     ) }}

  {{ ui.numeric_field(
       "field_white_bulkdensity",
       "Field-measured ash bulk density – high severity",
       value="%.4f"|format(ash.field_white_ash_bulkdensity),
       unit_label="g/cm^3",
       precision="0.001",
       attrs={"data-disable-readonly": "true"},
       unit_category="bulk-density",
       unit_name="g/cm^3",
       extra_control_class="disable-readonly"
     ) }}

  {% set selected_model = ash.model %}
  {% set using_alex = selected_model == 'alex' %}
  {% set white_pars = ash.alex_white_ash_model_pars if using_alex else ash.anu_white_ash_model_pars %}
  {% set black_pars = ash.alex_black_ash_model_pars if using_alex else ash.anu_black_ash_model_pars %}

  {% call ui.collapsible_card("Advanced options", expanded=False, card_id="ash_advanced_options") %}
    <div class="wc-stack">
      {{ ui.checkbox_field(
           "checkbox_run_wind_transport",
           "Run wind transport",
           checked=ash.run_wind_transport,
           attrs={"class": "disable-readonly", "data-ash-action": "toggle-wind"}
         ) }}

      {{ ui.select_field(
           "ash_model_select",
           "Ash model",
           options=ash.available_models,
           selected=selected_model,
           extra_control_class="disable-readonly",
           attrs={"data-ash-action": "model-select"}
         ) }}

      <div class="alex-only-param"
           {% if not using_alex %}style="display: none;"{% endif %}>
        {{ ui.select_field(
             "ash_transport_mode_select",
             "Transport mode",
             options=[('dynamic', 'Dynamic'), ('static', 'Static')],
             selected=ash.transport_mode,
             extra_control_class="disable-readonly",
             attrs={"data-ash-action": "transport-select"}
           ) }}
        <div id="dynamic_description"
             class="wc-text-muted"
             {% if ash.transport_mode != 'dynamic' %}style="display: none;"{% endif %}>
          <small>
            <strong>Dynamic formulation with K(x):</strong> transport capacity responds to shear stress,
            organic matter, and ash availability.
          </small>
        </div>
        <div id="static_description"
             class="wc-text-muted"
             {% if ash.transport_mode == 'dynamic' %}style="display: none;"{% endif %}>
          <small>
            <strong>Static exponential formulation (A, B):</strong> transport follows a fixed exponential
            decay controlled by the initial capacity A and depletion coefficient B.
          </small>
        </div>
      </div>

      <div class="wc-stack">
        {{ ui.numeric_field(
             "white_ini_bulk_den",
             "Initial bulk density (white ash)",
             value="%.6f"|format(white_pars.ini_bulk_den),
             precision="0.0001",
             unit_label="g/cm^3",
             attrs={"data-disable-readonly": "true"},
             unit_category="bulk-density",
             unit_name="g/cm^3",
             extra_control_class="disable-readonly"
           ) }}
        {{ ui.numeric_field(
             "black_ini_bulk_den",
             "Initial bulk density (black ash)",
             value="%.6f"|format(black_pars.ini_bulk_den),
             precision="0.0001",
             unit_label="g/cm^3",
             attrs={"data-disable-readonly": "true"},
             unit_category="bulk-density",
             unit_name="g/cm^3",
             extra_control_class="disable-readonly"
           ) }}

        {{ ui.numeric_field(
             "white_fin_bulk_den",
             "Final bulk density (white ash)",
             value="%.6f"|format(white_pars.fin_bulk_den),
             precision="0.0001",
             unit_label="g/cm^3",
             attrs={"data-disable-readonly": "true"},
             unit_category="bulk-density",
             unit_name="g/cm^3",
             extra_control_class="disable-readonly"
           ) }}
        {{ ui.numeric_field(
             "black_fin_bulk_den",
             "Final bulk density (black ash)",
             value="%.6f"|format(black_pars.fin_bulk_den),
             precision="0.0001",
             unit_label="g/cm^3",
             attrs={"data-disable-readonly": "true"},
             unit_category="bulk-density",
             unit_name="g/cm^3",
             extra_control_class="disable-readonly"
           ) }}

        {{ ui.numeric_field(
             "white_bulk_den_fac",
             "Bulk density factor (white ash)",
             value="%.6f"|format(white_pars.bulk_den_fac),
             precision="0.0001",
             attrs={"data-disable-readonly": "true"}
           ) }}
        {{ ui.numeric_field(
             "black_bulk_den_fac",
             "Bulk density factor (black ash)",
             value="%.6f"|format(black_pars.bulk_den_fac),
             precision="0.0001",
             attrs={"data-disable-readonly": "true"}
           ) }}

        {{ ui.numeric_field(
             "white_par_den",
             "Particle density (white ash)",
             value="%.6f"|format(white_pars.par_den),
             precision="0.0001",
             unit_label="g/cm^3",
             attrs={"data-disable-readonly": "true"},
             unit_category="bulk-density",
             unit_name="g/cm^3",
             extra_control_class="disable-readonly"
           ) }}
        {{ ui.numeric_field(
             "black_par_den",
             "Particle density (black ash)",
             value="%.6f"|format(black_pars.par_den),
             precision="0.0001",
             unit_label="g/cm^3",
             attrs={"data-disable-readonly": "true"},
             unit_category="bulk-density",
             unit_name="g/cm^3",
             extra_control_class="disable-readonly"
           ) }}

        {{ ui.numeric_field(
             "white_decomp_fac",
             "Ash decomposition factor (white ash, 1/day)",
             value="%.6f"|format(white_pars.decomp_fac),
             precision="0.0001",
             attrs={"data-disable-readonly": "true"}
           ) }}
        {{ ui.numeric_field(
             "black_decomp_fac",
             "Ash decomposition factor (black ash, 1/day)",
             value="%.6f"|format(black_pars.decomp_fac),
             precision="0.0001",
             attrs={"data-disable-readonly": "true"}
           ) }}

        <div class="anu-only-param"
             {% if using_alex %}style="display: none;"{% endif %}>
          {{ ui.numeric_field(
               "white_ini_erod",
              "Initial erodibility (white ash)",
              value="%.6f"|format(ash.anu_white_ash_model_pars.ini_erod),
              precision="0.0001",
              unit_label="t/ha",
              attrs={"data-disable-readonly": "true"},
              unit_category="surface-density",
              unit_name="tonne/ha",
              extra_control_class="disable-readonly"
            ) }}
          {{ ui.numeric_field(
               "black_ini_erod",
              "Initial erodibility (black ash)",
              value="%.6f"|format(ash.anu_black_ash_model_pars.ini_erod),
              precision="0.0001",
              unit_label="t/ha",
              attrs={"data-disable-readonly": "true"},
              unit_category="surface-density",
              unit_name="tonne/ha",
              extra_control_class="disable-readonly"
            ) }}

          {{ ui.numeric_field(
               "white_fin_erod",
              "Final erodibility (white ash)",
              value="%.6f"|format(ash.anu_white_ash_model_pars.fin_erod),
              precision="0.0001",
              unit_label="t/ha",
              attrs={"data-disable-readonly": "true"},
              unit_category="surface-density",
              unit_name="tonne/ha",
              extra_control_class="disable-readonly"
            ) }}
          {{ ui.numeric_field(
               "black_fin_erod",
              "Final erodibility (black ash)",
              value="%.6f"|format(ash.anu_black_ash_model_pars.fin_erod),
              precision="0.0001",
              unit_label="t/ha",
              attrs={"data-disable-readonly": "true"},
              unit_category="surface-density",
              unit_name="tonne/ha",
              extra_control_class="disable-readonly"
            ) }}
        </div>

        {{ ui.numeric_field(
             "white_roughness_limit",
             "Roughness limit (white ash)",
             value="%.6f"|format(white_pars.roughness_limit),
             precision="0.0001",
             unit_label="mm",
             attrs={"data-disable-readonly": "true"},
             unit_category="xs-distance",
             unit_name="mm",
             extra_control_class="disable-readonly"
           ) }}
        {{ ui.numeric_field(
             "black_roughness_limit",
             "Roughness limit (black ash)",
             value="%.6f"|format(black_pars.roughness_limit),
             precision="0.0001",
             unit_label="mm",
             attrs={"data-disable-readonly": "true"},
             unit_category="xs-distance",
             unit_name="mm",
             extra_control_class="disable-readonly"
           ) }}

        <div class="alex-only-param alex-dynamic-param"
             {% if not using_alex or ash.transport_mode != 'dynamic' %}style="display: none;"{% endif %}>
          {{ ui.numeric_field(
               "white_org_mat",
               "Organic matter (white ash, fraction)",
               value="%.6f"|format(white_pars.org_mat if using_alex and white_pars.org_mat is not none else 0.0),
               precision="0.0001",
               attrs={"data-disable-readonly": "true"}
             ) }}
          {{ ui.numeric_field(
               "black_org_mat",
               "Organic matter (black ash, fraction)",
               value="%.6f"|format(black_pars.org_mat if using_alex and black_pars.org_mat is not none else 0.0),
               precision="0.0001",
               attrs={"data-disable-readonly": "true"}
             ) }}
        </div>

        <div class="alex-only-param alex-static-param"
             {% if not using_alex or ash.transport_mode != 'static' %}style="display: none;"{% endif %}>
          {{ ui.numeric_field(
               "white_initranscap",
               "Initial transport capacity (white ash, t ha^-1 mm^-1)",
               value="%.6f"|format(white_pars.initranscap if using_alex and white_pars.initranscap is not none else 0.0),
               precision="0.0001",
               attrs={"data-disable-readonly": "true"}
             ) }}
          {{ ui.numeric_field(
               "black_initranscap",
               "Initial transport capacity (black ash, t ha^-1 mm^-1)",
               value="%.6f"|format(black_pars.initranscap if using_alex and black_pars.initranscap is not none else 0.0),
               precision="0.0001",
               attrs={"data-disable-readonly": "true"}
             ) }}

          {{ ui.numeric_field(
               "white_depletcoeff",
               "Depletion coefficient (white ash, mm^-1)",
               value="%.6f"|format(white_pars.depletcoeff if using_alex and white_pars.depletcoeff is not none else 0.0),
               precision="0.0001",
               attrs={"data-disable-readonly": "true"}
             ) }}
          {{ ui.numeric_field(
               "black_depletcoeff",
               "Depletion coefficient (black ash, mm^-1)",
               value="%.6f"|format(black_pars.depletcoeff if using_alex and black_pars.depletcoeff is not none else 0.0),
               precision="0.0001",
               attrs={"data-disable-readonly": "true"}
             ) }}
        </div>
      </div>
    </div>
  {% endcall %}

  {% call button_row() %}
    <button
      id="btn_run_ash"
      type="button"
      class="pure-button pure-button-primary disable-readonly"
      data-ash-action="run">
      <img id="run_ash_lock"
           src="{{ url_for('static', filename='open-iconic/png/lock-locked-2x.png') }}"
           alt="Lock"
           style="display:none;">
      Run Model
    </button>
  {% endcall %}
  {{ ui.job_hint("hint_run_ash", extra_class="wc-field__help") }}

{% endcall %}

<script type="application/json" id="ash-model-params-data">
  {{ {
    'multi': {
      'white': ash.anu_white_ash_model_pars.to_dict(),
      'black': ash.anu_black_ash_model_pars.to_dict()
    },
    'alex': {
      'white': ash.alex_white_ash_model_pars.to_dict(),
      'black': ash.alex_black_ash_model_pars.to_dict()
    }
  } | tojson | safe }}
</script>

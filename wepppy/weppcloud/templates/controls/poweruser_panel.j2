<!-- Modal -->
<style>
  /* Keep the PowerUser modal sizing/positioning self-contained */
  #puModal .modal-dialog {
    max-width: 1100px;
    width: calc(100vw - 32px);
    margin: 80px auto 32px;
  }

  #puModal .modal-content {
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - 144px);
  }

  #puModal .modal-body {
    overflow-y: auto;
  }

  @media (max-width: 768px) {
    #puModal .modal-dialog {
      margin: 72px auto 24px;
      width: calc(100vw - 24px);
    }
  }
</style>
<div class="modal fade" id="puModal" role="dialog">
  <script>
    // System Notifications

    // ---- constants ----
    const WEBPUSH_BASE = "/weppcloud-microservices/webpush";
    const SW_URL = "{{ site_prefix }}/sw.js";
    const SW_SCOPE = "{{ site_prefix }}/";
    const RUN_ID = (typeof runid !== "undefined") ? runid : null;

    const SUB_ID_KEY = "wepppush.sub.id";
    const VAPID_PK_KEY = "{{ VAPID_PUBLIC_KEY }}";

    // base64url -> Uint8Array
    function urlB64ToUint8Array(s) {
      const base64 = (s + "=".repeat((4 - (s.length % 4)) % 4)).replace(/-/g, "+").replace(/_/g, "/");
      const raw = atob(base64), out = new Uint8Array(raw.length);
      for (let i = 0; i < raw.length; i++) out[i] = raw.charCodeAt(i);
      return out;
    }

    // ---- core helpers ----
    async function ensureRegistration() {
      const reg = await navigator.serviceWorker.register(SW_URL, { scope: SW_SCOPE });
      await navigator.serviceWorker.ready;
      return reg;
    }

    async function ensureSubscription(reg) {
      // Only attempt subscribe if permission is already granted
      if (Notification.permission !== "granted") return null;

      let sub = await reg.pushManager.getSubscription();
      if (!sub) {
        sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlB64ToUint8Array(VAPID_PK_KEY)
        });
      }
      return sub;
    }

    async function upsertSubscriptionOnServer(sub) {
      const payload = { subscription: sub.toJSON ? sub.toJSON() : { endpoint: sub.endpoint, keys: sub.keys || {} }, run_id: RUN_ID };
      const res = await fetch(`${WEBPUSH_BASE}/subscriptions`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(`subscriptions POST failed: ${res.status} ${await res.text()}`);
      const data = await res.json();
      if (!data?.id) throw new Error("subscriptions POST missing id");
      localStorage.setItem(SUB_ID_KEY, data.id);
      return data.id;
    }

    // Registers SW and (if allowed) ensures a subscription exists + is upserted.
    // Safe to call on page load; it will no-op until permission is granted.
    async function initPush() {
      if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
        console.warn("[wepppush] Push API not supported in this browser");
        return;
      }

      // Request permission if not already granted
      if (Notification.permission !== "granted") {
        console.log("[wepppush] Requesting notification permission...");
        const perm = await Notification.requestPermission();
        if (perm !== "granted") return;
      }

      const reg = await ensureRegistration();
      console.log("[wepppush] Service Worker registered:", reg);

      const sub = await ensureSubscription(reg);
      console.log("[wepppush] Subscription ensured:", sub);

      if (sub) await upsertSubscriptionOnServer(sub);
    }

    // ---- per-run enable/disable ----
    async function enableForRun(runId, subId) {
      if (!runId || !subId) return;
      const r = await fetch(`${WEBPUSH_BASE}/subscriptions/${encodeURIComponent(subId)}/runs`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ run_id: runId, enabled: true, ttl_days: 7 })
      });
      if (!r.ok && r.status !== 204) throw new Error(`runs enable failed: ${r.status} ${await r.text()}`);
    }

    async function disableForRun(runId, subId) {
      if (!runId || !subId) return;
      const r = await fetch(`${WEBPUSH_BASE}/subscriptions/${encodeURIComponent(subId)}/runs`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ run_id: runId, enabled: false })
      });
      if (!r.ok && r.status !== 204) throw new Error(`runs disable failed: ${r.status} ${await r.text()}`);
    }

    // ---- public entry points for your toggle ----
    async function enableNotifications() {
      if (!("serviceWorker" in navigator) || !("PushManager" in window)) return;
      if (!RUN_ID) return;

      await initPush();

      const subId = localStorage.getItem(SUB_ID_KEY);
      await enableForRun(RUN_ID, subId);
    }

    async function disableNotifications() {
      if (!("serviceWorker" in navigator) || !("PushManager" in window)) return;
      if (!RUN_ID) return;

      await initPush();

      const subId = localStorage.getItem(SUB_ID_KEY);
      await disableForRun(RUN_ID, subId);
    }

    // ---- wire up your toggle ----
    document.addEventListener("DOMContentLoaded", async () => {
      // Kick off SW registration and (if permitted) backend upsert
      try { await initPush(); } catch (e) { console.warn("[wepppush] initPush:", e); }

      const toggle = document.getElementById("notificationToggle");
      const toggleLabel = document.getElementById("notificationToggleLabel");

      if (!toggle || !toggleLabel) {
        console.warn("[wepppush] Notification toggle elements not present; skipping toggle wiring");
        return;
      }

      const subId = localStorage.getItem(SUB_ID_KEY);
      if (!subId || !RUN_ID) {
        console.warn("[wepppush] Missing subId or runId, toggle left off");
        toggle.checked = false;
        toggleLabel.textContent = "Disabled";
        return;
      }

      try {
        const res = await fetch(`${WEBPUSH_BASE}/subscriptions/${encodeURIComponent(subId)}/runs/${encodeURIComponent(RUN_ID)}`, {
          method: "GET",
          credentials: "same-origin"
        });

        if (!res.ok) {
          console.error("[wepppush] GET runs failed:", res.status, await res.text());
          toggle.checked = false;
          toggleLabel.textContent = "Disabled";
          return;
        }

        const data = await res.json();
        toggle.checked = !!data.enabled;
        toggleLabel.textContent = data.enabled ? "Enabled" : "Disabled";

      } catch (err) {
        console.error("[wepppush] Error checking run state:", err);
        toggle.checked = false;
        toggleLabel.textContent = "Disabled";
      }

      // Handle toggle changes
      toggle.addEventListener("change", async () => {
        if (toggle.checked) {
          toggleLabel.textContent = "Enabling...";
          try {
            await enableNotifications();
            toggleLabel.textContent = "Enabled";
          } catch (err) {
            console.error("[wepppush] Enable error:", err);
            toggle.checked = false;
            toggleLabel.textContent = "Failed to enable";
          }
        } else {
          toggleLabel.textContent = "Disabling...";
          try {
            await disableNotifications();
            toggleLabel.textContent = "Disabled";
          } catch (err) {
            console.error("[wepppush] Disable error:", err);
            toggle.checked = true;
            toggleLabel.textContent = "Failed to disable";
          }
        }
      });
    });
  </script>
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <h4 data-toc-skip class="modal-title">PowerUser Panel</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            {% if False %}
            <h5>System Notifications</h5>
            <div class="list-group" style="margin-bottom: 5px;">
              <div class="list-group-item">
                <div class="custom-control custom-switch">
                  <input type="checkbox" class="custom-control-input" id="notificationToggle">
                  <label class="custom-control-label" for="notificationToggle" id="notificationToggleLabel">Enable
                    System Notifications</label>
                </div>
              </div>
            </div>
            {% endif %}
            <h5>Components</h5>
            <div class="list-group">
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/ron.nodb">nodb.ron</a>
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/topaz.nodb">nodb.topaz</a>
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/watershed.nodb">nodb.watershed</a>
              {% if 'rhem' not in ron.mods %}
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/landuse.nodb">nodb.landuse</a>
              {% endif %}
              {% if 'shrubland' in ron.mods %}
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/shrubland.nodb">nodb.shrubland</a>
              {% endif %}
              {% if 'rangeland_cover' in ron.mods %}
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/rangeland_cover.nodb">nodb.rangeland_cover</a>
              {% endif %}
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/soils.nodb">nodb.soils</a>
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/climate.nodb">nodb.climate</a>
              {% if 'rhem' in ron.mods %}
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/rhem.nodb">nodb.rhem</a>
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/rhempost.nodb">nodb.rhempost</a>
              {% endif %}
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/wepp.nodb">nodb.wepp</a>
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/wepppost.nodb">nodb.wepppost</a>
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/observed.nodb">nodb.observed</a>
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/unitizer.nodb">nodb.unitizer</a>
              {% if 'baer' in ron.mods %}
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/baer.nodb">nodb.baer</a>
              {% endif %}
              {% if 'disturbed' in ron.mods %}
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/disturbed.nodb">nodb.disturbed</a>
              {% endif %}
              {% if 'rred' in ron.mods %}
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/rred.nodb">nodb.rred</a>
              {% endif %}
              {% if 'lt' in ron.mods %}
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/lt.nodb">nodb.lt</a>
              {% endif %}
              {% if 'ash' in ron.mods %}
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/ash.nodb">nodb.ash</a>
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/ashpost.nodb">nodb.ashpost</a>
              {% endif %}
              {% if 'debris_flow' in ron.mods %}
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/debris_flow.nodb">nodb.debris_flow</a>
              {% endif %}
              {% if 'omni' in ron.mods %}
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/omni.nodb">nodb.omni</a>
              {% endif %}
            </div>
            <br>
            <div class="list-group">
              <a class="list-group-item list-group-item-action text-danger" onclick="Project.getInstance().clear_locks()" href="#">Clear
                Locks</a>
            </div>
          </div>
          <div class="col-md-6">
            <h5>Directory Views</h5>
            <div class="list-group">
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/">/</a>
              {% if 'rred' in ron.mods %}
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/rred/">rred/</a>
              {% endif %}
              {% if 'rhem' not in ron.mods %}
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/wepp/runs/">wepp/runs/</a>
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/wepp/output/">wepp/output/</a>
              {% else %}
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/rhem/runs/">rhem/runs/</a>
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/rhem/output/">rhem/output/</a>
              {% endif %}
              {% if 'ash' in ron.mods %}
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/ash/">ash/</a>
              {% endif %}
            </div>
            <br>
            <h5>Data Tables</h5>
            <div class="list-group">
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/watershed/hillslopes.parquet/">Hillslope</a>
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/watershed/channels.parquet">Channels</a>
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/landuse/landuse.parquet/">Landuse</a>
              <a class="list-group-item list-group-item-action" target="_blank"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/browse/soils/soils.parquet/">Soils</a>
            </div>
            <br>
            {% if 'disturbed' in ron.mods %}
            <h5>Disturbed</h5>
            <div class="list-group">
              <a class="list-group-item list-group-item-action"
                href="{{site_prefix}}/runs/{{ ron.runid }}/{{ ron.config_stem }}/modify_disturbed"
                target="_blank">Modify Disturbed Parameters</a>
              <a class="list-group-item list-group-item-action"
                onclick="Disturbed.getInstance().reset_land_soil_lookup()" href="#">Reset Disturbed Parameters</a>
              <a class="list-group-item list-group-item-action"
                onclick="Disturbed.getInstance().load_extended_land_soil_lookup()" href="#">Load Extended Disturbed
                Parameters</a>
              <a class="list-group-item list-group-item-action"
                href="https://doc.wepp.cloud/disturbed_land_soil_lookup_doc.html" target="_blank">Disturbed Parameters
                Documentation</a>
            </div>
            {% endif %}
            {% if 'omni' not in ron.mods %}
            <br>
            <h5>Omni (Experimental)</h5>
            <div class="list-group">
              <a class="list-group-item list-group-item-action"
                onclick="Project.getInstance().migrate_to_omni()" href="#">Migrate Project to Omni</a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

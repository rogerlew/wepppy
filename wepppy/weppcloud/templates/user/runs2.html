{% extends "base_pure.htm" %}

{% block title %}Runs{% endblock %}

{% block body_container_class %}wc-container wc-container--fluid{% endblock %}
{% block header_container_class %}wc-container wc-container--fluid{% endblock %}

{% block body %}
{% macro sortable_header(label, field) -%}
  {% set current_sort = sort | default('last_modified', true) %}
  {% set current_direction = direction | default('desc', true) %}
  {% set is_active = (current_sort == field) %}
  {% set asc_active = is_active and current_direction == 'asc' %}
  {% set desc_active = is_active and current_direction == 'desc' %}
  {% set per_page_value = per_page | default(100, true) %}
  {% if asc_active %}
    {% set indicator = '▲' %}
    {% set aria_sort = 'ascending' %}
  {% elif desc_active %}
    {% set indicator = '▼' %}
    {% set aria_sort = 'descending' %}
  {% else %}
    {% set indicator = '↕' %}
    {% set aria_sort = 'none' %}
  {% endif %}
  {% if is_active %}
    {% if current_direction == 'asc' %}
      {% set next_direction = 'desc' %}
    {% else %}
      {% set next_direction = 'asc' %}
    {% endif %}
  {% else %}
    {% set next_direction = 'asc' %}
  {% endif %}
  {% set next_direction_label = 'descending' if next_direction == 'desc' else 'ascending' %}
  <th scope="col"
      class="sortable-header"
      data-sort-direction="{{ current_direction if is_active else 'none' }}"
      aria-sort="{{ aria_sort }}">
    <a class="wc-server-sort"
       href="{{ url_for('user.runs', page=1, sort=field, direction=next_direction, per_page=per_page_value) }}"
       aria-label="Sort {{ label }} {{ next_direction_label }}"
       data-next-direction="{{ next_direction }}">
      <span class="wc-server-sort__label">{{ label }}</span>
      <span class="sortable-indicator" aria-hidden="true">{{ indicator }}</span>
    </a>
  </th>
{%- endmacro %}

{% include 'command-bar.htm' %}

<section class="wc-stack wc-table-page">
  <header class="wc-stack">
    <div class="wc-console-header">
      <div class="wc-console-header__primary">
        <h1 class="wc-heading__title">Runs</h1>
      </div>
    </div>
  </header>

  <section class="wc-panel wc-stack">
    <div class="wc-toolbar wc-toolbar--end">
      <button type="button" class="pure-button pure-button-secondary" id="delete_runs_button" onclick="deleteRuns()" disabled>Delete selected</button>
    </div>

    <div class="wc-table-wrapper">
      <table class="wc-table wc-table--dense" id="runs_table">
        <thead>
          <tr>
            {% if show_owner %}<th scope="col">Owner</th>{% endif %}
            {{ sortable_header('Project name', 'name') }}
            {{ sortable_header('Scenario', 'scenario') }}
            {{ sortable_header('Run ID', 'runid') }}
            {{ sortable_header('Config', 'config') }}
            <th scope="col">Link</th>
            {{ sortable_header('Creation date', 'date_created') }}
            {{ sortable_header('Last modified', 'last_modified') }}
            <th scope="col" class="wc-text-muted" title="Do not add columns that normalize casing in headers.">Select</th>
          </tr>
        </thead>
        <tbody>
          {% for meta in user_runs %}
          <tr id="{{ meta.runid }}">
            {% if show_owner %}<td>{{ meta.owner }}</td>{% endif %}
            <td>{{ meta.name }}</td>
            <td>{{ meta.scenario }}</td>
            <td>{{ meta.runid }}</td>
            <td>{{ meta.config }}</td>
            <td>
              <a class="pure-button pure-button-secondary" href="{{ site_prefix }}/runs/{{ meta.runid }}/{{ meta.config }}/" target="_blank" rel="noopener">Open</a>
            </td>
            <td>{% if meta.date_created %}{{ meta.date_created }}{% else %}&mdash;{% endif %}</td>
            <td>{% if meta.last_modified %}{{ meta.last_modified }}{% else %}&mdash;{% endif %}</td>
            <td>
              <input type="checkbox" value="{{ meta.runid }}" {% if meta.readonly %}disabled{% endif %} aria-label="Select {{ meta.runid }}">
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="10" class="wc-text-muted">No runs found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if pagination %}
      {% set per_page_value = per_page | default(100, true) %}
      {% set sort_value = sort | default('last_modified', true) %}
      {% set direction_value = direction | default('desc', true) %}
      <nav aria-label="Runs pagination" class="wc-pagination-nav">
        {% if pagination.has_prev %}
          <a class="wc-pagination__link"
             href="{{ url_for('user.runs', page=pagination.prev_num, sort=sort_value, direction=direction_value, per_page=per_page_value) }}"
             aria-label="Previous page">
            &laquo;
          </a>
        {% else %}
          <span class="wc-pagination__link" aria-hidden="true" aria-disabled="true">&laquo;</span>
        {% endif %}

        {% for p in range(max(1, pagination.page - 2), min(pagination.pages, pagination.page + 2) + 1) %}
          {% if p == pagination.page %}
            <span class="wc-pagination__link wc-pagination__link--current" aria-current="page">{{ p }}</span>
          {% else %}
            <a class="wc-pagination__link"
               href="{{ url_for('user.runs', page=p, sort=sort_value, direction=direction_value, per_page=per_page_value) }}">
              {{ p }}
            </a>
          {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
          <a class="wc-pagination__link"
             href="{{ url_for('user.runs', page=pagination.next_num, sort=sort_value, direction=direction_value, per_page=per_page_value) }}"
             aria-label="Next page">
            &raquo;
          </a>
        {% else %}
          <span class="wc-pagination__link" aria-hidden="true" aria-disabled="true">&raquo;</span>
        {% endif %}
      </nav>
    {% endif %}
  </section>
</section>

<script>
  const sitePrefix = {{ site_prefix | default('', true) | tojson }};
  const deleteButton = document.getElementById('delete_runs_button');
  const runsTable = document.getElementById('runs_table');

  async function deleteRun(runid) {
    const response = await fetch(`${sitePrefix}/runs/${runid}/0/tasks/delete/`, { method: 'POST' });
    if (response.ok) {
      const row = document.getElementById(runid);
      if (row) {
        row.remove();
      }
    } else {
      console.error('Failed to delete run', runid);
    }
  }

  function updateDeleteState() {
    const checked = runsTable.querySelectorAll('input[type="checkbox"]:checked');
    deleteButton.disabled = checked.length === 0;
  }

  function deleteRuns() {
    const checks = Array.from(runsTable.querySelectorAll('input[type="checkbox"]:checked'));
    if (!checks.length) {
      return;
    }
    const runids = checks.map((el) => el.value);
    const confirmed = window.confirm(`Delete ${runids.join(', ')}?`);
    if (!confirmed) {
      return;
    }
    runids.forEach(deleteRun);
  }

  if (!runsTable) {
    console.warn('Runs table not found; skipping selection logic.');
    if (deleteButton) {
      deleteButton.disabled = true;
    }
  } else {
    runsTable.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
      checkbox.addEventListener('change', updateDeleteState);
    });
    updateDeleteState();
  }
</script>
{% endblock %}

{% block script_extras %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/controllers.js') }}" defer></script>
{% endblock %}

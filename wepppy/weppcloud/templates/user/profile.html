{% extends "security/_layout.html"%}
{% from "security/_macros.html" import render_field_with_errors, render_checkbox_with_errors, render_field %}
{% block title %}
User Profile
{% endblock %}
{% block content %}
  {% set linked_accounts = user.oauth_accounts.all() %}
  {% set oauth_config = oauth_providers or {} %}
  <section class="wc-profile">
    <h2 class="wc-profile__heading">Account Details</h2>
    <dl class="wc-profile-details">
      <div class="wc-profile-details__row">
        <dt class="wc-profile-details__label">Name</dt>
        <dd class="wc-profile-details__value">
          {{ ((user.first_name or '') ~ ' ' ~ (user.last_name or ''))|trim or 'â€”' }}
        </dd>
      </div>
      <div class="wc-profile-details__row">
        <dt class="wc-profile-details__label">Email</dt>
        <dd class="wc-profile-details__value">{{ user.email }}</dd>
      </div>
      <div class="wc-profile-details__row">
        <dt class="wc-profile-details__label">Roles</dt>
        <dd class="wc-profile-details__value">
          {% set role_names = user.roles | map(attribute='name') | list %}
          {% if role_names %}
            {{ role_names | join(', ') }}
          {% else %}
            <span class="wc-profile-details__value--muted">None assigned</span>
          {% endif %}
        </dd>
      </div>
    </dl>

    <div class="wc-profile__actions">
      <a class="wc-profile__action" href="../change">Change Password</a>
    </div>

    <h3 class="wc-profile__subheading">Linked Providers</h3>
    {% if linked_accounts %}
      <ul class="wc-profile-providers">
        {% for account in linked_accounts|sort(attribute='provider') %}
          {% set provider_key = account.provider|lower %}
          {% set provider_cfg = oauth_config.get(provider_key) or oauth_config.get(account.provider) %}
          {% set provider_name = (provider_cfg.name if provider_cfg and provider_cfg.name else account.provider|capitalize) %}
          {% set is_github = provider_key == 'github' %}
          {% set is_google = provider_key == 'google' %}
          {% set is_orcid = provider_key == 'orcid' %}
          {% set icon %}
            {% if is_github %}
              <span class="wc-profile-providers__icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" focusable="false">
                  <path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M12 3.2C7.0275 3.2 3 7.2275 3 12.2C3 16.1825 5.57625 19.5463 9.15375 20.7388C9.60375 20.8175 9.7725 20.5475 9.7725 20.3113C9.7725 20.0975 9.76125 19.3888 9.76125 18.635C7.5 19.0513 6.915 18.0838 6.735 17.5775C6.63375 17.3188 6.195 16.52 5.8125 16.3063C5.4975 16.1375 5.0475 15.7213 5.80125 15.71C6.51 15.6988 7.01625 16.3625 7.185 16.6325C7.995 17.9938 9.28875 17.6113 9.80625 17.375C9.885 16.79 10.1213 16.3963 10.38 16.1713C8.3775 15.9463 6.285 15.17 6.285 11.7275C6.285 10.7488 6.63375 9.93875 7.2075 9.30875C7.1175 9.08375 6.8025 8.16125 7.2975 6.92375C7.2975 6.92375 8.05125 6.6875 9.7725 7.84625C10.4925 7.64375 11.2575 7.5425 12.0225 7.5425C12.7875 7.5425 13.5525 7.64375 14.2725 7.84625C15.9938 6.67625 16.7475 6.92375 16.7475 6.92375C17.2425 8.16125 16.9275 9.08375 16.8375 9.30875C17.4113 9.93875 17.76 10.7375 17.76 11.7275C17.76 15.1813 15.6563 15.9463 13.6538 16.1713C13.98 16.4525 14.2613 16.9925 14.2613 17.8363C14.2613 19.04 14.25 20.0075 14.25 20.3113C14.25 20.5475 14.4188 20.8288 14.8688 20.7388C18.4238 19.5463 21 16.1713 21 12.2C21 7.2275 16.9725 3.2 12 3.2Z"></path>
                </svg>
              </span>
            {% elif is_google %}
              <span class="wc-profile-providers__icon" aria-hidden="true">
                <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" focusable="false">
                  <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                  <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                  <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                  <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                  <path fill="none" d="M0 0h48v48H0z"/>
                </svg>
              </span>
            {% elif is_orcid %}
              <span class="wc-profile-providers__icon" aria-hidden="true">
                <svg width="32" height="32" fill="none" xmlns="http://www.w3.org/2000/svg" focusable="false">
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M32 16c0 8.837-7.163 16-16 16-8.838 0-16-7.163-16-16C0 7.162 7.162 0 16 0c8.837 0 16 7.162 16 16Z" fill="#A6CE39"/>
                  <path fill-rule="evenodd" clip-rule="evenodd" d="M18.813 9.637h-5.45v13.9h5.474c4.555 0 7.35-3.378 7.35-6.95 0-1.635-.562-3.372-1.77-4.704-1.215-1.336-3.065-2.246-5.605-2.246ZM18.6 21.3h-2.813v-9.425H18.5c1.823 0 3.12.552 3.96 1.4.842.849 1.252 2.021 1.252 3.312 0 .784-.239 1.967-.993 2.948-.745.969-2.01 1.765-4.119 1.765Zm5.311-4.026c-.251 1.74-1.494 4.276-5.311 4.276h-3.063H18.6c3.817 0 5.06-2.536 5.311-4.276Zm1.812-2.405c-.657-2.601-2.85-4.982-6.91-4.982h-5.2 5.2c4.06 0 6.253 2.38 6.91 4.982Zm.215 1.718ZM8.363 9.675v13.887h2.425V9.675H8.363Zm2.175 13.637H8.612h1.925ZM9.575 8.65c.84 0 1.513-.689 1.513-1.513 0-.823-.673-1.512-1.513-1.512-.838 0-1.512.674-1.512 1.513 0 .823.672 1.512 1.512 1.512Z" fill="#fff"/>
                </svg>
              </span>
            {% else %}
              <span class="wc-profile-providers__icon wc-profile-providers__icon--fallback" aria-hidden="true">
                <span class="wc-profile-providers__initials">{{ account.provider[:2]|upper }}</span>
              </span>
            {% endif %}
          {% endset %}
          <li class="wc-profile-providers__item">
            <div class="wc-profile-providers__meta">
              {{ icon|trim|safe }}
              <div class="wc-profile-providers__text">
                <span class="wc-profile-providers__name">{{ provider_name }}</span>
                {% if account.email and account.email != user.email %}
                  <span class="wc-profile-providers__email">{{ account.email }}</span>
                {% endif %}
              </div>
            </div>
            <form method="post"
                  action="{{ url_for('security_oauth.disconnect', provider=account.provider) }}"
                  class="wc-profile-providers__form">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="pure-button wc-profile-providers__button">
                Disconnect
              </button>
            </form>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="wc-profile-providers__empty">No social providers linked.</p>
    {% endif %}
  </section>

  {% if user.has_role('Dev') %}
  <section class="wc-profile-dev">
    <h3 class="wc-profile__subheading">Developer Settings</h3>
    <p>Modify PowerUser Role</p>
    <div class="wc-profile-dev__control">
      <input type="checkbox"
             name="usermod_PowerUser_{{ user.id }}"
             id="usermod_PowerUser_{{ user.id }}"
             {% if user.has_role('PowerUser') %}checked{% endif %}>
      <label class="form-check-label" for="usermod_PowerUser_{{ user.id }}">Is PowerUser</label>
    </div>
  </section>

<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script type="text/javascript">
$(document).ready(function() {
	$( "input[name^='usermod_']" ).change(function() {
	    var res = this.name.split("_");
	    console.log(res);
	    var user_id = parseInt(res[2], 10);
	    var role = res[1];
	    var role_state = this.checked;

	    $.post({
            url: "/tasks/usermod/",
            data: JSON.stringify({
                user_id: user_id,
                role: role,
                role_state: role_state
            }),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (response) {
                console.log(response)
            },
            fail: function (error) {
                console.log(error);
            }
        });
    });
});
</script>
  {% endif %}
{% endblock %}

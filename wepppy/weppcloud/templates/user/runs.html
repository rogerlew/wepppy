{% extends "base_pure.htm" %}

{% block title %}Runs{% endblock %}

{% block body %}
<section class="wc-stack">
  <header class="wc-stack">
    <h1>Runs</h1>
  </header>

  <div class="wc-table-wrapper">
    <table class="wc-table">
      <thead>
        <tr>
          {% if show_owner %}<th scope="col">Owner</th>{% endif %}
          <th scope="col">Project Name</th>
          <th scope="col">Scenario</th>
          <th scope="col">Run ID</th>
          <th scope="col">Config</th>
          <th scope="col">Location (What3Words)</th>
          <th scope="col">Link</th>
          <th scope="col">Creation Date</th>
          <th scope="col">Last Modified</th>
          <th scope="col">
            <button type="button" class="pure-button pure-button-secondary" onclick="delete_runs()">Delete</button>
          </th>
        </tr>
      </thead>
      <tbody>
        {% for meta in user_runs %}
        <tr id="{{ meta.runid }}">
          {% if show_owner %}<td>{{ meta.owner }}</td>{% endif %}
          <td>{{ meta.name }}</td>
          <td>{{ meta.scenario }}</td>
          <td>{{ meta.runid }}</td>
          <td>{{ meta.config }}</td>
          <td>{{ meta.w3w }}</td>
          <td>
            <a class="pure-button pure-button-secondary" href="{{ site_prefix }}/runs/{{ meta.runid }}/{{ meta.config }}/" target="_blank" rel="noopener">Open</a>
          </td>
          <td>{{ meta.date_created }}</td>
          <td>{{ meta.last_modified }}</td>
          <td>
            <input type="checkbox" value="{{ meta.runid }}" {% if meta.readonly %}disabled{% endif %}>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<script>
  async function delete_run(runid) {
    const response = await fetch(`/weppcloud/runs/${runid}/0/tasks/delete/`, { method: 'POST' });
    if (response.ok) {
      const row = document.getElementById(runid);
      if (row) {
        row.remove();
      }
    } else {
      console.error('Failed to delete run', runid);
    }
  }

  function delete_runs() {
    const checks = Array.from(document.querySelectorAll('input[type=checkbox]:checked'));
    if (!checks.length) {
      return;
    }
    const runids = checks.map((el) => el.value);
    const confirmed = window.confirm(`Delete ${runids.join(', ')}?`);
    if (!confirmed) {
      return;
    }
    runids.forEach(delete_run);
  }
</script>
{% endblock %}

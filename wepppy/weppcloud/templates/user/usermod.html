{% extends "base_pure.htm" %}

{% block title %}User Management{% endblock %}

{% block body_container_class %}wc-container wc-container--fluid{% endblock %}
{% block header_container_class %}wc-container wc-container--fluid{% endblock %}

{% block body %}
{% if user.has_role('Root') %}
<section class="wc-stack wc-table-page">
  <header class="wc-stack">
    <div class="wc-console-header">
      <div class="wc-console-header__primary">
        <h1 class="wc-heading__title">User Management</h1>
      </div>
    </div>
  </header>

  <section class="wc-panel wc-stack">
    <div class="wc-table-wrapper">
      <table class="wc-table wc-table--striped" id="allusers">
        <thead>
          <tr>
            <th scope="col">First Name</th>
            <th scope="col">Last Name</th>
            <th scope="col">Email</th>
            <th scope="col">Last Login</th>
            <th scope="col" class="wc-text-right">Login Count</th>
            <th scope="col">PowerUser</th>
            <th scope="col">Admin</th>
            <th scope="col">Dev</th>
            <th scope="col">Root</th>
          </tr>
        </thead>
        <tbody>
          {% for u in get_all_users() %}
          <tr>
            <td>{{ u.first_name if u.first_name else '—' }}</td>
            <td>{{ u.last_name if u.last_name else '—' }}</td>
            <td>{{ u.email }}</td>
            <td>{{ u.last_login_at.strftime('%Y-%m-%d %H:%M') if u.last_login_at else '—' }}</td>
            <td class="wc-text-right">{{ u.login_count if u.login_count else '—' }}</td>
            <td>
              <input type="checkbox" name="usermod_PowerUser_{{ u.id }}"
                     {% if u.has_role('PowerUser') %}checked{% endif %}
                     aria-label="PowerUser role for {{ u.email }}">
            </td>
            <td>
              <input type="checkbox" name="usermod_Admin_{{ u.id }}"
                     {% if u.has_role('Admin') %}checked{% endif %}
                     aria-label="Admin role for {{ u.email }}">
            </td>
            <td>
              <input type="checkbox" name="usermod_Dev_{{ u.id }}"
                     {% if u.has_role('Dev') %}checked{% endif %}
                     aria-label="Dev role for {{ u.email }}">
            </td>
            <td>
              <input type="checkbox" name="usermod_Root_{{ u.id }}"
                     {% if u.has_role('Root') %}checked{% endif %}
                     {% if current_user == u %}disabled{% endif %}
                     aria-label="Root role for {{ u.email }}">
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="9" class="wc-text-muted">No users found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</section>

<script type="module">
document.querySelectorAll('input[name^="usermod_"]').forEach(checkbox => {
  checkbox.addEventListener('change', async function() {
    const parts = this.name.split('_');
    const userId = parseInt(parts[2], 10);
    const role = parts[1];
    const roleState = this.checked;

    try {
      const response = await fetch('{{ url_for("admin.task_usermod") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          user_id: userId,
          role: role,
          role_state: roleState
        })
      });
      const data = await response.json();
      if (data.error) {
        console.error('Error:', data.error);
        this.checked = !this.checked; // Revert on error
      } else {
        console.log('Role updated:', data);
      }
    } catch (error) {
      console.error('Request failed:', error);
      this.checked = !this.checked; // Revert on error
    }
  });
});
</script>
{% else %}
<section class="wc-stack">
  <div class="wc-panel">
    <p class="wc-text-muted">You do not have permission to access this page.</p>
  </div>
</section>
{% endif %}
{% endblock %}


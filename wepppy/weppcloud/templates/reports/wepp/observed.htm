{% extends "reports/_base_report.htm" %}
{% block report_title %}Observed data model fit{% endblock %}
{% block report_content %}
{% macro render_stat(value) -%}
  {% if value in (None, '') %}
    &mdash;
  {% else %}
    {{ value | round(3) }}
  {% endif %}
{%- endmacro %}

<header class="wc-stack">
  <h1 class="wc-heading__title">Observed data model fit</h1>
  <p class="wc-text-muted">
    Model fit statistics comparing simulated outputs to the supplied observed time series.
    Use the plot and CSV links for detailed traces.
  </p>
</header>

{% if results is none %}
<div class="wc-panel wc-panel--warning wc-stack">
  <p class="wc-text-muted">
    <strong>Observed results unavailable:</strong> run the observed model fit to generate statistics.
  </p>
</div>
{% else %}
{% for timeperiod in ['Daily', 'Yearly'] %}
<section class="wc-panel wc-stack">
  <header class="wc-stack">
    <h2 class="wc-heading__subtitle">{{ timeperiod }} statistics</h2>
    <p class="wc-text-muted">
      Summary metrics for each modeled domain and measure at the {{ timeperiod|lower }} time scale.
    </p>
  </header>

  <div class="wc-table-wrapper wc-table-wrapper--compact">
    <table class="wc-table wc-table--dense wc-table--striped wc-table--compact">
      <thead>
        <tr>
          <th scope="col">Domain</th>
          <th scope="col">Measure</th>
          {% for stat_name in stat_names %}
          <th scope="col">{{ stat_name }}</th>
          {% endfor %}
          <th scope="col">Plot</th>
          <th scope="col">CSV</th>
        </tr>
      </thead>
      <tbody>
        {% for hill_or_chn in results %}
        {% set measure_total = results[hill_or_chn] | length %}
        {% for measure in results[hill_or_chn] %}
        <tr>
          {% if loop.first %}
          <th scope="rowgroup" rowspan="{{ measure_total }}">{{ hill_or_chn }}</th>
          {% endif %}
          <th scope="row">{{ measure }}</th>
          {% for stat_name in stat_names %}
          {% set stat_value = results[hill_or_chn][measure][timeperiod].get(stat_name) %}
          <td class="wc-table__num">{{ render_stat(stat_value) }}</td>
          {% endfor %}
          <td>
            <a class="pure-button pure-button-link"
               href="{{ url_for_run('observed.plot_observed', runid=runid, config=config, selected=hill_or_chn ~ '-' ~ (measure | replace(' ', '_')) ~ '-' ~ timeperiod) }}"
               target="_blank"
               rel="noopener">
              Plot
            </a>
          </td>
          <td>
            <a class="pure-button pure-button-link"
               href="{{ url_for_run('observed.resources_observed_data', runid=runid, config=config, file=hill_or_chn ~ '-' ~ (measure | replace(' ', '_')) ~ '-' ~ timeperiod ~ '.csv') }}">
              CSV
            </a>
          </td>
        </tr>
        {% endfor %}
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endfor %}
{% endif %}
{% endblock %}

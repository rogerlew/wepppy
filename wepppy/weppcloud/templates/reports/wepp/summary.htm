{% extends "reports/_base_report.htm" %}
{% block report_title %}Loss summary{% endblock %}
{% block report_content %}
{% macro render_scalar(value, units) -%}
  {% if value in (None, '') %}
    &mdash;
  {% elif units %}
    {{ unitizer(value, units) | safe }}
  {% elif value is number %}
    {{ '%.3f' | format(value | float) }}
  {% else %}
    {{ value }}
  {% endif %}
{%- endmacro %}

{% macro render_units(units) -%}
  {% if units %}
    {% if units == 'ratio' %}
      ratio
    {% else %}
      {{ unitizer_units(units) | safe }}
    {% endif %}
  {% else %}
    &nbsp;
  {% endif %}
{%- endmacro %}

{% macro render_table_value(value, units) -%}
  {% if value in (None, '') %}
    &mdash;
  {% elif units %}
    {{ unitizer(value, units) | safe }}
  {% else %}
    {{ value }}
  {% endif %}
{%- endmacro %}

{% set outlet_rows = out_rpt.rows(include_extraneous=extraneous) %}
{% set extraneous_value = 'true' if extraneous else 'false' %}
{% set extraneous_toggle_value = 'false' if extraneous else 'true' %}

<header class="wc-stack">
  <h1 class="wc-heading__title">Loss summary</h1>
  <p class="wc-text-muted">
    Aggregate outlet, hillslope, and channel metrics derived from the WEPP loss reports.
    {% if is_singlestorm %}
      Values reflect the current single-storm simulation.
    {% else %}
      Values represent average annual results over the simulated period.
    {% endif %}
  </p>
</header>

<div class="wc-inline">
  {% if extraneous %}
    <a class="pure-button pure-button-link"
       href="{{ url_for_run('wepp.report_wepp_loss', runid=runid, config=config, extraneous=extraneous_toggle_value) }}">
      Hide extraneous parameters
    </a>
  {% else %}
    <a class="pure-button pure-button-link"
       href="{{ url_for_run('wepp.report_wepp_loss', runid=runid, config=config, extraneous=extraneous_toggle_value) }}">
      Show extraneous parameters
    </a>
  {% endif %}
</div>

<section class="wc-panel wc-stack">
  <header class="wc-stack">
    <h2 class="wc-heading__subtitle">Outlet summary</h2>
    <p class="wc-text-muted">
      Watershed-scale delivery metrics at the channel outlet. Toggle extraneous parameters to include
      per-area derivatives derived from the interchange parquet exports.
    </p>
  </header>

  <div class="wc-table-wrapper wc-table-wrapper--compact">
    <table class="wc-table wc-table--dense wc-table--compact" id="outlet_summary_tbl">
      <thead>
        <tr>
          <th scope="col">Metric</th>
          <th scope="col">Value</th>
          <th scope="col">Value units</th>
          <th scope="col">Per unit area</th>
          <th scope="col">Per unit area units</th>
        </tr>
      </thead>
      <tbody>
        {% for row in outlet_rows %}
        <tr>
          <th scope="row">{{ row.label }}</th>
          <td>{{ render_scalar(row.value, row.units) }}</td>
          <td>{{ render_units(row.units) }}</td>
          <td>{{ render_scalar(row.per_area_value, row.per_area_units) }}</td>
          <td>{{ render_units(row.per_area_units) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="wc-table-actions">
    <button type="button" class="pure-button pure-button-link"
            data-report-csv="outlet_summary_tbl"
            data-report-url="{{ url_for_run('wepp.report_wepp_loss', runid=runid, config=config, format='csv', extraneous=extraneous_value) }}"
            data-report-table="outlet">
      Download CSV
    </button>
  </div>
</section>

<section class="wc-panel wc-stack">
  <header class="wc-stack">
    <h2 class="wc-heading__subtitle">Hillslope summary</h2>
    <p class="wc-text-muted">Per-hillslope metrics joined with landuse and soils metadata.</p>
  </header>

  <div class="wc-table-wrapper">
    <table class="wc-table wc-table--dense sortable" id="hill_summary_tbl">
      <thead>
        <tr>
          {% for name in hill_rpt.hdr %}
            <th scope="col">{{ name }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        <tr data-sort-position="top">
          {% for units in hill_rpt.units %}
            <td>{{ render_units(units) }}</td>
          {% endfor %}
        </tr>
        {% for row in hill_rpt %}
        <tr>
          {% for value, units in row %}
            <td sorttable_customkey="{{ '' if value in (None, '') else value }}">
              {{ render_table_value(value, units) }}
            </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="wc-table-actions">
    <button type="button" class="pure-button pure-button-link"
            data-report-csv="hill_summary_tbl"
            data-report-url="{{ url_for_run('wepp.report_wepp_loss', runid=runid, config=config, format='csv', extraneous=extraneous_value) }}"
            data-report-table="hillslopes">
      Download CSV
    </button>
  </div>
</section>

<section class="wc-panel wc-stack">
  <header class="wc-stack">
    <h2 class="wc-heading__subtitle">Channel summary</h2>
    <p class="wc-text-muted">Per-channel metrics derived from the loss report and watershed channel geometry.</p>
  </header>

  <div class="wc-table-wrapper">
    <table class="wc-table wc-table--dense sortable" id="channel_summary_tbl">
      <thead>
        <tr>
          {% for name in chn_rpt.hdr %}
            <th scope="col">{{ name }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        <tr data-sort-position="top">
          {% for units in chn_rpt.units %}
            <td>{{ render_units(units) }}</td>
          {% endfor %}
        </tr>
        {% for row in chn_rpt %}
        <tr>
          {% for value, units in row %}
            <td sorttable_customkey="{{ '' if value in (None, '') else value }}">
              {{ render_table_value(value, units) }}
            </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="wc-table-actions">
    <button type="button" class="pure-button pure-button-link"
            data-report-csv="channel_summary_tbl"
            data-report-url="{{ url_for_run('wepp.report_wepp_loss', runid=runid, config=config, format='csv', extraneous=extraneous_value) }}"
            data-report-table="channels">
      Download CSV
    </button>
  </div>
</section>
{% endblock %}

{% extends "layout.j2" %}

{% block content %}
<section class="mb-4">
    <h1 class="h3">Manage Batch Run</h1>
    <p class="text-muted">Phase 2 resource intake: upload GeoJSON, validate run-id templates, and monitor manifest state.</p>
</section>

{% if not feature_enabled %}
<div class="alert alert-warning" role="alert">
    Batch Runner is currently disabled. State is shown read-only for verification purposes.
</div>
{% endif %}

<section class="card mb-4" id="batch-runner-resource-card">
    <div class="card-body">
        <h2 class="h5 mb-3">Resource Intake</h2>
        <p class="text-muted">Upload the watershed GeoJSON driving batch expansion. Maximum size {{ geojson_limit_mb }}&nbsp;MB.</p>
        <form data-role="upload-form" class="row gy-2 gx-3 align-items-end" enctype="multipart/form-data">
            <div class="col-sm-8">
                <label class="form-label" for="batch-runner-geojson">GeoJSON file</label>
                <input type="file" class="form-control" id="batch-runner-geojson" name="geojson_file" accept=".geojson,.json" data-role="geojson-input" {% if not feature_enabled %}disabled{% endif %}>
            </div>
            <div class="col-sm-4 text-sm-end">
                <button type="submit" class="btn btn-primary mt-3 mt-sm-0" data-role="upload-button" {% if not feature_enabled %}disabled{% endif %}>Upload GeoJSON</button>
            </div>
        </form>
        <div class="small mt-3" data-role="upload-status"></div>

        <div class="mt-3" data-role="resource-empty">
            <div class="alert alert-info mb-0" role="alert">
                No GeoJSON resource uploaded yet. Upload a FeatureCollection to enable template validation.
            </div>
        </div>

        <div class="mt-3" data-role="resource-details" hidden>
            <h3 class="h6">Current Resource</h3>
            <dl class="row small" data-role="resource-meta"></dl>
        </div>
    </div>
</section>

<section class="card mb-4" id="batch-runner-template-card">
    <div class="card-body">
        <h2 class="h5 mb-3">Run ID Template</h2>
        <p class="text-muted">Expressions inside braces are evaluated with <code>properties</code>, <code>feature</code>, <code>index</code> (0-based), <code>one_based_index</code>, and helpers such as <code>slug()</code>, <code>lower()</code>, <code>upper()</code>, <code>title()</code>, <code>replace()</code>, and <code>zfill()</code>. Use double braces to emit literals.</p>
        <div class="mb-3">
            <label class="form-label" for="batch-runner-template-input">Template</label>
            <textarea class="form-control" id="batch-runner-template-input" rows="3" data-role="template-input" placeholder="e.g. {slug(properties['HucName'])}-{zfill(one_based_index, 3)}" {% if not feature_enabled %}disabled{% endif %}></textarea>
            <div class="form-text">Validate to preview run IDs and catch duplicate or missing values before orchestration.</div>
        </div>
        <div class="d-flex gap-2 mb-3 flex-wrap align-items-center">
            <button class="btn btn-outline-primary" type="button" data-role="validate-button" {% if not feature_enabled %}disabled{% endif %}>Validate Template</button>
            <div class="small" data-role="template-status"></div>
        </div>

        <div class="mb-3" data-role="validation-summary" hidden>
            <h3 class="h6">Validation Summary</h3>
            <ul class="list-unstyled small mb-0" data-role="validation-summary-list"></ul>
        </div>

        <div class="mb-3" data-role="validation-issues" hidden>
            <h3 class="h6">Issues</h3>
            <div class="alert alert-warning" data-role="validation-issues-list"></div>
        </div>

        <div data-role="validation-preview" hidden>
            <h3 class="h6">Preview</h3>
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Feature ID</th>
                            <th scope="col">Run ID</th>
                            <th scope="col">Error</th>
                        </tr>
                    </thead>
                    <tbody data-role="preview-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<section id="batch-runner-root" class="card">
    <div class="card-body">
        <h2 class="h5">Status</h2>
        <p class="mb-3">This view mirrors the creation page wiring and confirms that feature flags and manifest data are flowing correctly.</p>
        <dl class="row">
            <dt class="col-sm-3">Feature Enabled</dt>
            <dd class="col-sm-9"><span data-role="enabled-flag">{{ feature_enabled }}</span></dd>
            <dt class="col-sm-3">Batch Name</dt>
            <dd class="col-sm-9"><span data-role="batch-name">{{ batch_name or '—' }}</span></dd>
            <dt class="col-sm-3">Manifest Version</dt>
            <dd class="col-sm-9"><span data-role="manifest-version">{{ state_payload.get('state_version') }}</span></dd>
            <dt class="col-sm-3">Created By</dt>
            <dd class="col-sm-9"><span data-role="created-by">{{ state_payload.get('created_by') or '—' }}</span></dd>
        </dl>
        <details class="mt-3">
            <summary>Bootstrap Manifest</summary>
            <pre class="bg-light p-3" data-role="manifest-json">{{ state_payload | tojson(indent=2) }}</pre>
        </details>
    </div>
</section>
{% endblock %}

{% block scripts %}
{% include "manage_page_bootstrap.js.j2" %}
{% endblock %}

{% extends "controls/_base.htm" %}
{% block form_id %}batch_runner_form{% endblock %}
{% block form_title %}Manage Batch Run{% endblock %}
{% block inputs %}
<div id="batch-runner-root" class="batch-runner-panel">
<p class="text-muted small mb-3">Upload GeoJSON resources, validate run-id templates, and monitor batch progress.</p>

{% set base_runid = 'batch;;' ~ batch_name ~ ';;_base' %}
<section class="card card-body mb-4" id="batch-runner-base-card">
    <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-md-between">
        <div class="mb-3 mb-md-0">
            <h2 class="h6 mb-2">Base Project</h2>
            <p class="text-muted small mb-2">Open the shared `_base` project to adjust configuration defaults applied to every batch run.</p>
            <div class="small text-muted">Run ID: <code>{{ base_runid }}</code></div>
        </div>
        <a class="btn btn-outline-primary" role="button"
           href="{{ url_for('run_0.runs0', runid=base_runid, config=base_config) }}">
            Configure Base Project
        </a>
    </div>
</section>

{% if not feature_enabled %}
<div class="alert alert-warning" role="alert">
    Batch Runner is currently disabled. State is shown read-only for verification purposes.
</div>
{% endif %}

<section class="card card-body mb-4" id="batch-runner-resource-card">
    <h2 class="h6">Resource Intake</h2>
    <p class="text-muted small">Upload the watershed GeoJSON driving batch expansion. Maximum size {{ geojson_limit_mb }}&nbsp;MB.</p>
    <div data-role="upload-form" class="row gy-2 gx-3 align-items-end">
        <div class="col-sm-8">
            <label class="form-label" for="batch-runner-geojson">GeoJSON file</label>
            <input type="file" class="form-control" id="batch-runner-geojson" name="geojson_file"
                accept=".geojson,.json" data-role="geojson-input" {% if not feature_enabled %}disabled{% endif %}>
        </div>
        <div class="col-sm-4 text-sm-end">
            <button type="button" class="btn btn-primary mt-3 mt-sm-0" data-role="upload-button"
                onclick="return BatchRunner.getInstance().uploadGeojson(event);"
                {% if not feature_enabled %}disabled{% endif %}>Upload GeoJSON</button>
        </div>
    </div>
    <div class="small mt-3" data-role="upload-status"></div>

    <div class="mt-3" data-role="resource-empty">
        <div class="alert alert-info mb-0" role="alert">
            No GeoJSON resource uploaded yet. Upload a FeatureCollection to enable template validation.
        </div>
    </div>

    <div class="mt-3" data-role="resource-details" hidden>
        <h3 class="h6 mb-2">Current Resource</h3>
        <dl class="row small" data-role="resource-meta"></dl>
    </div>

    <div class="mt-3" data-role="resource-schema" hidden>
        <h3 class="h6 mb-2">Properties</h3>
        <div class="table-responsive">
            <table class="table table-sm mb-0">
                <thead>
                    <tr>
                        <th scope="col">Name</th>
                        <th scope="col">Type</th>
                    </tr>
                </thead>
                <tbody data-role="resource-schema-body"></tbody>
            </table>
        </div>
    </div>

    <div class="mt-3" data-role="resource-samples" hidden>
        <h3 class="h6 mb-2">Sample Features</h3>
        <div class="table-responsive">
            <table class="table table-sm mb-0">
                <thead>
                    <tr>
                        <th scope="col">Index</th>
                        <th scope="col">Properties</th>
                    </tr>
                </thead>
                <tbody data-role="resource-samples-body"></tbody>
            </table>
        </div>
    </div>
</section>

<section class="card card-body mb-4" id="batch-runner-template-card">
    <h2 class="h6">Run ID Template</h2>
    <p class="text-muted small mb-2">Expressions inside braces are evaluated with <code>properties</code>, <code>feature</code>, <code>index</code> (0-based),
        <code>one_based_index</code>, and a handful of helper functions. Use double braces to emit literals.</p>
    <ul class="text-muted small mb-3 pl-3">
        <li><code>slug(value)</code> – lowercase ASCII with spaces/punctuation replaced by dashes.</li>
        <li><code>lower(value)</code> / <code>upper(value)</code> – force to all lower- or upper-case.</li>
        <li><code>title(value)</code> – title-case words (first letter capitalized).</li>
        <li><code>replace(value, old, new)</code> – string replace helper.</li>
        <li><code>zfill(value, width)</code> – pad the value with leading zeroes to the given width.</li>
    </ul>
    <div class="mb-3">
        <label class="form-label" for="batch-runner-template-input">Template</label>
        <textarea class="form-control" id="batch-runner-template-input" rows="3" data-role="template-input"
            placeholder="e.g. {slug(properties['HucName'])}-{zfill(one_based_index, 3)}" {% if not feature_enabled %}disabled{% endif %}></textarea>
        <div class="form-text">Validate to preview run IDs and catch duplicate or missing values before orchestration.</div>
    </div>
    <div class="d-flex gap-2 mb-3 flex-wrap align-items-center">
        <button class="btn btn-outline-primary" type="button" data-role="validate-button"
            onclick="return BatchRunner.getInstance().validateTemplate(event);"
            {% if not feature_enabled %}disabled{% endif %}>Validate Template</button>
        <div class="small" data-role="template-status"></div>
    </div>

    <div class="mb-3" data-role="validation-summary" hidden>
        <h3 class="h6">Validation Summary</h3>
        <ul class="list-unstyled small mb-0" data-role="validation-summary-list"></ul>
    </div>

    <div class="mb-3" data-role="validation-issues" hidden>
        <h3 class="h6">Issues</h3>
        <div class="alert alert-warning" data-role="validation-issues-list"></div>
    </div>

    <div data-role="validation-preview" hidden>
        <h3 class="h6">Preview</h3>
        <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Feature ID</th>
                        <th scope="col">Run ID</th>
                        <th scope="col">Error</th>
                    </tr>
                </thead>
                <tbody data-role="preview-body"></tbody>
            </table>
        </div>
    </div>
</section>

<div class="form-group" id="batch_runner_directives_container">
    <label class="font-weight-bold small text-uppercase text-muted d-block mb-2">Batch Tasks</label>
    <div data-role="run-directive-list" class="d-flex flex-column"></div>
    <div class="small mt-2" data-role="run-directive-status"></div>
</div>

<div class="form-group row hide-readonly" id="batch_runner_run_container">
    <div class="col-sm-4">
        <button 
            onclick="BatchRunner.getInstance().runBatch();"
            id="btn_run_batch" class="btn btn-outline-success my-2 my-sm-0 col-sm-12" type="button">

          <img  id="run_batch_lock" style="display:none;" src="{{ url_for('static', filename='open-iconic/png/lock-locked-2x.png') }}" />
          Run Batch
        </button>
    </div>
    <div class="col-sm-5">
        <small id="hint_run_batch"></small>
    </div>
</div>
{% endblock %}

</div>

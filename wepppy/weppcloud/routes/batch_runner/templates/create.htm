{% extends "base_pure.htm" %}

{% block title %}Batch Runner â€“ Create Batch{% endblock %}

{% block head_extras %}
<script src="{{ url_for('static', filename='js/controllers.js') }}" defer></script>
{% endblock %}

{% from "shared/console_macros.htm" import console_page, console_header, button_row %}

{% set form_defaults = form_state if form_state is defined and form_state is not none else {} %}
{% set configs = available_configs if available_configs is defined and available_configs else [] %}

{% block body %}
{% call console_page(include_command_bar=True, classes="wc-console") %}
  {% call console_header(
    title="Create Batch",
    subtitle="Spin up a new batch workspace, then continue orchestration on the manage page.",
    run_target='_self',
    run_rel=None
  ) %}{% endcall %}

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <section class="wc-panel wc-stack">
        {% for category, message in messages %}
          {% set state = {
            'success': 'positive',
            'info': 'attention',
            'warning': 'attention',
            'danger': 'critical',
            'error': 'critical'
          }[category] if category in ['success', 'info', 'warning', 'danger', 'error'] else 'attention' %}
          <div class="wc-status" data-state="{{ state }}">{{ message }}</div>
        {% endfor %}
      </section>
    {% endif %}
  {% endwith %}

  {% if not feature_enabled %}
    <section class="wc-panel wc-stack">
      <div class="wc-status" data-state="attention">
        Batch Runner is currently disabled. Set <code>BATCH_RUNNER_ENABLED=1</code> in the deployment configuration to enable creation.
      </div>
    </section>
  {% endif %}

  {% if errors %}
    <section class="wc-panel wc-stack" aria-live="polite">
      <div class="wc-status" data-state="critical">
        <ul class="wc-stack" style="margin: 0;">
          {% for message in errors %}
            <li>{{ message }}</li>
          {% endfor %}
        </ul>
      </div>
    </section>
  {% endif %}

  <section class="wc-panel wc-stack">
    <form method="post" class="pure-form pure-form-stacked wc-stack" novalidate>
      <label for="batch_name">Batch name</label>
      <input
        id="batch_name"
        name="batch_name"
        type="text"
        class="pure-input-1"
        placeholder="e.g. forest_fires_2025"
        value="{{ form_defaults.get('batch_name', '') }}"
        {% if not feature_enabled %}disabled{% endif %}
        required
        minlength="3"
        pattern="[A-Za-z0-9_-]+"
      >
      <span class="pure-form-message-inline">3+ characters; letters, numbers, underscores, and hyphens only.</span>

      <label for="base_config">Configuration for `_base` project</label>
      <select
        id="base_config"
        name="base_config"
        class="pure-input-1"
        {% if not feature_enabled or not configs %}disabled{% endif %}
      >
        {% if configs %}
          {% for cfg in configs %}
            <option value="{{ cfg }}" {% if cfg == form_defaults.get('base_config') %}selected{% endif %}>{{ cfg }}</option>
          {% endfor %}
        {% else %}
          <option value="" selected disabled>No batch configurations available</option>
        {% endif %}
      </select>

      {% call button_row() %}
        <button
          type="submit"
          class="pure-button"
          {% if not feature_enabled or not configs %}disabled{% endif %}
        >Create batch</button>
      {% endcall %}
    </form>
  </section>
{% endcall %}
{% endblock %}

{% block script_extras %}
{% include "create_page_bootstrap.js.j2" %}
{% endblock %}

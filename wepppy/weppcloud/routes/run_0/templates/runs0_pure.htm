{% extends "base_pure.htm" %}

{% block title %}{{ ron.configname }}{% if ron.name %} - {{ ron.name }}{% endif %}{% endblock %}

{#
  Preflight TOC Navigation:
  - Emojis sourced from TaskEnum.emoji() in wepppy/nodb/redis_prep.py
  Visibility controlled by preflight checklist via WebSocket
  - See docs/ui-docs/control-ui-styling/preflight_behavior.md for architecture
#}

{% set mods_list = ron.mods or [] %}
{% set hide_landuse_wepp = 'rhem' in mods_list and not playwright_load_all %}

{% set disabled_controllers = ['landuse', 'landuseModify', 'wepp'] if hide_landuse_wepp else [] %}

{% set show_rangeland_cover = 'rangeland_cover' in mods_list or playwright_load_all %}
{% set show_rap_ts = 'rap_ts' in mods_list or playwright_load_all %}
{% set show_treatments = 'treatments' in mods_list or playwright_load_all %}
{% set show_ash = 'ash' in mods_list or playwright_load_all %}
{% set show_rhem = 'rhem' in mods_list or playwright_load_all %}
{% set show_omni = 'omni' in mods_list or playwright_load_all %}
{% set show_observed = 'observed' in mods_list or playwright_load_all %}
{% set allow_debris_flow = user.has_role('PowerUser') or (config is mapping and config.get('TEST_SUPPORT_ENABLED')) or playwright_load_all %}
{% set show_debris_flow = ('debris_flow' in mods_list or playwright_load_all) and (debris_flow is not none or playwright_load_all) and allow_debris_flow %}
{% set show_dss_export = 'dss_export' in mods_list or playwright_load_all %}
{% set show_disturbed_sbs = (('baer' in ron.mods or 'disturbed' in ron.mods) and 'lt' not in ron.mods) or playwright_load_all %}

{% block head_extras %}
{{ super() }}
<script src="{{ url_for('static', filename='vendor/jquery/jquery.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/leaflet/leaflet.js') }}"></script>
<script src="{{ url_for('static', filename='js/glify-browser.js') }}"></script>
<script src="{{ url_for('static', filename='js/leaflet-glify-layer.js') }}"></script>
<script src="{{ url_for('static', filename='js/controllers.js') }}"></script>
<script src="{{ url_for('static', filename='js/preflight.js') }}"></script>
<script src="{{ url_for('static', filename='js/flash-and-find-by-id.js') }}"></script>
<script src="{{ url_for('static', filename='js/input-unit-converters.js') }}"></script>

<link rel="stylesheet" href="{{ url_for('static', filename='vendor/leaflet/leaflet.css') }}">
{% include 'run_page_bootstrap.js.j2' %}
{% endblock %}

{% block site_header %}
  {% include 'header/_run_header_fixed.htm' %}
{% endblock %}

{% block body_container %}
{# Safari browser compatibility warning - Safari has known issues with WebSocket job status updates #}
<div id="safari-warning" class="wc-alert wc-alert--warning" role="alert" style="display: none; padding: 0.75rem 1rem; margin: 0.5rem 1rem; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; align-items: center; justify-content: space-between; gap: 1rem;">
  <span>
    <strong>⚠️ Browser Compatibility Notice:</strong>
    Safari may have issues displaying job status and completion messages due to WebSocket limitations.
    For the best experience, we recommend using <strong>Chrome</strong> or <strong>Firefox</strong>.
  </span>
  <button type="button" style="background: none; border: none; font-size: 1.25rem; cursor: pointer; padding: 0 0.5rem; line-height: 1;" onclick="this.parentElement.style.display='none'" aria-label="Dismiss">&times;</button>
</div>
<script>
(function() {
  // Detect Safari: includes Safari string but excludes Chrome/Chromium-based browsers
  var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  if (isSafari) {
    var warning = document.getElementById('safari-warning');
    if (warning) {
      warning.style.display = 'flex';
    }
  }
})();
</script>

{% include 'command-bar.htm' %}
{% include 'controls/poweruser_panel.htm' %}
{% include 'controls/unitizer_modal.htm' %}
{% include 'controls/team_modal.htm' %}

<div class="wc-container wc-container--fluid">
  <div class="wc-run-layout">
    <nav id="toc"
         class="wc-run-layout__toc wc-toc-with-emojis"
         aria-label="Run controls navigation">
      <h4>Preflight and Navigation</h4>
      <ul class="wc-toc-list">
        <li><a href="#map" class="nav-link">Map &amp; Analysis</a></li>
        {% if show_disturbed_sbs %}
        <li><a href="#disturbed-sbs" class="nav-link">Soil Burn Severity</a></li>
        {% endif %}
        <li><a href="#channel-delineation" class="nav-link">Channel Delineation</a></li>
        <li><a href="#set-outlet" class="nav-link">Outlet</a></li>
        <li><a href="#subcatchments-delineation" class="nav-link">Subcatchments Delineation</a></li>
        {% if show_rangeland_cover %}
        <li><a href="#rangeland-cover" class="nav-link">Rangeland Cover</a></li>
        {% endif %}
        {% if not hide_landuse_wepp %}
        <li><a href="#landuse" class="nav-link">Landuse</a></li>
        {% endif %}
        <li><a href="#soils" class="nav-link">Soils</a></li>
        <li><a href="#climate" class="nav-link">Climate</a></li>
        <li data-mod-nav="rap_ts" {% if not show_rap_ts %}hidden{% endif %}>
          <a href="#rap-ts" class="nav-link">RAP Time Series</a>
        </li>
        <li data-mod-nav="treatments" {% if not show_treatments %}hidden{% endif %}>
          <a href="#treatments" class="nav-link">Treatments</a>
        </li>
        {% if not hide_landuse_wepp %}
        <li><a href="#wepp" class="nav-link">WEPP</a></li>
        {% endif %}
        <li data-mod-nav="ash" {% if not show_ash %}hidden{% endif %}>
          <a href="#ash" class="nav-link">Ash Transport</a>
        </li>
        {% if show_rhem %}
        <li><a href="#rhem" class="nav-link">RHEM</a></li>
        {% endif %}
        <li data-mod-nav="omni" {% if not show_omni %}hidden{% endif %}>
          <a href="#omni-scenarios" class="nav-link">Omni Scenarios</a>
        </li>
        <li data-mod-nav="observed" {% if not show_observed %}hidden{% endif %}>
          <a href="#observed" class="nav-link">Observed Data</a>
        </li>
        {% set allow_debris_flow = user.has_role('PowerUser') or (config is mapping and config.get('TEST_SUPPORT_ENABLED')) or playwright_load_all %}
        {% if allow_debris_flow %}
        <li data-mod-nav="debris_flow" {% if not show_debris_flow %}hidden{% endif %}>
          <a href="#debris-flow" class="nav-link">Debris Flow</a>
        </li>
        {% endif %}
        <li data-mod-nav="dss_export" {% if not show_dss_export %}hidden{% endif %}>
          <a href="#dss-export" class="nav-link">DSS Export</a>
        </li>
        <li data-mod-nav="path_ce" {% if not show_path_ce %}hidden{% endif %}>
          <a href="#path-cost-effective" class="nav-link">PATH Cost-Effective</a>
        </li>
      </ul>
    </nav>

    <section class="wc-run-layout__content">
      <section id="map">
        {% include 'controls/map_pure.htm' %}
      </section>

      {% if show_disturbed_sbs %}
      <section id="disturbed-sbs" class="wc-stack">
        {% include 'controls/disturbed_sbs_pure.htm' %}
      </section>
      {% endif %}

      <section id="channel-delineation">
        {% include 'controls/channel_delineation_pure.htm' %}
      </section>

      <section id="set-outlet">
        {% include 'controls/set_outlet_pure.htm' %}
      </section>

      <section id="subcatchments-delineation">
        {% include 'controls/subcatchments_pure.htm' %}
      </section>

      {% if show_rangeland_cover %}
      <section id="rangeland-cover" class="wc-stack">
        {% include 'controls/rangeland_cover_pure.htm' %}
      </section>
      {% endif %}

      {% if not hide_landuse_wepp %}
      <section id="landuse" class="wc-stack">
        {% include 'controls/landuse_pure.htm' %}
      </section>
      {% endif %}

      <section id="soils" class="wc-stack">
        {% include 'controls/soil_pure.htm' %}
      </section>

      <section id="climate" class="wc-stack">
        {% include 'controls/climate_pure.htm' %}
      </section>

      <div data-mod-section="rap_ts" {% if not show_rap_ts %}hidden{% endif %}>
        {% if show_rap_ts %}
        <section id="rap-ts" class="wc-stack">
          {% include 'controls/rap_ts_pure.htm' %}
        </section>
        {% endif %}
      </div>

      <div data-mod-section="treatments" {% if not show_treatments %}hidden{% endif %}>
        {% if show_treatments %}
        <section id="treatments" class="wc-stack">
          {% include 'controls/treatments_pure.htm' %}
        </section>
        {% endif %}
      </div>

      {% if not hide_landuse_wepp %}
      <section id="wepp" class="wc-stack">
        {% include 'controls/wepp_pure.htm' %}
      </section>
      {% endif %}

      <div data-mod-section="ash" {% if not show_ash %}hidden{% endif %}>
        {% if show_ash %}
        <section id="ash" class="wc-stack">
          {% include 'controls/ash_pure.htm' %}
        </section>
        {% endif %}
      </div>

      {% if show_rhem %}
      <section id="rhem" class="wc-stack">
        {% include 'controls/rhem_pure.htm' %}
      </section>
      {% endif %}

      <div data-mod-section="omni" {% if not show_omni %}hidden{% endif %}>
        {% if show_omni %}
        <section id="omni-scenarios" class="wc-stack">
          {% include 'controls/omni_scenarios_pure.htm' %}
        </section>
        {% endif %}
      </div>

      <div data-mod-section="path_ce" {% if not show_path_ce %}hidden{% endif %}>
        {% if show_path_ce %}
        <section id="path-cost-effective" class="wc-stack">
          {% include 'controls/path_cost_effective_pure.htm' %}
        </section>
        {% endif %}
      </div>

      <div data-mod-section="observed" {% if not show_observed %}hidden{% endif %}>
        {% if show_observed %}
        <section id="observed" class="wc-stack">
          {% include 'controls/observed_pure.htm' %}
        </section>
        {% endif %}
      </div>

{% if allow_debris_flow %}
  <div data-mod-section="debris_flow" {% if not show_debris_flow %}hidden{% endif %}>
    {% if show_debris_flow %}
    <section id="debris-flow" class="wc-stack">
      {% include 'controls/debris_flow_pure.htm' %}
    </section>
    {% endif %}
  </div>
{% endif %}

      <div data-mod-section="dss_export" {% if not show_dss_export %}hidden{% endif %}>
        {% if show_dss_export %}
        <section id="dss-export" class="wc-stack">
          {% include 'controls/dss_export_pure.htm' %}
        </section>
        {% endif %}
      </div>

    </section>
  </div>
</div>
{% endblock %}

{% block script_extras %}
{{ super() }}
<script src="{{ url_for('static', filename='js/tinyqueue.js') }}"></script>
<script src="{{ url_for('static', filename='js/polylabel.js') }}"></script>
<script src="{{ url_for('static', filename='js/underscore.js') }}"></script>
<script src="{{ url_for('static', filename='js/colormap.js') }}"></script>
<script src="{{ url_for('static', filename='js/leaflet-geotiff.js') }}"></script>
<script src="{{ url_for('static', filename='js/geotiff.js') }}"></script>
<script src="{{ url_for('static', filename='js/plotty.js') }}"></script>
<script src="{{ url_for('static', filename='js/leaflet-ajax.js') }}"></script>
{% endblock %}

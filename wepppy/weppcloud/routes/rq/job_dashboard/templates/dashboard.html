<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Job Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
  <div class="container-fluid">
    <h1>Job Dashboard</h1>
    <div id="job-dashboard"></div>
  </div>

  <script>
  const jobId = "{{ job_id }}";
  let jobCount = 0;

  function fetchJobStatus() {
    $.ajax({
      url: `{{site_prefix}}/rq/jobinfo/${jobId}`,
      method: 'GET',
      success: function(data) {
        jobCount = 0;

        $('#job-dashboard').html(renderJob(data));

        if (data.success === False || data.status === "finished" || data.status === "failed") {
          return;
        }

        setTimeout(fetchJobStatus, jobCount * 50);
      },
      error: function(xhr, status, error) {
        let response = JSON.parse(xhr.responseText);
        if (response.StackTrace && response.StackTrace.some(line => line.includes('NoSuchJobError'))) {
          $('#job-dashboard').html('<div class="alert alert-danger">No such job found: ' + jobId + '</div>');
        } else {
          $('#job-dashboard').html('<div class="alert alert-danger">Error: ' + response.Error + '</div><pre>' + response.StackTrace.join('\n') + '</pre>');
        }
      }
    });
  }

  function renderJob(data) {
    let html = `<div class="card">
                  <div class="card-header">
                    <h5 class="mb-0">
                      <button class="btn btn-link" data-bs-toggle="collapse" data-bs-target="#collapseParent" aria-expanded="true" aria-controls="collapseParent">
                        ${data.description}
                      </button> - ${data.started_at}
                    </h5>
                  </div>
                  <div id="collapseParent" class="collapse show" aria-labelledby="headingParent" data-parent="#accordion">
                    <div class="card-body">
                      ${renderJobs(data.children)}
                    </div>
                  </div>
                </div>`;
    return html;
  }


  function renderJobs(jobs) {
    let html = '<div id="accordion">';

    for (let jobOrder in jobs) {
      if (jobs.hasOwnProperty(jobOrder)) {
        const isExpanded = $(`#collapse${jobOrder}`).hasClass('show');
        let finishedCount = 0;
        let totalCount = 0;

        jobs[jobOrder].forEach(job => {
          totalCount++;
          if (job.status === 'finished') {
            finishedCount++;
          }
        });

        let summary = `${finishedCount} of ${totalCount} jobs completed`;
        if (jobs[jobOrder].some(job => job.status === 'failed')) {
          summary = `Job ${jobOrder} failed`;
        }

        html += `<div class="card">
                   <div class="card-header" id="heading${jobOrder}">
                    <h5 class="mb-0 d-flex justify-content-between align-items-center">
                      <button class="btn btn-link p-0 m-0 text-decoration-none${isExpanded ? '' : ' collapsed'}" data-bs-toggle="collapse" data-bs-target="#collapse${jobOrder}" aria-expanded="${isExpanded}" aria-controls="collapse${jobOrder}">
                        <span class="text-dark">${jobOrder} - Job Order</span>
                      </button>
                      <span class="text-muted">Finished ${finishedCount} of ${totalCount}</span>
                    </h5>
                   </div>
                   <div id="collapse${jobOrder}" class="collapse${isExpanded ? ' show' : ''}" aria-labelledby="heading${jobOrder}" data-parent="#accordion">
                     <div class="card-body">
                       ${renderJobGroup(jobs[jobOrder])}
                     </div>
                   </div>
                 </div>`;
        jobCount += jobs[jobOrder].length;  // Accumulate job count
      }
    }
    html += '</div>';
    return html;
  }


  function renderJobGroup(jobGroup) {
    let html = '';
    jobGroup.forEach(job => {
      html += `<div class="row">
                 <div class="col-md-6">${job.description}</div>
                 <div class="col-md-2">${job.status}</div>
                 <div class="col-md-4">${job.started_at}</div>
               </div>`;
      if (job.status === 'failed') {
        html += `<div class="row">
                   <div class="col-md-12">
                     <div><pre>${job.exc_info}</pre></div>
                   </div>
                 </div>`;
      }
      if (job.children) {
        html += renderJobs(job.children);
      }
    });
    return html;
  }

    $(document).ready(function() {
      $(document).on('shown.bs.collapse', function() {
        const collapseElements = document.querySelectorAll('.collapse');
        collapseElements.forEach(element => {
          const collapseInstance = new bootstrap.Collapse(element, {
            toggle: false
          });
        });
      });

      fetchJobStatus();
    });
  </script>
</body>
</html>


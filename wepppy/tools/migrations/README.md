# Migration Scripts

Utilities for in-place standardization of legacy run assets. All scripts are executable via `python -m wepppy.tools.migrations.<module>`.

## Available scripts

- `migrate_watersheds_peridot_tables.py`
  - **Purpose:** upgrades watershed parquet outputs generated by Peridot abstractions so `topaz_id`/`wepp_id` identifiers are stored as nullable int32, removing legacy CSV duplicates when desired.
  - **Metrics:** logs run path, status, runtime (ms), and row counts for `hillslopes`, `channels`, and `flowpaths` tables to a configurable log file (`--log-file`).
  - **Common flags:**
    - `--root /wc1/runs` (default) root directory containing run workspaces
    - `--dry-run` preview targets & collect metrics without mutating files
    - `--keep-csv` retain original CSV artifacts after migration
    - `--contains substring` restrict processing to run paths containing the substring (repeatable)
    - `--limit N` cap number of runs inspected
    - `--verbose` emit per-run progress lines

- `migrate_wbt_geojson_ids.py`
  - **Purpose:** rewrites WhiteboxTools GeoJSON assets (`channels*.geojson`, `subcatchments*.geojson`) so `TopazID`/`WeppID` properties are numeric and `Order` (when present) is an integer.
  - **Metrics:** per-run log includes total/updated feature counts for each GeoJSON file and execution time in milliseconds.
  - **Common flags:** similar to the watershed script (`--root`, `--contains`, `--limit`, `--dry-run`, `--log-file`, `--verbose`).

- `migrate_landuse_parquet.py`
  - **Purpose:** normalizes `landuse/landuse.parquet` by ensuring `topaz_id`/`wepp_id` columns exist as nullable Int32 values and drops legacy uppercase variants.
  - **Metrics:** logs row counts, whether new identifiers were synthesized, and the number of null `wepp_id` entries.
  - **Common flags:** same pattern as the other scripts (`--root`, `--contains`, `--limit`, `--dry-run`, `--log-file`, `--verbose`).

- `migrate_soils_parquet.py`
  - **Purpose:** standardizes `soils/soils.parquet` with Int32 `topaz_id`/`wepp_id` columns and removes legacy casing.
  - **Metrics:** row counts plus null `wepp_id` tally to catch missing translator mappings.
  - **Common flags:** identical CLI surface (`--root`, `--contains`, `--limit`, `--dry-run`, `--log-file`, `--verbose`).

- `migrate_ashpost_pickles.py`
  - **Purpose:** re-runs AshPost when legacy `ash/post/*.pkl` artifacts are present, rebuilding parquet outputs and optionally removing the pickles.
  - **Metrics:** counts pickles, presence of raw ash parquet inputs, number of parquet outputs after migration, and runtime.
  - **Common flags:** `--root`, `--contains`, `--limit`, `--dry-run`, `--log-file`, `--verbose`, plus `--remove-pickles` to delete `.pkl` files after a successful run.

- `migrate_interchange.py`
  - **Purpose:** converts legacy WEPP text output files to Parquet format (interchange), enabling faster queries and modern analytics workflows.
  - **Behavior:** idempotent—skips runs that already have interchange files unless `--force` is specified. Generates hillslope interchange, watershed interchange (if outputs exist), totalwatsed3, and documentation.
  - **Common flags:** `run_dir` positional, `--force` to regenerate existing interchange.

- `migrate_observed_nodb.py`
  - **Purpose:** migrates legacy `observed.nodb` files from old module path (`wepppy.nodb.observed.Observed`) to the new path (`wepppy.nodb.mods.observed.observed.Observed`).
  - **Behavior:** creates a `.bak` backup before modifying. Skips files already migrated or with unknown `py/object` types.
  - **Common flags:** `run_dir` positional (path to run directory containing `observed.nodb`).

- `migrate_run_paths.py`
  - **Purpose:** migrates hardcoded paths in `.nodb` files from old server locations to new locations (e.g., `/geodata/wc1/` → `/wc1/`).
  - **Behavior:** recursively walks JSON structures to replace path prefixes. Creates `.bak` backups. Optionally clears Redis cache for the run after migration.
  - **Common flags:** `run_dir` positional, `--old-prefix` (default `/geodata/wc1`), `--new-prefix` (default `/wc1`), `--dry-run`, `--no-clear-cache`.
